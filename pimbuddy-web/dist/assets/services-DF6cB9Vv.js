var q=Object.defineProperty;var P=(f,e,t)=>e in f?q(f,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):f[e]=t;var T=(f,e,t)=>P(f,typeof e!="symbol"?e+"":e,t);import{P as E}from"./vendor-msal-_oisOUhb.js";import{a0 as S}from"./vendor-libs-DR0WLJdd.js";import{r as D,S as A}from"./utils-B68CIlTQ.js";function k(){const f=M();return f&&f.clientId&&f.tenantId?(console.log("Using bootstrapped app configuration"),{auth:{clientId:f.clientId,authority:`https://login.microsoftonline.com/${f.tenantId}`,redirectUri:window.location.origin,postLogoutRedirectUri:window.location.origin,navigateToLoginRequestUrl:!0},cache:{cacheLocation:"sessionStorage",storeAuthStateInCookie:!1},system:{loggerOptions:{logLevel:3,loggerCallback:(e,t,r)=>{if(!r)switch(e){case 0:console.error(t);break;case 1:console.warn(t);break;case 2:console.info(t);break;case 3:console.debug(t);break}}}}}):(console.log("No saved config found - will need to bootstrap or configure manually"),null)}function M(){const f=localStorage.getItem("pimbuddy-app-config");if(f)try{return JSON.parse(f)}catch{return null}return null}function x(){const f=M();return f&&f.clientId&&f.tenantId}function O(){localStorage.removeItem("pimbuddy-app-config")}const I={user:["User.Read"],groups:["Group.Read.All","Group.ReadWrite.All"],pimGroups:["PrivilegedAccess.Read.AzureADGroup","PrivilegedAccess.ReadWrite.AzureADGroup","PrivilegedEligibilitySchedule.Read.AzureADGroup","PrivilegedEligibilitySchedule.ReadWrite.AzureADGroup","PrivilegedAssignmentSchedule.Read.AzureADGroup","PrivilegedAssignmentSchedule.ReadWrite.AzureADGroup"],roles:["RoleManagement.Read.Directory","RoleManagement.ReadWrite.Directory"],all:["User.Read","Group.Read.All","Group.ReadWrite.All","RoleManagement.Read.Directory","RoleManagement.ReadWrite.Directory","PrivilegedAccess.Read.AzureADGroup","PrivilegedAccess.ReadWrite.AzureADGroup","PrivilegedEligibilitySchedule.Read.AzureADGroup","PrivilegedEligibilitySchedule.ReadWrite.AzureADGroup","PrivilegedAssignmentSchedule.Read.AzureADGroup","PrivilegedAssignmentSchedule.ReadWrite.AzureADGroup"]};class C{constructor(){this.msalInstance=null,this.account=null,this.initialized=!1}isConfigured(){return x()}async initialize(){if(this.initialized)return!0;const e=k();if(!e)return console.log("MSAL not configured - bootstrap required"),!1;try{this.msalInstance=new E(e),await this.msalInstance.initialize();const t=await this.msalInstance.handleRedirectPromise();if(t)this.account=t.account;else{const r=this.msalInstance.getAllAccounts();r.length>0&&(this.account=r[0])}return this.initialized=!0,console.log("MSAL initialized successfully"),!0}catch(t){throw console.error("MSAL initialization failed:",t),t}}async reinitialize(){return this.msalInstance=null,this.account=null,this.initialized=!1,await this.initialize()}isAuthenticated(){return this.account!==null}getAccount(){return this.account}async login(){if(!this.msalInstance)return{success:!1,error:"App not configured. Please run setup first."};try{const e=await this.msalInstance.loginPopup({scopes:I.all,prompt:"select_account"});return this.account=e.account,{success:!0,account:this.account}}catch(e){return console.error("Login failed:",e),{success:!1,error:this.getFriendlyError(e)}}}async loginRedirect(){if(!this.msalInstance)throw new Error("App not configured");try{await this.msalInstance.loginRedirect({scopes:I.all})}catch(e){throw console.error("Login redirect failed:",e),e}}async logout(){if(!this.msalInstance)return this.account=null,{success:!0};try{return await this.msalInstance.logoutPopup({account:this.account,postLogoutRedirectUri:window.location.origin}),this.account=null,{success:!0}}catch(e){return console.error("Logout failed:",e),{success:!1,error:this.getFriendlyError(e)}}}async getAccessToken(e=I.all){if(!this.account)throw new Error("No account found. Please login first.");const t={scopes:e,account:this.account};try{return(await this.msalInstance.acquireTokenSilent(t)).accessToken}catch(r){if(r instanceof S)try{return(await this.msalInstance.acquireTokenPopup(t)).accessToken}catch(i){throw console.error("Token acquisition failed:",i),i}throw r}}getFriendlyError(e){const t=e.message||e.toString();return t.includes("user_cancelled")?"Login was cancelled.":t.includes("consent_required")?"Admin consent is required for this application.":t.includes("interaction_required")?"Please sign in again.":t.includes("invalid_client")?"Application configuration error. Please check client ID.":t.includes("unauthorized_client")?"This application is not authorized in your tenant.":t.includes("AADSTS700016")?"Application not found. You may need to run setup again.":t}}const U=new C,b=class b{constructor(){this.baseUrl="https://graph.microsoft.com/v1.0",this.betaUrl="https://graph.microsoft.com/beta"}async request(e,t={}){const i=(t.method||"GET")==="GET"?e.includes("$filter")||e.includes("$search")?"search":"default":"mutation";if(!D.isAllowed(e,i)){const n=D.getResetTime(e,i),c=new Error(`Rate limit exceeded. Try again in ${n} seconds.`);throw c.code="RATE_LIMIT_EXCEEDED",c.resetTime=n,c}const o={Authorization:`Bearer ${await U.getAccessToken()}`,"Content-Type":"application/json"},s=await fetch(e,{...t,headers:{...o,...t.headers}});if(!s.ok){const n=await s.json().catch(()=>({})),c=new Error(n.error?.message||`HTTP ${s.status}`);throw c.status=s.status,c.code=n.error?.code,c}return s.status===204?null:s.json()}async get(e){return this.request(e,{method:"GET"})}async getWithCustomHeaders(e,t={}){return this.request(e,{method:"GET",headers:t})}async post(e,t){return this.request(e,{method:"POST",body:JSON.stringify(t)})}async patch(e,t){return this.request(e,{method:"PATCH",body:JSON.stringify(t)})}async delete(e){return this.request(e,{method:"DELETE"})}async batch(e){if(!e||e.length===0)return{};const r=this.chunkArray(e,20),i={};for(const a of r)try{const o={requests:a.map((n,c)=>({id:n.id||`${c}`,method:n.method||"GET",url:n.url,headers:n.headers||{}}))},s=await this.post(`${this.baseUrl}/$batch`,o);s&&s.responses&&s.responses.forEach(n=>{i[n.id]={status:n.status,body:n.body}})}catch(o){console.error("Batch request failed:",o),a.forEach(s=>{i[s.id]={status:500,body:{error:{message:o.message}}}})}return i}chunkArray(e,t){const r=[];for(let i=0;i<e.length;i+=t)r.push(e.slice(i,i+t));return r}async getMe(){return this.get(`${this.baseUrl}/me`)}async getPIMGroups(){try{const t=(await this.get(`${this.baseUrl}/groups?$filter=isAssignableToRole eq true&$select=id,displayName,description,createdDateTime,mailNickname`)).value||[];if(t.length===0)return{success:!0,groups:[],count:0};const r=[];t.forEach((o,s)=>{r.push({id:`${s}-members`,method:"GET",url:`/groups/${o.id}/members/$count`,headers:{ConsistencyLevel:"eventual"}}),r.push({id:`${s}-owners`,method:"GET",url:`/groups/${o.id}/owners/$count`,headers:{ConsistencyLevel:"eventual"}})});const i=await this.batch(r),a=t.map((o,s)=>{const n=i[`${s}-members`],c=i[`${s}-owners`],l=n?.status===200&&typeof n.body=="number"?n.body:0,u=c?.status===200&&typeof c.body=="number"?c.body:0;return{...o,memberCount:l,ownerCount:u}});return{success:!0,groups:a,count:a.length}}catch(e){return console.error("Failed to fetch PIM groups:",e),{success:!1,error:this.getFriendlyError(e),groups:[]}}}async getGroupsPage(e=1,t=50){try{const r=(e-1)*t,i=await this.getWithCustomHeaders(`${this.baseUrl}/groups?$filter=isAssignableToRole eq true&$select=id,displayName,description,createdDateTime,mailNickname&$top=${t}&$skip=${r}&$count=true`,{ConsistencyLevel:"eventual"}),a=i.value||[],o=i["@odata.count"]||0;if(a.length===0)return{success:!0,items:[],totalCount:0,pageNumber:e,pageSize:t,totalPages:0};const s=[];a.forEach((l,u)=>{s.push({id:`${u}-members`,method:"GET",url:`/groups/${l.id}/members/$count`,headers:{ConsistencyLevel:"eventual"}}),s.push({id:`${u}-owners`,method:"GET",url:`/groups/${l.id}/owners/$count`,headers:{ConsistencyLevel:"eventual"}})});const n=await this.batch(s);return{success:!0,items:a.map((l,u)=>{const p=n[`${u}-members`],d=n[`${u}-owners`],m=p?.status===200&&typeof p.body=="number"?p.body:0,y=d?.status===200&&typeof d.body=="number"?d.body:0;return{...l,memberCount:m,ownerCount:y}}),totalCount:o,pageNumber:e,pageSize:t,totalPages:Math.ceil(o/t)}}catch(r){return console.error("Failed to fetch groups page:",r),{success:!1,error:this.getFriendlyError(r),items:[],totalCount:0,pageNumber:e,pageSize:t,totalPages:0}}}async createPIMGroup(e,t,r){try{return{success:!0,group:await this.post(`${this.baseUrl}/groups`,{displayName:e,description:t,mailNickname:r||e.replace(/[^a-zA-Z0-9]/g,""),mailEnabled:!1,securityEnabled:!0,isAssignableToRole:!0,groupTypes:[]})}}catch(i){return console.error("Failed to create group:",i),{success:!1,error:this.getFriendlyError(i)}}}async deleteGroup(e){try{return await this.delete(`${this.baseUrl}/groups/${e}`),{success:!0}}catch(t){return{success:!1,error:this.getFriendlyError(t)}}}async getGroupMembers(e){try{return{success:!0,members:(await this.get(`${this.baseUrl}/groups/${e}/members?$select=id,displayName,userPrincipalName,mail`)).value||[]}}catch(t){return{success:!1,error:this.getFriendlyError(t),members:[]}}}async addGroupMember(e,t){try{return await this.post(`${this.baseUrl}/groups/${e}/members/$ref`,{"@odata.id":`https://graph.microsoft.com/v1.0/directoryObjects/${t}`}),{success:!0}}catch(r){return{success:!1,error:this.getFriendlyError(r)}}}async removeGroupMember(e,t){try{return await this.delete(`${this.baseUrl}/groups/${e}/members/${t}/$ref`),{success:!0}}catch(r){return{success:!1,error:this.getFriendlyError(r)}}}async getGroupPolicy(e,t="member"){try{const r=await this.get(`${this.baseUrl}/policies/roleManagementPolicyAssignments?$filter=scopeId eq '${e}' and scopeType eq 'Group' and roleDefinitionId eq '${t}'`);if(!r.value||r.value.length===0)return{success:!1,error:"No PIM policy found for this group",isDefault:!0};const a=r.value[0].policyId,s=(await this.get(`${this.baseUrl}/policies/roleManagementPolicies/${a}/rules`)).value||[],n=this.parseRulesToSettings(s);return{success:!0,policyId:a,settings:n,rawRules:s}}catch(r){return r.status===403&&r.message?.includes("RoleManagementPolicy")?{success:!1,error:"PIM for Groups not configured (requires additional permissions)",requiresPermissions:!0,missingPermissions:["RoleManagementPolicy.Read.AzureADGroup"]}:(console.error("Failed to get group policy:",r),{success:!1,error:this.getFriendlyError(r)})}}async updateGroupPolicy(e,t,r){try{const i=await this.getGroupPolicy(e,t);if(!i.success)return i;const{policyId:a,rawRules:o}=i,s=[];for(const n of o){const c=n["@odata.type"],l=n.id;if(c==="#microsoft.graph.unifiedRoleManagementPolicyExpirationRule"&&n.target?.caller==="EndUser"&&r.maximumDurationHours!==void 0&&s.push(this.patch(`${this.betaUrl}/policies/roleManagementPolicies/${a}/rules/${l}`,{"@odata.type":c,id:l,isExpirationRequired:!0,maximumDuration:`PT${r.maximumDurationHours}H`,target:n.target})),c==="#microsoft.graph.unifiedRoleManagementPolicyEnablementRule"&&n.target?.caller==="EndUser"){const u=[];r.requireMfa&&u.push("MultiFactorAuthentication"),r.requireJustification&&u.push("Justification"),r.requireTicketInfo&&u.push("Ticketing"),s.push(this.patch(`${this.betaUrl}/policies/roleManagementPolicies/${a}/rules/${l}`,{"@odata.type":c,id:l,enabledRules:u,target:n.target}))}c==="#microsoft.graph.unifiedRoleManagementPolicyApprovalRule"&&r.requireApproval!==void 0&&s.push(this.patch(`${this.betaUrl}/policies/roleManagementPolicies/${a}/rules/${l}`,{"@odata.type":c,id:l,setting:{isApprovalRequired:r.requireApproval,isApprovalRequiredForExtension:!1,isRequestorJustificationRequired:!0,approvalMode:"SingleStage",approvalStages:r.approverIds&&r.approverIds.length>0?[{approvalStageTimeOutInDays:1,isApproverJustificationRequired:!0,escalationTimeInMinutes:0,isEscalationEnabled:!1,primaryApprovers:r.approverIds.map(u=>({"@odata.type":"#microsoft.graph.singleUser",userId:u}))}]:[]},target:n.target}))}return await Promise.all(s),{success:!0,updatedRules:s.length}}catch(i){return console.error("Failed to update group policy:",i),{success:!1,error:this.getFriendlyError(i)}}}parseRulesToSettings(e){const t={activation:{maximumDurationHours:8,requireMfa:!0,requireJustification:!0,requireTicketInfo:!1,requireApproval:!1,approvers:[]},eligibleAssignment:{allowPermanent:!0,maximumDurationDays:365},activeAssignment:{allowPermanent:!1,maximumDurationDays:30,requireMfa:!0,requireJustification:!0}};for(const r of e){const i=r["@odata.type"],a=r.target||{};if(i==="#microsoft.graph.unifiedRoleManagementPolicyExpirationRule"){const o=r.maximumDuration||"PT8H",s=this.parseIsoDuration(o);a.caller==="EndUser"?t.activation.maximumDurationHours=s:a.caller==="Admin"&&a.level==="Eligibility"?(t.eligibleAssignment.allowPermanent=!r.isExpirationRequired,t.eligibleAssignment.maximumDurationDays=this.parseIsoDurationDays(o)):a.caller==="Admin"&&a.level==="Assignment"&&(t.activeAssignment.allowPermanent=!r.isExpirationRequired,t.activeAssignment.maximumDurationDays=this.parseIsoDurationDays(o))}if(i==="#microsoft.graph.unifiedRoleManagementPolicyEnablementRule"){const o=r.enabledRules||[];a.caller==="EndUser"&&(t.activation.requireMfa=o.includes("MultiFactorAuthentication"),t.activation.requireJustification=o.includes("Justification"),t.activation.requireTicketInfo=o.includes("Ticketing"))}if(i==="#microsoft.graph.unifiedRoleManagementPolicyApprovalRule"){const o=r.setting||{};t.activation.requireApproval=o.isApprovalRequired||!1,o.approvalStages?.[0]?.primaryApprovers&&(t.activation.approvers=o.approvalStages[0].primaryApprovers.filter(s=>s.userId).map(s=>s.userId))}}return t}parseIsoDuration(e){const t=e.match(/PT(\d+)H/);return t?parseInt(t[1]):8}parseIsoDurationDays(e){const t=e.match(/P(\d+)D/);if(t)return parseInt(t[1]);const r=e.match(/PT(\d+)H/);return r?Math.ceil(parseInt(r[1])/24):365}getRolePrivilegeLevel(e){return b.PRIVILEGE_LEVELS.critical.includes(e)?"critical":b.PRIVILEGE_LEVELS.high.includes(e)?"high":b.PRIVILEGE_LEVELS.medium.includes(e)?"medium":"low"}async getRoleDefinitions(){try{return{success:!0,roles:((await this.get(`${this.baseUrl}/roleManagement/directory/roleDefinitions?$select=id,displayName,description,isBuiltIn,templateId`)).value||[]).map(r=>({...r,privilegeLevel:this.getRolePrivilegeLevel(r.templateId||r.id)}))}}catch(e){return{success:!1,error:this.getFriendlyError(e),roles:[]}}}async getRolesPage(e=1,t=50){try{const r=(e-1)*t,i=await this.getWithCustomHeaders(`${this.baseUrl}/roleManagement/directory/roleDefinitions?$select=id,displayName,description,isBuiltIn,templateId&$top=${t}&$skip=${r}&$count=true`,{ConsistencyLevel:"eventual"}),a=i["@odata.count"]||0;return{success:!0,items:(i.value||[]).map(s=>({...s,privilegeLevel:this.getRolePrivilegeLevel(s.templateId||s.id)})),totalCount:a,pageNumber:e,pageSize:t,totalPages:Math.ceil(a/t)}}catch(r){return{success:!1,error:this.getFriendlyError(r),items:[],totalCount:0,pageNumber:e,pageSize:t,totalPages:0}}}async getRolePolicy(e){try{const t=await this.get(`${this.baseUrl}/policies/roleManagementPolicyAssignments?$filter=scopeId eq '/' and scopeType eq 'DirectoryRole' and roleDefinitionId eq '${e}'`);if(!t.value||t.value.length===0)return{success:!1,error:"No policy found for this role"};const i=t.value[0].policyId,o=(await this.get(`${this.baseUrl}/policies/roleManagementPolicies/${i}/rules`)).value||[],s=this.parseRulesToSettings(o);return{success:!0,policyId:i,settings:s,rawRules:o}}catch(t){return{success:!1,error:this.getFriendlyError(t)}}}async getUserIdsByEmails(e){if(!e||e.length===0)return[];try{const t=[];for(const r of e)try{const i=await this.get(`${this.baseUrl}/users/${encodeURIComponent(r)}?$select=id`);t.push(i.id)}catch(i){console.warn(`Failed to find user ID for ${r}:`,i.message)}return t}catch(t){return console.error("Failed to convert emails to user IDs:",t),[]}}async updateRolePolicy(e,t){try{const r=await this.getRolePolicy(e);if(!r.success)return r;const{policyId:i,rawRules:a}=r,o=[];if(t.approvers&&t.approvers.length>0&&(t.approverIds=await this.getUserIdsByEmails(t.approvers),t.approverIds.length===0))return{success:!1,error:"Could not find any of the specified approvers. Please check the email addresses."};for(const s of a){const n=s["@odata.type"],c=s.id;if(n==="#microsoft.graph.unifiedRoleManagementPolicyExpirationRule"&&s.target?.caller==="EndUser"&&t.maximumDurationHours!==void 0&&o.push(this.patch(`${this.betaUrl}/policies/roleManagementPolicies/${i}/rules/${c}`,{"@odata.type":n,id:c,isExpirationRequired:!0,maximumDuration:`PT${t.maximumDurationHours}H`,target:s.target})),n==="#microsoft.graph.unifiedRoleManagementPolicyEnablementRule"&&s.target?.caller==="EndUser"){const l=[];t.requireMfa&&l.push("MultiFactorAuthentication"),t.requireJustification&&l.push("Justification"),t.requireTicketInfo&&l.push("Ticketing"),o.push(this.patch(`${this.betaUrl}/policies/roleManagementPolicies/${i}/rules/${c}`,{"@odata.type":n,id:c,enabledRules:l,target:s.target}))}n==="#microsoft.graph.unifiedRoleManagementPolicyApprovalRule"&&t.requireApproval!==void 0&&o.push(this.patch(`${this.betaUrl}/policies/roleManagementPolicies/${i}/rules/${c}`,{"@odata.type":n,id:c,setting:{isApprovalRequired:t.requireApproval,isApprovalRequiredForExtension:!1,isRequestorJustificationRequired:!0,approvalMode:"SingleStage",approvalStages:t.approverIds&&t.approverIds.length>0?[{approvalStageTimeOutInDays:1,isApproverJustificationRequired:!0,escalationTimeInMinutes:0,isEscalationEnabled:!1,primaryApprovers:t.approverIds.map(l=>({"@odata.type":"#microsoft.graph.singleUser",userId:l}))}]:[]},target:s.target}))}return await Promise.all(o),{success:!0,updatedRules:o.length}}catch(r){return console.error("Failed to update role policy:",r),{success:!1,error:this.getFriendlyError(r)}}}async getGroupEligibleAssignments(e){try{return{success:!0,assignments:(await this.get(`${this.baseUrl}/identityGovernance/privilegedAccess/group/eligibilityScheduleInstances?$filter=groupId eq '${e}'&$expand=principal`)).value||[]}}catch(t){return{success:!1,error:this.getFriendlyError(t),assignments:[]}}}async getGroupActiveAssignments(e){try{return{success:!0,assignments:(await this.get(`${this.baseUrl}/identityGovernance/privilegedAccess/group/assignmentScheduleInstances?$filter=groupId eq '${e}'&$expand=principal`)).value||[]}}catch(t){return{success:!1,error:this.getFriendlyError(t),assignments:[]}}}async getAllGroupAssignments(e){const t={};for(const r of e)try{const[i,a]=await Promise.all([this.getGroupEligibleAssignments(r.id),this.getGroupActiveAssignments(r.id)]),o=(i.assignments||[]).filter(n=>n.principalId).map(n=>({id:n.principalId,displayName:n.principal?.displayName||"Unknown User",accessId:n.accessId})),s=(a.assignments||[]).filter(n=>n.principalId).map(n=>({id:n.principalId,displayName:n.principal?.displayName||"Unknown User",accessId:n.accessId}));(o.length>0||s.length>0)&&(t[r.id]={eligible:o,active:s})}catch(i){console.warn(`Failed to get assignments for group ${r.id}:`,i)}return{success:!0,assignments:t}}async getRoleEligibilityAssignments(){try{return{success:!0,assignments:(await this.get(`${this.baseUrl}/roleManagement/directory/roleEligibilityScheduleInstances?$expand=principal`)).value||[]}}catch(e){return{success:!1,error:this.getFriendlyError(e),assignments:[]}}}async getRoleActiveAssignments(){try{return{success:!0,assignments:(await this.get(`${this.baseUrl}/roleManagement/directory/roleAssignmentScheduleInstances?$expand=principal`)).value||[]}}catch(e){return{success:!1,error:this.getFriendlyError(e),assignments:[]}}}async getAllRoleAssignments(){try{const[e,t]=await Promise.all([this.getRoleEligibilityAssignments(),this.getRoleActiveAssignments()]),r={};for(const i of e.assignments||[]){const a=i.roleDefinitionId;r[a]||(r[a]=[]),r[a].push({principalId:i.principalId,principalDisplayName:i.principal?.displayName||"Unknown",principalType:i.principal?.["@odata.type"]?.includes("group")?"Group":"User",assignmentType:"Eligible",startDateTime:i.startDateTime,endDateTime:i.endDateTime})}for(const i of t.assignments||[]){const a=i.roleDefinitionId;r[a]||(r[a]=[]),r[a].push({principalId:i.principalId,principalDisplayName:i.principal?.displayName||"Unknown",principalType:i.principal?.["@odata.type"]?.includes("group")?"Group":"User",assignmentType:"Active",startDateTime:i.startDateTime,endDateTime:i.endDateTime})}return{success:!0,assignments:r}}catch(e){return{success:!1,error:this.getFriendlyError(e),assignments:{}}}}async createEligibleAssignment(e,t,r,i,a){try{const o={accessId:r,principalId:t,groupId:e,action:"adminAssign",scheduleInfo:{startDateTime:i||new Date().toISOString(),expiration:a?{type:"afterDateTime",endDateTime:a}:{type:"noExpiration"}}};return{success:!0,assignment:await this.post(`${this.baseUrl}/identityGovernance/privilegedAccess/group/eligibilityScheduleRequests`,o)}}catch(o){return{success:!1,error:this.getFriendlyError(o)}}}async createDirectoryRoleEligibilityAssignment(e,t,r="Baseline deployment",i=12){try{const a=new Date,o=new Date;o.setMonth(o.getMonth()+i);const s={action:"adminAssign",justification:r,roleDefinitionId:t,directoryScopeId:"/",principalId:e,scheduleInfo:{startDateTime:a.toISOString(),expiration:{type:"afterDateTime",endDateTime:o.toISOString()}}};return{success:!0,assignment:await this.post(`${this.baseUrl}/roleManagement/directory/roleEligibilityScheduleRequests`,s)}}catch(a){return console.error("Failed to create role eligibility assignment:",a),{success:!1,error:this.getFriendlyError(a)}}}async createDirectoryRoleActiveAssignment(e,t,r="Baseline deployment - Active assignment"){try{const a={action:"adminAssign",justification:r,roleDefinitionId:t,directoryScopeId:"/",principalId:e,scheduleInfo:{startDateTime:new Date().toISOString(),expiration:{type:"noExpiration"}}};return{success:!0,assignment:await this.post(`${this.baseUrl}/roleManagement/directory/roleAssignmentScheduleRequests`,a)}}catch(i){return console.error("Failed to create role active assignment:",i),{success:!1,error:this.getFriendlyError(i)}}}async createDirectoryRoleEligibleAssignment(e,t,r,i,a){try{const o={action:"adminAssign",justification:r||"Role assignment",roleDefinitionId:t,directoryScopeId:"/",principalId:e,scheduleInfo:{startDateTime:i,expiration:a?{type:"afterDateTime",endDateTime:a}:{type:"noExpiration"}}};return{success:!0,assignment:await this.post(`${this.baseUrl}/roleManagement/directory/roleEligibilityScheduleRequests`,o)}}catch(o){return console.error("Failed to create role eligible assignment:",o),{success:!1,error:this.getFriendlyError(o)}}}async createDirectoryRoleActiveAssignment(e,t,r,i,a){try{const o={action:"adminAssign",justification:r||"Active role assignment",roleDefinitionId:t,directoryScopeId:"/",principalId:e,scheduleInfo:{startDateTime:i,expiration:a?{type:"afterDateTime",endDateTime:a}:{type:"noExpiration"}}};return{success:!0,assignment:await this.post(`${this.baseUrl}/roleManagement/directory/roleAssignmentScheduleRequests`,o)}}catch(o){return console.error("Failed to create role active assignment:",o),{success:!1,error:this.getFriendlyError(o)}}}async searchUsers(e){try{const t=A.validateInput(e,{maxLength:200,required:!0,minLength:1});if(!t.valid)return{success:!1,error:t.error,users:[]};const r=A.buildODataFilter("displayName","startswith",t.sanitized),i=A.buildODataFilter("userPrincipalName","startswith",t.sanitized);return{success:!0,users:(await this.get(`${this.baseUrl}/users?$filter=${r} or ${i}&$select=id,displayName,userPrincipalName&$top=10`)).value||[]}}catch(t){return{success:!1,error:this.getFriendlyError(t),users:[]}}}async getPIMAuditLogs(e=7){try{const t=new Date;return t.setDate(t.getDate()-e),{success:!0,logs:(await this.get(`${this.baseUrl}/auditLogs/directoryAudits?$filter=activityDateTime ge ${t.toISOString()} and category eq 'RoleManagement'&$top=50&$orderby=activityDateTime desc`)).value||[]}}catch(t){return console.error("Failed to fetch audit logs:",t),{success:!1,error:this.getFriendlyError(t),logs:[]}}}async getPendingApprovals(){try{const e=await this.get(`${this.baseUrl}/roleManagement/directory/roleAssignmentScheduleRequests?$filter=status eq 'PendingApproval'&$expand=principal,roleDefinition`);return{success:!0,requests:e.value||[],count:e.value?.length||0}}catch(e){return console.error("Failed to fetch pending approvals:",e),{success:!1,error:this.getFriendlyError(e),requests:[],count:0}}}async reviewApprovalRequest(e,t,r){try{const i=await this.get(`${this.betaUrl}/roleManagement/directory/roleAssignmentApprovals/${e}`);if(!i.steps||i.steps.length===0)return{success:!1,error:"No approval steps found"};const a=i.steps.find(s=>s.status==="InProgress"||s.status==="NotStarted");if(!a)return{success:!1,error:"No pending approval step found. The request may have already been approved or denied."};const o=t==="approve"?"Approve":"Deny";return await this.patch(`${this.betaUrl}/roleManagement/directory/roleAssignmentApprovals/${e}/steps/${a.id}`,{reviewResult:o,justification:r}),{success:!0}}catch(i){return console.error("Failed to review approval:",i),{success:!1,error:this.getFriendlyError(i)}}}async getRoleAssignmentsWithExpiration(){try{const e=await this.get(`${this.baseUrl}/roleManagement/directory/roleAssignmentScheduleInstances?$expand=principal,roleDefinition&$top=100`),t=await this.get(`${this.baseUrl}/roleManagement/directory/roleEligibilityScheduleInstances?$expand=principal,roleDefinition&$top=100`),r=new Date,i=new Date(r.getTime()+7*24*60*60*1e3),a=(e.value||[]).map(n=>({...n,type:"active",isExpiring:n.endDateTime&&new Date(n.endDateTime)<=i})),o=(t.value||[]).map(n=>({...n,type:"eligible",isExpiring:n.endDateTime&&new Date(n.endDateTime)<=i})),s=[...a,...o].filter(n=>n.isExpiring).sort((n,c)=>new Date(n.endDateTime)-new Date(c.endDateTime));return{success:!0,activeCount:a.length,eligibleCount:o.length,expiringCount:s.length,expiringAssignments:s}}catch(e){return console.error("Failed to fetch role assignments:",e),{success:!1,error:this.getFriendlyError(e),activeCount:0,eligibleCount:0,expiringCount:0,expiringAssignments:[]}}}async getRoleCoverageReport(){try{const t=(await this.getPIMGroups()).groups||[],i=(await this.get(`${this.baseUrl}/roleManagement/directory/roleEligibilityScheduleInstances?$expand=principal,roleDefinition&$top=200`)).value||[],a=i.filter(u=>u.principal?.["@odata.type"]?.includes("group")),o=i.filter(u=>u.principal?.["@odata.type"]?.includes("user")),s=new Map;i.forEach(u=>{const p=u.roleDefinition?.id;if(!p)return;s.has(p)||s.set(p,{roleId:p,roleName:u.roleDefinition?.displayName||"Unknown",groupCount:0,userCount:0,isCovered:!1});const d=s.get(p);u.principal?.["@odata.type"]?.includes("group")?(d.groupCount++,d.isCovered=!0):u.principal?.["@odata.type"]?.includes("user")&&d.userCount++});const n=Array.from(s.values()),c=n.filter(u=>u.isCovered),l=n.filter(u=>!u.isCovered);return{success:!0,totalRoles:n.length,coveredRoles:c.length,uncoveredRoles:l.length,totalPIMGroups:t.length,groupAssignmentsCount:a.length,directUserAssignmentsCount:o.length,roles:n}}catch(e){return console.error("Failed to generate coverage report:",e),{success:!1,error:this.getFriendlyError(e)}}}async runHealthCheck(){try{const e=[],t=[],r=await this.getRoleAssignmentsWithExpiration();r.expiringCount>0&&t.push({severity:"warning",category:"Expiring Assignments",message:`${r.expiringCount} role assignments expiring within 7 days`,count:r.expiringCount});const i=await this.getRoleCoverageReport();i.success&&i.directUserAssignmentsCount>0&&t.push({severity:"info",category:"Direct Assignments",message:`${i.directUserAssignmentsCount} direct user assignments found (consider using groups)`,count:i.directUserAssignmentsCount});const o=((await this.getPIMGroups()).groups||[]).filter(c=>c.memberCount===0);o.length>0&&t.push({severity:"info",category:"Empty Groups",message:`${o.length} PIM groups have no members`,count:o.length,groups:o.map(c=>c.displayName)});const s=await this.getPendingApprovals();s.count>0&&t.push({severity:"warning",category:"Pending Approvals",message:`${s.count} approval requests awaiting review`,count:s.count});const n=Math.max(0,100-e.length*20-t.length*5);return{success:!0,healthScore:n,status:n>=80?"healthy":n>=60?"warning":"critical",issues:e,warnings:t,checksRun:4,timestamp:new Date().toISOString()}}catch(e){return console.error("Health check failed:",e),{success:!1,error:this.getFriendlyError(e)}}}async getMyEligibleRoles(){try{return{success:!0,roles:((await this.get(`${this.betaUrl}/roleManagement/directory/roleEligibilityScheduleInstances?$filter=principalId eq '${await this.getCurrentUserId()}'&$expand=roleDefinition`)).value||[]).map(r=>({id:r.id,roleId:r.roleDefinitionId,displayName:r.roleDefinition?.displayName||"Unknown Role",description:r.roleDefinition?.description||"",privilegeLevel:this.determinePrivilegeLevel(r.roleDefinition?.displayName),assignmentEnd:r.endDateTime,requiresApproval:!1,requiresMfa:!1,requiresJustification:!0,requiresTicket:!1,maxDuration:8,defaultDuration:4}))}}catch(e){return console.error("Failed to get eligible roles:",e),{success:!1,error:this.getFriendlyError(e),roles:[]}}}async getMyActiveRoles(){try{return{success:!0,roles:((await this.get(`${this.betaUrl}/roleManagement/directory/roleAssignmentScheduleInstances?$filter=principalId eq '${await this.getCurrentUserId()}' and assignmentType eq 'Activated'&$expand=roleDefinition`)).value||[]).map(r=>({id:r.id,roleId:r.roleDefinitionId,displayName:r.roleDefinition?.displayName||"Unknown Role",description:r.roleDefinition?.description||"",privilegeLevel:this.determinePrivilegeLevel(r.roleDefinition?.displayName),startDateTime:r.startDateTime,endDateTime:r.endDateTime,justification:r.justification,ticketNumber:r.ticketInfo?.ticketNumber,canExtend:!1}))}}catch(e){return console.error("Failed to get active roles:",e),{success:!1,error:this.getFriendlyError(e),roles:[]}}}async getRoleAssignmentDetails(e){try{try{const r=(await this.get(`${this.betaUrl}/policies/roleManagementPolicies?$filter=scopeId eq '/' and scopeType eq 'DirectoryRole'&$expand=rules`)).value.find(i=>i.rules?.some(a=>a.target?.targetObjects?.some(o=>o===e)));if(r){const i=r.rules||[],a=i.find(c=>c["@odata.type"]==="#microsoft.graph.unifiedRoleManagementPolicyEnablementRule"&&c.target?.caller==="EndUser"&&c.target?.operations?.includes("All")),o=i.find(c=>c["@odata.type"]==="#microsoft.graph.unifiedRoleManagementPolicyApprovalRule"&&c.target?.caller==="EndUser"),s=i.find(c=>c["@odata.type"]==="#microsoft.graph.unifiedRoleManagementPolicyExpirationRule"&&c.target?.caller==="EndUser"&&c.target?.operations?.includes("All")),n=a?.enabledRules||[];return{success:!0,requiresMFA:n.includes("MultiFactorAuthentication"),requiresApproval:o?.setting?.isApprovalRequired||!1,requiresJustification:n.includes("Justification"),requiresTicket:n.includes("Ticketing"),maxDuration:this.parseIsoDuration(s?.maximumDuration)||8,defaultDuration:4,approvers:o?.setting?.approvalStages?.[0]?.primaryApprovers||[]}}}catch(t){console.warn("Could not fetch policy, using defaults:",t.message)}return{success:!0,requiresMFA:!1,requiresApproval:!1,requiresJustification:!0,requiresTicket:!1,maxDuration:8,defaultDuration:4,approvers:[]}}catch(t){return console.error("Failed to get role details:",t),{success:!1,error:this.getFriendlyError(t)}}}async activateRole(e){try{const r={principalId:await this.getCurrentUserId(),roleDefinitionId:e.roleId,directoryScopeId:"/",action:"selfActivate",justification:e.justification||"Role activation",scheduleInfo:{startDateTime:new Date().toISOString(),expiration:{type:"afterDuration",duration:`PT${e.duration}H`}}};return e.ticketNumber&&(r.ticketInfo={ticketNumber:e.ticketNumber,ticketSystem:"Manual"}),await this.post(`${this.betaUrl}/roleManagement/directory/roleAssignmentScheduleRequests`,r),{success:!0,requiresApproval:!1}}catch(t){return console.error("Failed to activate role:",t),{success:!1,error:this.getFriendlyError(t)}}}async deactivateRole(e){try{const t=await this.getCurrentUserId(),r=await this.get(`${this.betaUrl}/roleManagement/directory/roleAssignmentScheduleInstances/${e}`),i={principalId:t,roleDefinitionId:r.roleDefinitionId,directoryScopeId:"/",action:"selfDeactivate",justification:"Manual deactivation"};return await this.post(`${this.betaUrl}/roleManagement/directory/roleAssignmentScheduleRequests`,i),{success:!0}}catch(t){return console.error("Failed to deactivate role:",t),{success:!1,error:this.getFriendlyError(t)}}}async getCurrentUserId(){try{return(await this.get(`${this.baseUrl}/me?$select=id`)).id}catch(e){throw console.error("Failed to get current user ID:",e),e}}determinePrivilegeLevel(e){const t=(e||"").toLowerCase();return t.includes("global admin")||t.includes("company admin")?"critical":t.includes("privileged")||t.includes("security")||t.includes("compliance")?"high":t.includes("admin")||t.includes("director")?"medium":"low"}getFriendlyError(e){const t=e.message||e.toString();return e.status===401?"Session expired. Please sign in again.":e.status===403?"You do not have permission to perform this action.":e.status===404?"Resource not found.":e.code==="Authorization_RequestDenied"?"Access denied. Admin consent may be required.":t}};T(b,"PRIVILEGE_LEVELS",{critical:["62e90394-69f5-4237-9190-012177145e10","e8611ab8-c189-46e8-94e1-60213ab1f814","194ae4cb-b126-40b2-bd5b-6091b380977d","9b895d92-2cd3-44c7-9d02-a6ac2d5ea5c3","158c047a-c907-4556-b7ef-446551a6b5f7","29232cdf-9323-42fd-ade2-1d097af3e4de","f28a1f50-f6e7-4571-818b-6a12f2af6b6c","fe930be7-5e62-47db-91af-98c3a49a38b1"],high:["7be44c8a-adaf-4e2a-84d6-ab2649e08a13","c4e39bd9-1100-46d3-8c65-fb160da0071f","b1be1c3e-b65d-4f19-8427-f6fa0d97feb9","729827e3-9c14-49f7-bb1b-9608f156bbb8","b0f54661-2d74-4c50-afa3-1ec803f12efe","966707d0-3269-4727-9be2-8c3a10f19b9d","fdd7a751-b60b-444a-984c-02652fe8fa1c","3a2c62db-5318-420d-8d74-23affee5d9d5","11648597-926c-4cf3-9c36-bcebb0ba8dcc"],medium:["44367163-eba1-44c3-98af-f5787879f96a","3d762c5a-1b6c-493f-843e-55a3b42923d4","112f9467-49fe-4fc5-9abe-d52302e4f8c1","31392ffb-586c-42d1-9346-e59415a2cc4e","892c5842-a9a6-463a-8041-72aa08ca3cf6","17315797-102d-40b4-93e0-432062caca18","d29b2b05-8046-44ba-8758-1e26182fcf32"]});let w=b;const B=new w,R={standard:{id:"standard",name:"Standard Security",description:"Balanced security for typical enterprise use. Requires MFA and justification, with 8-hour activation window.",icon:"fa-shield-alt",color:"primary",settings:{activation:{maximumDurationHours:8,requireMfa:!0,requireJustification:!0,requireTicketInfo:!1,requireApproval:!1},eligibleAssignment:{allowPermanent:!0,maximumDurationDays:365},activeAssignment:{allowPermanent:!1,maximumDurationDays:30,requireMfa:!0,requireJustification:!0}}},"high-security":{id:"high-security",name:"High Security",description:"Maximum security with mandatory approval workflows. Short activation window with all security controls enabled.",icon:"fa-lock",color:"danger",settings:{activation:{maximumDurationHours:4,requireMfa:!0,requireJustification:!0,requireTicketInfo:!0,requireApproval:!0},eligibleAssignment:{allowPermanent:!1,maximumDurationDays:180},activeAssignment:{allowPermanent:!1,maximumDurationDays:7,requireMfa:!0,requireJustification:!0}}},"low-friction":{id:"low-friction",name:"Low Friction",description:"Streamlined access for trusted environments. Extended activation window with minimal approval barriers.",icon:"fa-bolt",color:"warning",settings:{activation:{maximumDurationHours:12,requireMfa:!0,requireJustification:!1,requireTicketInfo:!1,requireApproval:!1},eligibleAssignment:{allowPermanent:!0,maximumDurationDays:365},activeAssignment:{allowPermanent:!1,maximumDurationDays:90,requireMfa:!1,requireJustification:!1}}},compliance:{id:"compliance",name:"Compliance Ready",description:"Settings aligned with SOX, HIPAA, and other regulatory requirements. Full audit trail with ticket tracking.",icon:"fa-clipboard-check",color:"success",settings:{activation:{maximumDurationHours:8,requireMfa:!0,requireJustification:!0,requireTicketInfo:!0,requireApproval:!0},eligibleAssignment:{allowPermanent:!1,maximumDurationDays:90},activeAssignment:{allowPermanent:!1,maximumDurationDays:14,requireMfa:!0,requireJustification:!0}}}},$="pimbuddy-custom-templates";class G{constructor(){this.customTemplates=this.loadCustomTemplates()}getAllTemplates(){return{...R,...this.customTemplates}}getBuiltInTemplates(){return{...R}}getCustomTemplates(){return{...this.customTemplates}}getTemplate(e){return this.getAllTemplates()[e]||null}getTemplateSettings(e){const t=this.getTemplate(e);return t?t.settings:null}saveCustomTemplate(e){if(!e.id||!e.name||!e.settings)throw new Error("Template must have id, name, and settings");return e.isCustom=!0,e.createdAt=e.createdAt||new Date().toISOString(),e.updatedAt=new Date().toISOString(),this.customTemplates[e.id]=e,this.persistCustomTemplates(),e}deleteCustomTemplate(e){return this.customTemplates[e]?(delete this.customTemplates[e],this.persistCustomTemplates(),!0):!1}createTemplateFromSettings(e,t,r){const i="custom-"+Date.now();return this.saveCustomTemplate({id:i,name:e,description:t,icon:"fa-file-alt",color:"secondary",isCustom:!0,settings:r})}compareSettings(e,t){const r=[];return e.activation.maximumDurationHours!==t.activation.maximumDurationHours&&r.push({setting:"Maximum Activation Duration",current:`${e.activation.maximumDurationHours} hours`,template:`${t.activation.maximumDurationHours} hours`}),e.activation.requireMfa!==t.activation.requireMfa&&r.push({setting:"Require MFA",current:e.activation.requireMfa?"Yes":"No",template:t.activation.requireMfa?"Yes":"No"}),e.activation.requireJustification!==t.activation.requireJustification&&r.push({setting:"Require Justification",current:e.activation.requireJustification?"Yes":"No",template:t.activation.requireJustification?"Yes":"No"}),e.activation.requireApproval!==t.activation.requireApproval&&r.push({setting:"Require Approval",current:e.activation.requireApproval?"Yes":"No",template:t.activation.requireApproval?"Yes":"No"}),e.activation.requireTicketInfo!==t.activation.requireTicketInfo&&r.push({setting:"Require Ticket Info",current:e.activation.requireTicketInfo?"Yes":"No",template:t.activation.requireTicketInfo?"Yes":"No"}),r}loadCustomTemplates(){try{const e=localStorage.getItem($);return e?JSON.parse(e):{}}catch{return{}}}persistCustomTemplates(){localStorage.setItem($,JSON.stringify(this.customTemplates))}}const j=new G;class F{constructor(){this.diagramTypes={"user-group":{name:"Users â†’ Groups",description:"Shows which users are eligible/active members of PIM groups",icon:"fa-users"},"group-role":{name:"Groups â†’ Roles",description:"Shows which groups have assignments to Entra ID roles",icon:"fa-sitemap"},"full-hierarchy":{name:"Full Hierarchy",description:"Complete view: Users â†’ Groups â†’ Roles",icon:"fa-project-diagram"},"role-assignments":{name:"Role Assignments",description:"Shows all role assignments (direct and through groups)",icon:"fa-user-shield"}}}generateDiagram(e,t,r={}){switch(e){case"user-group":return this.generateUserGroupDiagram(t,r);case"group-role":return this.generateGroupRoleDiagram(t,r);case"full-hierarchy":return this.generateFullHierarchyDiagram(t,r);case"role-assignments":return this.generateRoleAssignmentsDiagram(t,r);default:return this.generateFullHierarchyDiagram(t,r)}}generateUserGroupDiagram(e,t={}){const{groups:r=[],groupAssignments:i={}}=e,{showEligible:a=!0,showActive:o=!0,direction:s="LR"}=t;let n=`flowchart ${s}
`;n+=`    %% PIMMaid - Users to Groups Diagram
`,n+=`    %% Generated: ${new Date().toISOString()}

`,n+=`    subgraph Users["ðŸ‘¤ Users"]
`;const c=new Map,l=[];for(const[u,p]of Object.entries(i))if(r.find(m=>m.id===u)){if(a&&p.eligible)for(const m of p.eligible)c.has(m.id)||c.set(m.id,{...m,type:"user"}),l.push({from:m.id,to:u,type:"eligible",label:"eligible"});if(o&&p.active)for(const m of p.active)c.has(m.id)||c.set(m.id,{...m,type:"user"}),l.push({from:m.id,to:u,type:"active",label:"active"})}for(const[u,p]of c){const d=this.sanitizeId(p.displayName||u);n+=`        ${this.sanitizeId(u)}["${d}"]
`}n+=`    end

`,n+=`    subgraph Groups["ðŸ” PIM Groups"]
`;for(const u of r)if(i[u.id]){const p=this.sanitizeId(u.displayName);n+=`        ${this.sanitizeId(u.id)}[["${p}"]]
`}n+=`    end

`,n+=`    %% Connections
`;for(const u of l){const p=u.type==="eligible"?"-.->":"-->",d=u.type==="eligible"?"|eligible|":"|active|";n+=`    ${this.sanitizeId(u.from)} ${p}${d} ${this.sanitizeId(u.to)}
`}return n+=this.getDefaultStyles(),n}generateGroupRoleDiagram(e,t={}){const{groups:r=[],roles:i=[],roleAssignments:a={}}=e,{direction:o="LR"}=t;let s=`flowchart ${o}
`;s+=`    %% PIMMaid - Groups to Roles Diagram
`,s+=`    %% Generated: ${new Date().toISOString()}

`,s+=`    subgraph Groups["ðŸ” PIM Groups"]
`;const n=new Set;for(const[l,u]of Object.entries(a))for(const p of u)p.principalType==="Group"&&n.add(p.principalId);for(const l of r)n.has(l.id)&&(s+=`        ${this.sanitizeId(l.id)}[["${this.sanitizeId(l.displayName)}"]]
`);s+=`    end

`,s+=`    subgraph Roles["ðŸ›¡ï¸ Entra ID Roles"]
`;const c=new Set(Object.keys(a));for(const l of i)if(c.has(l.id)){const u=this.getPrivilegeIcon(l.privilegeLevel);s+=`        ${this.sanitizeId(l.id)}[/"${u} ${this.sanitizeId(l.displayName)}"\\]
`}s+=`    end

`,s+=`    %% Assignments
`;for(const[l,u]of Object.entries(a))for(const p of u)if(p.principalType==="Group"){const d=p.assignmentType==="Eligible"?"-.->":"-->",m=p.assignmentType==="Eligible"?"|eligible|":"|active|";s+=`    ${this.sanitizeId(p.principalId)} ${d}${m} ${this.sanitizeId(l)}
`}return s+=this.getDefaultStyles(),s}generateFullHierarchyDiagram(e,t={}){const{groups:r=[],roles:i=[],groupAssignments:a={},roleAssignments:o={}}=e,{direction:s="LR",showEligible:n=!0,showActive:c=!0}=t;let l=`flowchart ${s}
`;l+=`    %% PIMMaid - Full PIM Hierarchy
`,l+=`    %% Generated: ${new Date().toISOString()}

`;const u=new Map,p=[],d=[];for(const[g,h]of Object.entries(a)){if(n&&h.eligible)for(const v of h.eligible)u.set(v.id,v),p.push({userId:v.id,groupId:g,type:"eligible"});if(c&&h.active)for(const v of h.active)u.set(v.id,v),p.push({userId:v.id,groupId:g,type:"active"})}for(const[g,h]of Object.entries(o))for(const v of h)v.principalType==="Group"&&d.push({groupId:v.principalId,roleId:g,type:v.assignmentType?.toLowerCase()||"active"});if(u.size>0){l+=`    subgraph Users["ðŸ‘¤ Users"]
`,l+=`        direction TB
`;for(const[g,h]of u)l+=`        ${this.sanitizeId(g)}["${this.sanitizeId(h.displayName||"Unknown")}"]
`;l+=`    end

`}const m=new Set([...p.map(g=>g.groupId),...d.map(g=>g.groupId)]);if(m.size>0){l+=`    subgraph Groups["ðŸ” PIM Groups"]
`,l+=`        direction TB
`;for(const g of r)m.has(g.id)&&(l+=`        ${this.sanitizeId(g.id)}[["${this.sanitizeId(g.displayName)}"]]
`);l+=`    end

`}const y=new Set(d.map(g=>g.roleId));if(y.size>0){l+=`    subgraph Roles["ðŸ›¡ï¸ Entra Roles"]
`,l+=`        direction TB
`;for(const g of i)if(y.has(g.id)){const h=this.getPrivilegeIcon(g.privilegeLevel);l+=`        ${this.sanitizeId(g.id)}[/"${h} ${this.sanitizeId(g.displayName)}"\\]
`}l+=`    end

`}l+=`    %% User to Group assignments
`;for(const g of p){const h=g.type==="eligible"?"-.->":"-->";l+=`    ${this.sanitizeId(g.userId)} ${h} ${this.sanitizeId(g.groupId)}
`}l+=`
    %% Group to Role assignments
`;for(const g of d){const h=g.type==="eligible"?"-.->":"-->";l+=`    ${this.sanitizeId(g.groupId)} ${h} ${this.sanitizeId(g.roleId)}
`}return l+=this.getDefaultStyles(),l}generateRoleAssignmentsDiagram(e,t={}){const{roles:r=[],roleAssignments:i={}}=e,{direction:a="TB"}=t;let o=`flowchart ${a}
`;o+=`    %% PIMMaid - Role Assignments Overview
`,o+=`    %% Generated: ${new Date().toISOString()}

`;const s=r.filter(d=>d.privilegeLevel==="critical"),n=r.filter(d=>d.privilegeLevel==="high"),c=r.filter(d=>d.privilegeLevel==="medium"),l=r.filter(d=>d.privilegeLevel==="low"),u=(d,m,y)=>{if(d.length===0)return"";let g=`    subgraph ${m.replace(/\s/g,"")}["${y} ${m}"]
`;for(const h of d)i[h.id]&&(g+=`        ${this.sanitizeId(h.id)}[/"${this.sanitizeId(h.displayName)}"\\]
`);return g+=`    end

`,g};o+=u(s,"Critical Roles","ðŸ’€"),o+=u(n,"High Privilege","âš ï¸"),o+=u(c,"Medium Privilege","ðŸ”µ"),o+=u(l,"Low Privilege","âœ…");const p=new Map;for(const[d,m]of Object.entries(i))for(const y of m)p.has(y.principalId)||p.set(y.principalId,{id:y.principalId,name:y.principalDisplayName||"Unknown",type:y.principalType});if(p.size>0){o+=`    subgraph Principals["ðŸ‘¥ Assigned Principals"]
`;for(const[d,m]of p){const y=m.type==="Group"?`[["${this.sanitizeId(m.name)}"]]`:`["${this.sanitizeId(m.name)}"]`;o+=`        ${this.sanitizeId(d)}${y}
`}o+=`    end

`}o+=`    %% Assignments
`;for(const[d,m]of Object.entries(i))for(const y of m){const g=y.assignmentType==="Eligible"?"-.->":"-->";o+=`    ${this.sanitizeId(y.principalId)} ${g} ${this.sanitizeId(d)}
`}return o+=this.getDefaultStyles(),o}getPrivilegeIcon(e){return{critical:"ðŸ’€",high:"âš ï¸",medium:"ðŸ”µ",low:"âœ…"}[e]||"ðŸ“‹"}sanitizeId(e){return e?e.replace(/[^a-zA-Z0-9\s-]/g,"").replace(/\s+/g,"_").substring(0,40):"unknown"}getDefaultStyles(){return`
    %% Styling
    classDef userNode fill:#1e3a5f,stroke:#00d4aa,stroke-width:2px,color:#fff
    classDef groupNode fill:#2d1b4e,stroke:#7c3aed,stroke-width:2px,color:#fff
    classDef criticalRole fill:#4a1515,stroke:#ef4444,stroke-width:3px,color:#fff
    classDef highRole fill:#4a3415,stroke:#f59e0b,stroke-width:2px,color:#fff
    classDef mediumRole fill:#1e3a5f,stroke:#3b82f6,stroke-width:2px,color:#fff
    classDef lowRole fill:#1a3a2a,stroke:#10b981,stroke-width:2px,color:#fff
`}getDiagramTypes(){return this.diagramTypes}getStats(e){const{groups:t=[],roles:r=[],groupAssignments:i={},roleAssignments:a={}}=e;let o=new Set,s=0,n=0;for(const l of Object.values(i))l.eligible&&(l.eligible.forEach(u=>o.add(u.id)),s+=l.eligible.length),l.active&&(l.active.forEach(u=>o.add(u.id)),n+=l.active.length);const c={critical:r.filter(l=>l.privilegeLevel==="critical").length,high:r.filter(l=>l.privilegeLevel==="high").length,medium:r.filter(l=>l.privilegeLevel==="medium").length,low:r.filter(l=>l.privilegeLevel==="low").length};return{totalUsers:o.size,totalGroups:t.length,totalRoles:r.length,eligibleAssignments:s,activeAssignments:n,rolesByPrivilege:c}}}const Z=new F;class N{constructor(){this.baselineConfigurations={"enterprise-standard":{id:"enterprise-standard",name:"Enterprise Standard",description:"Balanced security for typical enterprise environments. Implements tiered access with MFA and approval workflows for critical roles.",icon:"fa-building",color:"primary",features:["Tiered access model (T0/T1/T2)","MFA required for all roles","Approval required for Tier 0","Justification tracking","4-8 hour activation windows"],tiers:[{tier:0,name:"Tier 0 - Critical Infrastructure",description:"Highest privilege roles with maximum security controls",policy:{maximumDurationHours:4,requireMfa:!0,requireJustification:!0,requireTicketInfo:!0,requireApproval:!0},groups:[{name:"PIM-T0-Global-Administrators",description:"Tier 0: Global Administrator role access",roles:["62e90394-69f5-4237-9190-012177145e10"]},{name:"PIM-T0-Privileged-Role-Administrators",description:"Tier 0: Privileged Role Administrator access",roles:["e8611ab8-c189-46e8-94e1-60213ab1f814"]},{name:"PIM-T0-Security-Administrators",description:"Tier 0: Security Administrator access",roles:["194ae4cb-b126-40b2-bd5b-6091b380977d"]}]},{tier:1,name:"Tier 1 - High Privilege Operations",description:"High privilege operational roles",policy:{maximumDurationHours:8,requireMfa:!0,requireJustification:!0,requireTicketInfo:!1,requireApproval:!1},groups:[{name:"PIM-T1-User-Administrators",description:"Tier 1: User Administrator access",roles:["fe930be7-5e62-47db-91af-98c3a49a38b1"]},{name:"PIM-T1-Exchange-Administrators",description:"Tier 1: Exchange Administrator access",roles:["29232cdf-9323-42fd-ade2-1d097af3e4de"]},{name:"PIM-T1-SharePoint-Administrators",description:"Tier 1: SharePoint Administrator access",roles:["f28a1f50-f6e7-4571-818b-6a12f2af6b6c"]},{name:"PIM-T1-Application-Administrators",description:"Tier 1: Application Administrator access",roles:["9b895d92-2cd3-44c7-9d02-a6ac2d5ea5c3"]}]},{tier:2,name:"Tier 2 - Standard Operations",description:"Standard operational roles with moderate privilege",policy:{maximumDurationHours:8,requireMfa:!0,requireJustification:!0,requireTicketInfo:!1,requireApproval:!1},groups:[{name:"PIM-T2-Helpdesk-Administrators",description:"Tier 2: Helpdesk Administrator access",roles:["729827e3-9c14-49f7-bb1b-9608f156bbb8"]},{name:"PIM-T2-Groups-Administrators",description:"Tier 2: Groups Administrator access",roles:["fdd7a751-b60b-444a-984c-02652fe8fa1c"]},{name:"PIM-T2-Teams-Administrators",description:"Tier 2: Teams Administrator access",roles:["69091246-20e8-4a56-aa4d-066075b2a7a8"]}]}]},"high-security":{id:"high-security",name:"High Security (Zero Trust)",description:"Maximum security baseline for highly regulated industries. All roles require approval, short activation windows, and comprehensive audit trails.",icon:"fa-shield-alt",color:"danger",features:["Zero Trust security model","Approval required for all tiers","Ticket tracking mandatory","Short activation (2-6 hours)","Comprehensive audit trails","MFA + Justification always required"],tiers:[{tier:0,name:"Tier 0 - Critical Infrastructure",description:"Maximum security for critical roles",policy:{maximumDurationHours:2,requireMfa:!0,requireJustification:!0,requireTicketInfo:!0,requireApproval:!0},groups:[{name:"PIM-ZT-T0-Global-Administrators",description:"Zero Trust Tier 0: Global Administrator (2h max, full approval)",roles:["62e90394-69f5-4237-9190-012177145e10"]},{name:"PIM-ZT-T0-Privileged-Role-Administrators",description:"Zero Trust Tier 0: Privileged Role Administrator",roles:["e8611ab8-c189-46e8-94e1-60213ab1f814"]},{name:"PIM-ZT-T0-Security-Administrators",description:"Zero Trust Tier 0: Security Administrator",roles:["194ae4cb-b126-40b2-bd5b-6091b380977d"]}]},{tier:1,name:"Tier 1 - High Privilege Operations",description:"Strict controls for operational roles",policy:{maximumDurationHours:4,requireMfa:!0,requireJustification:!0,requireTicketInfo:!0,requireApproval:!0},groups:[{name:"PIM-ZT-T1-User-Administrators",description:"Zero Trust Tier 1: User Administrator",roles:["fe930be7-5e62-47db-91af-98c3a49a38b1"]},{name:"PIM-ZT-T1-Exchange-Administrators",description:"Zero Trust Tier 1: Exchange Administrator",roles:["29232cdf-9323-42fd-ade2-1d097af3e4de"]},{name:"PIM-ZT-T1-SharePoint-Administrators",description:"Zero Trust Tier 1: SharePoint Administrator",roles:["f28a1f50-f6e7-4571-818b-6a12f2af6b6c"]}]},{tier:2,name:"Tier 2 - Standard Operations",description:"Enhanced security for standard roles",policy:{maximumDurationHours:6,requireMfa:!0,requireJustification:!0,requireTicketInfo:!0,requireApproval:!1},groups:[{name:"PIM-ZT-T2-Helpdesk-Administrators",description:"Zero Trust Tier 2: Helpdesk Administrator",roles:["729827e3-9c14-49f7-bb1b-9608f156bbb8"]},{name:"PIM-ZT-T2-Groups-Administrators",description:"Zero Trust Tier 2: Groups Administrator",roles:["fdd7a751-b60b-444a-984c-02652fe8fa1c"]}]}]},"quick-start":{id:"quick-start",name:"Quick Start (Development/POC)",description:"Simplified configuration for development environments and proof of concepts. Lower friction with basic security controls.",icon:"fa-rocket",color:"success",features:["Simplified 2-tier model","MFA required only","No approval workflows","Extended activation (8-12 hours)","Ideal for dev/test environments"],tiers:[{tier:0,name:"Critical Roles",description:"Essential admin roles with basic PIM",policy:{maximumDurationHours:8,requireMfa:!0,requireJustification:!1,requireTicketInfo:!1,requireApproval:!1},groups:[{name:"PIM-Global-Administrators",description:"Global Administrator access",roles:["62e90394-69f5-4237-9190-012177145e10"]},{name:"PIM-User-Administrators",description:"User Administrator access",roles:["fe930be7-5e62-47db-91af-98c3a49a38b1"]}]},{tier:1,name:"Operational Roles",description:"Common operational roles",policy:{maximumDurationHours:12,requireMfa:!0,requireJustification:!1,requireTicketInfo:!1,requireApproval:!1},groups:[{name:"PIM-Helpdesk-Administrators",description:"Helpdesk Administrator access",roles:["729827e3-9c14-49f7-bb1b-9608f156bbb8"]},{name:"PIM-Teams-Administrators",description:"Teams Administrator access",roles:["69091246-20e8-4a56-aa4d-066075b2a7a8"]}]}]}},this.bestPractices={naming:{title:"Naming Convention",description:"Groups follow the pattern: PIM-[Tier]-[RoleName]. This makes it easy to identify privilege level at a glance.",example:"PIM-T0-Global-Administrators"},tiering:{title:"Tiered Access Model",description:"Tier 0 = Critical infrastructure, Tier 1 = High privilege operations, Tier 2 = Standard operations. Each tier has appropriate security controls.",reference:"Microsoft Privileged Access Strategy"},policies:{title:"Security Controls by Tier",tier0:"Shortest activation (2-4h), always MFA+Approval+Justification+Ticketing",tier1:"Medium activation (4-8h), MFA+Justification, optional approval",tier2:"Standard activation (6-12h), MFA+Justification"},assignments:{title:"Assignment Strategy",description:"Use eligible assignments (not active). Set time-bound eligibility (90-180 days) and require periodic revalidation.",recommendation:"Never use permanent active assignments for privileged roles"}}}getBaselineConfigurations(){return this.baselineConfigurations}getBaseline(e){return this.baselineConfigurations[e]||null}getBestPractices(){return this.bestPractices}calculateDeploymentPlan(e,t={}){let r,i;if(typeof e=="string"?(r=this.getBaseline(e),i=r?.tiers||[]):(r=this.getBaseline(e.baseline),i=e.tiers||r?.tiers||[]),!r)return null;const{existingGroups:a=[]}=t,o=new Set(a.map(p=>p.displayName)),s=[],n=[],c=[];for(const p of i)for(const d of p.groups)o.has(d.name)||(s.push({displayName:d.name,description:d.description,mailEnabled:!1,mailNickname:d.name.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase(),securityEnabled:!0,isAssignableToRole:!0,roles:d.roles,tier:p.tier,policy:p.policy}),n.push({groupName:d.name,policy:p.policy}),c.push(...d.roles.map(m=>({groupName:d.name,roleId:m}))));const l=s.length*15+n.length*10+c.length*5,u=Math.ceil(l/60);return{baseline:r.name,groupsToCreate:s,policiesToConfigure:n,roleAssignmentsToCreate:c,estimatedTime:u>1?`${u} minutes`:"< 1 minute",steps:this.getDeploymentStepsList(s.length,n.length)}}getDeploymentStepsList(e,t){return[{icon:"fa-users",title:"Create PIM Groups",description:`Create ${e} role-assignable security groups with appropriate naming`},{icon:"fa-clock",title:"Wait for Provisioning",description:"Allow time for groups to be fully provisioned in Azure AD"},{icon:"fa-shield-alt",title:"Configure Policies",description:`Apply ${t} tier-specific policies (expiration, enablement, approval)`},{icon:"fa-check-circle",title:"Verify Deployment",description:"Confirm all groups and policies are correctly configured"}]}estimateDeploymentTime(e,t,r){const i=e*15+t*10+r*5;return Math.ceil(i/60)}getDeploymentSteps(e,t={}){const r=this.getBaseline(e);if(!r)return[];const i=[],{selectedTiers:a=null}=t;let o=r.tiers;a&&(o=o.filter(s=>a.includes(s.tier)));for(const s of o)for(const n of s.groups)i.push({type:"create-group",tier:s.tier,tierName:s.name,group:n,description:`Create group: ${n.name}`});for(const s of o)for(const n of s.groups)i.push({type:"apply-policy",tier:s.tier,tierName:s.name,group:n,policy:s.policy,description:`Configure policy for: ${n.name}`});if(t.userAssignments){for(const s of o)for(const n of s.groups)if(t.userAssignments[n.name])for(const c of t.userAssignments[n.name])i.push({type:"assign-user",tier:s.tier,tierName:s.name,group:n,userId:c,description:`Assign user to: ${n.name}`})}return i}validateBaseline(e,t={}){let r,i;if(typeof e=="string"?(r=this.getBaseline(e),i=r?.tiers||[]):(r=this.getBaseline(e.baseline),i=e.tiers||r?.tiers||[]),!r)return{valid:!1,errors:["Baseline not found"],warnings:[]};const{existingGroups:a=[]}=t,o=[],s=[],n=new Set(a.map(p=>p.displayName));let c=0;const l=[],u=[];for(const p of i)for(const d of p.groups)n.has(d.name)?(l.push(d.name),s.push(`Group "${d.name}" already exists and will be skipped`)):(c++,u.push(d.name));return c===0&&l.length>0&&(s.push(`All ${l.length} groups already exist. Nothing to deploy.`),s.push("Tip: Customize group names or delete existing groups first.")),{valid:c>0,errors:o,warnings:s,groupsToCreate:c,existingGroups:l,newGroups:u}}getBaselineSummary(e){const t=this.getBaseline(e);if(!t)return null;const r={name:t.name,description:t.description,tiers:t.tiers.length,totalGroups:0,totalRoles:0,policies:{},securityLevel:this.calculateSecurityLevel(t)};for(const i of t.tiers){r.totalGroups+=i.groups.length,r.totalRoles+=i.groups.reduce((o,s)=>o+s.roles.length,0);const a=JSON.stringify(i.policy);r.policies[a]||(r.policies[a]={...i.policy,count:0}),r.policies[a].count+=i.groups.length}return r}calculateSecurityLevel(e){let t=0,r=0;for(const i of e.tiers)for(const a of i.groups){r++;const o=i.policy;o.requireMfa&&(t+=20),o.requireJustification&&(t+=15),o.requireApproval&&(t+=25),o.requireTicketInfo&&(t+=15),o.maximumDurationHours<=4?t+=15:o.maximumDurationHours<=8?t+=10:t+=5}return r>0?Math.round(t/r):0}}const W=new N;export{M as a,W as b,U as c,O as d,B as g,x as i,Z as p,j as t};
//# sourceMappingURL=services-DF6cB9Vv.js.map

/**
 * PIMBuddy Web Application
 * Main entry point and UI controller
 */

import { authService } from './services/authService.js';
import { graphService } from './services/graphService.js';
import { bootstrapService } from './services/bootstrapService.js';
import { templateService } from './services/templateService.js';
import { pimmaidService } from './services/pimmaidService.js';
import { baselineService } from './services/baselineService.js';
import { isAppConfigured, clearAppConfig, getSavedAppConfig } from './config/authConfig.js';
import { SecurityUtils, sessionManager } from './utils/security.js';
import { Paginator } from './utils/pagination.js';
import { PAGINATION } from './utils/constants.js';
import { ExportUtils, ExportConfigs } from './utils/export.js';
import { BulkOperationsManager, executeBulkOperation, renderBulkProgressModal, renderBulkResultsModal } from './utils/bulkOperations.js';
import { errorHandler, AppError, ErrorType, retryOperation, safeExecute } from './utils/errorHandling.js';
import UIComponents from './utils/uiComponents.js';
import { CacheManager } from './core/CacheManager.js';
import { PageRouter } from './core/PageRouter.js';
import { DashboardPage } from './pages/DashboardPage.js';
import { GroupsPage } from './pages/GroupsPage.js';
import { RolesPage } from './pages/RolesPage.js';
import { ActivityPage } from './pages/ActivityPage.js';
import { ApprovalsPage } from './pages/ApprovalsPage.js';
import { ExpiringPage } from './pages/ExpiringPage.js';
import { HealthCheckPage } from './pages/HealthCheckPage.js';
import { CoveragePage } from './pages/CoveragePage.js';
import { PimmaidPage } from './pages/PimmaidPage.js';
import { PoliciesPage } from './pages/PoliciesPage.js';
import { TemplatesPage } from './pages/TemplatesPage.js';
import { ExportPage } from './pages/ExportPage.js';
import { SettingsPage } from './pages/SettingsPage.js';

class PIMBuddyApp {
    constructor() {
        this.currentPage = 'dashboard';
        this.isConnected = false;
        this.isConfigured = false;
        this.isDarkMode = false;
        this.cache = {
            groups: null,
            roles: null,
            templates: null
        };
        // Pagination instances
        this.paginators = {
            groups: new Paginator([], PAGINATION.DEFAULT_PAGE_SIZE),
            roles: new Paginator([], PAGINATION.DEFAULT_PAGE_SIZE),
            activity: new Paginator([], PAGINATION.DEFAULT_PAGE_SIZE)
        };
        // Bulk operations managers
        this.bulkOps = {
            groups: new BulkOperationsManager()
        };
        // Export utilities
        this.exportUtils = ExportUtils;

        // Initialize cache manager
        this.cacheManager = new CacheManager();

        // Initialize page instances
        this.pages = {
            dashboard: new DashboardPage(this),
            groups: new GroupsPage(this),
            roles: new RolesPage(this),
            activity: new ActivityPage(this),
            approvals: new ApprovalsPage(this),
            expiring: new ExpiringPage(this),
            healthCheck: new HealthCheckPage(this),
            coverage: new CoveragePage(this),
            pimmaid: new PimmaidPage(this),
            policies: new PoliciesPage(this),
            templates: new TemplatesPage(this),
            export: new ExportPage(this),
            settings: new SettingsPage(this)
        };

        // Initialize router
        this.router = new PageRouter(this, {
            'dashboard': this.pages.dashboard,
            'groups': this.pages.groups,
            'roles': this.pages.roles,
            'entra-roles': this.pages.roles, // alias
            'pim-activity': this.pages.activity,
            'pending-approvals': this.pages.approvals,
            'expiring-assignments': this.pages.expiring,
            'health-check': this.pages.healthCheck,
            'role-coverage': this.pages.coverage,
            'pimmaid': this.pages.pimmaid,
            'policies': this.pages.policies,
            'templates': this.pages.templates,
            'export': this.pages.export,
            'settings': this.pages.settings
        });
    }

    /**
     * Initialize the application
     */
    async init() {
        console.log('PIMBuddy Web initializing...');

        // Load saved theme preference
        this.loadTheme();

        // Check if app is configured
        this.isConfigured = isAppConfigured();

        if (this.isConfigured) {
            // Initialize MSAL with saved config
            try {
                const initialized = await authService.initialize();

                if (initialized && authService.isAuthenticated()) {
                    this.handleSuccessfulLogin();
                }
            } catch (error) {
                console.error('Failed to initialize auth:', error);
                this.showToast('Failed to initialize authentication', 'error');
            }
        } else {
            // Show setup required message
            this.showSetupRequired();
        }

        // Set up event listeners
        this.setupEventListeners();

        // Render initial page
        this.renderPage(this.currentPage);

        console.log('PIMBuddy Web initialized');
    }

    /**
     * Set up all event listeners
     */
    setupEventListeners() {
        // Connect button
        document.getElementById('connect-btn').addEventListener('click', () => this.handleConnect());

        // Theme toggle
        document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());

        // Navigation items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const page = e.currentTarget.dataset.page;
                this.navigateTo(page);
            });
        });

        // Modal backdrop click to close
        document.querySelector('.modal-backdrop')?.addEventListener('click', () => this.closeModal());

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+F for search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                this.showGlobalSearch();
            }
            // Escape to close modal
            if (e.key === 'Escape') {
                this.closeModal();
            }
            // F5 to refresh
            if (e.key === 'F5') {
                e.preventDefault();
                this.refreshCurrentPage();
            }
        });
    }

    /**
     * Show setup required state
     */
    showSetupRequired() {
        document.getElementById('connect-text').textContent = 'Setup';
        document.getElementById('connection-text').textContent = 'Setup Required';
    }

    /**
     * Handle connect/disconnect button
     */
    async handleConnect() {
        if (!this.isConfigured) {
            // Show setup wizard
            await this.showSetupWizard();
            return;
        }

        if (this.isConnected) {
            // Disconnect
            this.showLoading('Signing out...');
            const result = await authService.logout();
            this.hideLoading();

            if (result.success) {
                this.handleLogout();
            } else {
                this.showToast(result.error, 'error');
            }
        } else {
            // Connect
            this.showLoading('Signing in...');
            const result = await authService.login();
            this.hideLoading();

            if (result.success) {
                this.handleSuccessfulLogin();
            } else {
                this.showToast(result.error, 'error');
            }
        }
    }

    /**
     * Handle successful login
     */
    handleSuccessfulLogin() {
        this.isConnected = true;
        const account = authService.getAccount();

        // Update UI
        document.getElementById('connect-text').textContent = 'Disconnect';
        document.getElementById('connect-btn').classList.remove('btn-primary');
        document.getElementById('connect-btn').classList.add('btn-danger');
        document.getElementById('connection-indicator').classList.remove('disconnected');
        document.getElementById('connection-indicator').classList.add('connected');
        document.getElementById('connection-text').textContent = account?.username || 'Connected';

        this.showToast('Connected successfully', 'success');

        // Start session management
        sessionManager.start(
            // On timeout callback
            () => {
                this.showToast('Session expired due to inactivity', 'warning');
                this.handleLogout();
            },
            // On warning callback
            (remainingMinutes) => {
                this.showToast(
                    `Your session will expire in ${remainingMinutes} minutes due to inactivity`,
                    'warning'
                );
            }
        );

        // Refresh current page data
        this.refreshCurrentPage();
    }

    /**
     * Handle logout
     */
    handleLogout() {
        this.isConnected = false;
        this.cache = { groups: null, roles: null, templates: null };

        // Stop session management
        sessionManager.stop();

        // Update UI
        document.getElementById('connect-text').textContent = 'Connect';
        document.getElementById('connect-btn').classList.remove('btn-danger');
        document.getElementById('connect-btn').classList.add('btn-primary');
        document.getElementById('connection-indicator').classList.remove('connected');
        document.getElementById('connection-indicator').classList.add('disconnected');
        document.getElementById('connection-text').textContent = 'Not Connected';

        this.showToast('Disconnected', 'info');
        this.renderPage(this.currentPage);
    }

    /**
     * Navigate to a page
     */
    async navigateTo(page, params = {}) {
        // Use the router to navigate
        await this.router.navigateTo(page, params);
        this.currentPage = page;
    }

    /**
     * Render a page
     */
    async renderPage(page, params = {}) {
        // Use the router to render the page
        await this.router.navigateTo(page, params);
    }

    /**
     * Refresh current page
     */
    async refreshCurrentPage() {
        // Use the router to refresh the current page
        await this.router.refreshCurrentPage();
    }

    // ==========================================
    // Setup Wizard
    // ==========================================

    async showSetupWizard() {
        const savedConfig = getSavedAppConfig();
        const redirectUri = window.location.origin;

        const html = `
            <h2><i class="fas fa-cog"></i> PIMBuddy Setup</h2>
            <p>Configure PIMBuddy to connect to your Azure AD tenant.</p>

            <div class="setup-tabs">
                <button class="setup-tab active" onclick="app.switchSetupTab('manual')">
                    <i class="fas fa-edit"></i> Manual Setup
                </button>
                <button class="setup-tab" onclick="app.switchSetupTab('instructions')">
                    <i class="fas fa-book"></i> Instructions
                </button>
            </div>

            <div id="setup-tab-manual" class="setup-tab-content active">
                <form id="manual-setup-form" onsubmit="app.saveManualConfig(event)">
                    <div class="form-group">
                        <label for="client-id">Application (Client) ID *</label>
                        <input type="text" id="client-id" class="input" required
                            placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                            value="${savedConfig?.clientId || ''}"
                            pattern="[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}">
                        <small class="form-hint">Found in Azure Portal → App registrations → Your app → Overview</small>
                    </div>

                    <div class="form-group">
                        <label for="tenant-id">Directory (Tenant) ID *</label>
                        <input type="text" id="tenant-id" class="input" required
                            placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                            value="${savedConfig?.tenantId || ''}"
                            pattern="[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}">
                        <small class="form-hint">Found in Azure Portal → Azure Active Directory → Overview</small>
                    </div>

                    <div class="setup-note">
                        <i class="fas fa-info-circle"></i>
                        <span>Your Redirect URI must be: <code>${redirectUri}</code></span>
                    </div>

                    <div id="setup-result" class="setup-result hidden"></div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                        ${savedConfig ? `
                            <button type="button" class="btn btn-secondary" onclick="app.resetSetup()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        ` : ''}
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save & Connect
                        </button>
                    </div>
                </form>
            </div>

            <div id="setup-tab-instructions" class="setup-tab-content">
                <div class="setup-instructions">
                    <h3>Step 1: Create App Registration</h3>
                    <ol>
                        <li>Go to <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank">Azure Portal → App registrations</a></li>
                        <li>Click <strong>New registration</strong></li>
                        <li>Name: <code>PIMBuddy Web</code></li>
                        <li>Supported account types: <strong>Single tenant</strong></li>
                        <li>Redirect URI: Select <strong>Single-page application (SPA)</strong> and enter:<br>
                            <code class="copyable" onclick="app.copyToClipboard('${redirectUri}')">${redirectUri}</code>
                        </li>
                        <li>Click <strong>Register</strong></li>
                    </ol>

                    <h3>Step 2: Configure API Permissions</h3>
                    <ol>
                        <li>In your new app, go to <strong>API permissions</strong></li>
                        <li>Click <strong>Add a permission</strong> → <strong>Microsoft Graph</strong> → <strong>Delegated permissions</strong></li>
                        <li>Add these permissions:
                            <ul class="permissions-list">
                                <li><code>User.Read</code></li>
                                <li><code>Group.Read.All</code></li>
                                <li><code>Group.ReadWrite.All</code></li>
                                <li><code>RoleManagement.Read.Directory</code></li>
                                <li><code>RoleManagement.ReadWrite.Directory</code></li>
                                <li><code>PrivilegedAccess.Read.AzureADGroup</code></li>
                                <li><code>PrivilegedAccess.ReadWrite.AzureADGroup</code></li>
                                <li><code>PrivilegedEligibilitySchedule.Read.AzureADGroup</code></li>
                                <li><code>PrivilegedEligibilitySchedule.ReadWrite.AzureADGroup</code></li>
                                <li><code>PrivilegedAssignmentSchedule.Read.AzureADGroup</code></li>
                                <li><code>PrivilegedAssignmentSchedule.ReadWrite.AzureADGroup</code></li>
                            </ul>
                        </li>
                        <li>Click <strong>Grant admin consent</strong> (requires admin role)</li>
                    </ol>

                    <h3>Step 3: Copy IDs</h3>
                    <ol>
                        <li>Go to <strong>Overview</strong></li>
                        <li>Copy the <strong>Application (client) ID</strong></li>
                        <li>Copy the <strong>Directory (tenant) ID</strong></li>
                        <li>Paste them in the <strong>Manual Setup</strong> tab</li>
                    </ol>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Close</button>
                    <button type="button" class="btn btn-primary" onclick="app.switchSetupTab('manual')">
                        <i class="fas fa-arrow-left"></i> Back to Setup
                    </button>
                </div>
            </div>
        `;

        this.showModal(html);
    }

    switchSetupTab(tab) {
        document.querySelectorAll('.setup-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.setup-tab-content').forEach(c => c.classList.remove('active'));

        document.querySelector(`.setup-tab-content#setup-tab-${tab}`).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            this.showToast('Copied to clipboard', 'success');
        }).catch(() => {
            this.showToast('Failed to copy', 'error');
        });
    }

    async saveManualConfig(event) {
        event.preventDefault();

        const clientId = document.getElementById('client-id').value.trim();
        const tenantId = document.getElementById('tenant-id').value.trim();
        const resultDiv = document.getElementById('setup-result');

        // Validate GUIDs
        const guidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;

        if (!guidRegex.test(clientId)) {
            resultDiv.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div>Invalid Client ID format. Must be a GUID.</div></div>`;
            resultDiv.classList.remove('hidden');
            return;
        }

        if (!guidRegex.test(tenantId)) {
            resultDiv.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div>Invalid Tenant ID format. Must be a GUID.</div></div>`;
            resultDiv.classList.remove('hidden');
            return;
        }

        // Save configuration
        const config = {
            clientId,
            tenantId,
            createdAt: new Date().toISOString()
        };

        localStorage.setItem('pimbuddy-app-config', JSON.stringify(config));

        // Update app state
        this.isConfigured = true;

        // Re-initialize auth service with new config
        try {
            await authService.reinitialize();

            resultDiv.innerHTML = `
                <div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Configuration saved!</strong>
                        <p>Click below to sign in.</p>
                    </div>
                </div>
            `;
            resultDiv.classList.remove('hidden');

            // Update connect button text
            document.getElementById('connect-text').textContent = 'Connect';
            document.getElementById('connection-text').textContent = 'Not Connected';

            // Auto-close and connect after a brief delay
            setTimeout(async () => {
                this.closeModal();
                await this.handleConnect();
            }, 1000);

        } catch (error) {
            resultDiv.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <div>
                        <strong>Configuration Error</strong>
                        <p>${error.message}</p>
                    </div>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        }
    }

    async resetSetup() {
        if (!confirm('This will clear the saved configuration. You will need to run setup again. Continue?')) {
            return;
        }

        clearAppConfig();
        this.isConfigured = false;

        // Clear auth state
        authService.msalInstance = null;
        authService.account = null;
        authService.initialized = false;

        this.closeModal();
        this.showToast('Configuration cleared', 'info');
        this.showSetupRequired();
        this.renderPage(this.currentPage);
    }

    // ==========================================
    // Page Renderers
    // ==========================================

    renderLandingPage(container) {
        container.innerHTML = `
            <!-- Hero Section -->
            <div style="text-align: center; padding: var(--space-xl) 0; max-width: 1200px; margin: 0 auto;">
                <div style="display: inline-flex; align-items: center; justify-content: center; width: 120px; height: 120px; background: linear-gradient(135deg, var(--accent-primary-dim), var(--accent-secondary-dim)); border-radius: 30px; margin-bottom: var(--space-lg); box-shadow: 0 20px 60px rgba(0, 212, 170, 0.3);">
                    <i class="fas fa-shield-alt" style="font-size: 4rem; color: var(--accent-primary);"></i>
                </div>

                <h1 style="font-family: var(--font-display); font-size: 3.5rem; font-weight: 800; margin-bottom: var(--space-md); background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    Welcome to PIMBuddy
                </h1>

                <p style="font-size: 1.3rem; color: var(--text-secondary); max-width: 700px; margin: 0 auto var(--space-xl);">
                    Your complete solution for Microsoft Entra PIM management. Deploy, monitor, and secure privileged access with enterprise-grade tools.
                </p>

                <button class="btn btn-primary" onclick="document.getElementById('connect-btn').click()" style="font-size: 1.1rem; padding: var(--space-md) var(--space-xl); box-shadow: 0 10px 30px rgba(0, 212, 170, 0.3);">
                    <i class="fas fa-plug"></i> Connect to Get Started
                </button>
            </div>

            <!-- Key Stats -->
            <div class="stats-grid" style="margin-bottom: var(--space-xl);">
                <div class="card stat-card" style="border-color: var(--accent-primary-dim);">
                    <div class="stat-icon primary">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="stat-value">5</div>
                    <div class="stat-label">Monitoring Tools</div>
                </div>
                <div class="card stat-card" style="border-color: var(--accent-secondary-dim);">
                    <div class="stat-icon secondary">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <div class="stat-value">3</div>
                    <div class="stat-label">Baseline Templates</div>
                </div>
                <div class="card stat-card" style="border-color: var(--color-success-dim);">
                    <div class="stat-icon success">
                        <i class="fas fa-shield-check"></i>
                    </div>
                    <div class="stat-value">100%</div>
                    <div class="stat-label">Zero Trust Ready</div>
                </div>
            </div>

            <!-- Core Features -->
            <h2 style="font-family: var(--font-display); font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: var(--space-lg);">
                <i class="fas fa-stars" style="color: var(--accent-primary);"></i> Core Features
            </h2>

            <div class="dashboard-grid" style="margin-bottom: var(--space-xl);">
                <!-- Baseline Deployment -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--accent-primary-dim);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--accent-primary-dim); border-radius: var(--radius-lg);">
                            <i class="fas fa-rocket" style="font-size: 1.8rem; color: var(--accent-primary);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">Baseline Deployment</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">One-Click PIM Setup</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Deploy complete PIM configurations instantly with industry best practices. Choose from Enterprise Standard, High Security (Zero Trust), or Quick Start templates.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-primary"><i class="fas fa-check"></i> Tiered Access (T0/T1/T2)</span>
                        <span class="badge badge-success"><i class="fas fa-check"></i> MFA Required</span>
                        <span class="badge badge-info"><i class="fas fa-check"></i> Approval Workflows</span>
                        <span class="badge badge-warning"><i class="fas fa-check"></i> Auto-Configuration</span>
                    </div>
                </div>

                <!-- PIM Health Check -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--color-success-dim);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--color-success-dim); border-radius: var(--radius-lg);">
                            <i class="fas fa-heart-pulse" style="font-size: 1.8rem; color: var(--color-success);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">Health Check Scanner</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Security Analysis</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Automated security scanner that analyzes your PIM configuration. Get a health score (0-100%) and actionable recommendations to improve security.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-success"><i class="fas fa-search"></i> Auto-Scan</span>
                        <span class="badge badge-primary"><i class="fas fa-chart-line"></i> Health Score</span>
                        <span class="badge badge-warning"><i class="fas fa-exclamation-triangle"></i> Issue Detection</span>
                        <span class="badge badge-info"><i class="fas fa-lightbulb"></i> Recommendations</span>
                    </div>
                </div>

                <!-- Activity Monitoring -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--accent-secondary-dim);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--accent-secondary-dim); border-radius: var(--radius-lg);">
                            <i class="fas fa-history" style="font-size: 1.8rem; color: var(--accent-secondary);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">PIM Activity Log</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Audit & Compliance</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Complete audit trail of all PIM role management activities. Track who did what, when, and why with detailed activity logs and filtering.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-secondary"><i class="fas fa-calendar"></i> 30-Day History</span>
                        <span class="badge badge-info"><i class="fas fa-filter"></i> Advanced Filtering</span>
                        <span class="badge badge-primary"><i class="fas fa-download"></i> Export Logs</span>
                    </div>
                </div>

                <!-- Approval Management -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--color-warning-dim);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--color-warning-dim); border-radius: var(--radius-lg);">
                            <i class="fas fa-clock" style="font-size: 1.8rem; color: var(--color-warning);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">Pending Approvals</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Request Management</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Manage PIM activation requests in one place. Review justifications, approve or deny requests, and maintain compliance with one-click actions.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-success"><i class="fas fa-check"></i> Quick Approve</span>
                        <span class="badge badge-danger"><i class="fas fa-times"></i> Quick Deny</span>
                        <span class="badge badge-info"><i class="fas fa-comment"></i> Justification View</span>
                    </div>
                </div>

                <!-- Expiring Assignments -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid rgba(245, 158, 11, 0.2);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--color-warning-dim); border-radius: var(--radius-lg);">
                            <i class="fas fa-hourglass-end" style="font-size: 1.8rem; color: var(--color-warning);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">Expiring Assignments</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Lifecycle Management</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Track role assignments expiring within 7 days. Proactive monitoring prevents access loss and ensures continuous operations.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-warning"><i class="fas fa-bell"></i> 7-Day Alerts</span>
                        <span class="badge badge-primary"><i class="fas fa-clock"></i> Time Remaining</span>
                        <span class="badge badge-info"><i class="fas fa-list"></i> Full Tracking</span>
                    </div>
                </div>

                <!-- Role Coverage -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.15); border-radius: var(--radius-lg);">
                            <i class="fas fa-chart-pie" style="font-size: 1.8rem; color: var(--color-info);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">Role Coverage Report</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Analytics Dashboard</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Analyze which roles are managed through PIM groups vs direct assignments. Visual reports help identify gaps and improve governance.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-info"><i class="fas fa-chart-pie"></i> Visual Reports</span>
                        <span class="badge badge-primary"><i class="fas fa-percent"></i> Coverage %</span>
                        <span class="badge badge-warning"><i class="fas fa-flag"></i> Gap Analysis</span>
                    </div>
                </div>
            </div>

            <!-- Additional Features -->
            <h2 style="font-family: var(--font-display); font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: var(--space-lg);">
                <i class="fas fa-toolbox" style="color: var(--accent-primary);"></i> Additional Tools
            </h2>

            <div class="dashboard-grid" style="margin-bottom: var(--space-xl);">
                <!-- PIMMaid -->
                <div class="card">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                        <div class="stat-icon primary">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <h3 style="font-size: 1.2rem; font-weight: 700; margin: 0;">PIMMaid Visualizer</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-sm);">
                        Export your PIM configuration as beautiful Mermaid diagrams. Visualize relationships between users, groups, and roles.
                    </p>
                    <span class="badge badge-secondary"><i class="fas fa-sitemap"></i> Visual Diagrams</span>
                </div>

                <!-- Group Management -->
                <div class="card">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                        <div class="stat-icon success">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 style="font-size: 1.2rem; font-weight: 700; margin: 0;">Group Management</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-sm);">
                        Create and manage role-assignable security groups. Add/remove members with an intuitive interface.
                    </p>
                    <span class="badge badge-success"><i class="fas fa-user-plus"></i> Member Management</span>
                </div>

                <!-- Role Explorer -->
                <div class="card">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                        <div class="stat-icon warning">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <h3 style="font-size: 1.2rem; font-weight: 700; margin: 0;">Entra Roles Explorer</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-sm);">
                        Browse all Azure AD roles with privilege levels. Search, filter, and understand role permissions.
                    </p>
                    <span class="badge badge-warning"><i class="fas fa-shield-alt"></i> Privilege Levels</span>
                </div>

                <!-- Import/Export -->
                <div class="card">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                        <div class="stat-icon info">
                            <i class="fas fa-file-export"></i>
                        </div>
                        <h3 style="font-size: 1.2rem; font-weight: 700; margin: 0;">Import/Export</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-sm);">
                        Export configurations for backup or compliance. Import templates to replicate setups across tenants.
                    </p>
                    <span class="badge badge-info"><i class="fas fa-download"></i> Backup & Restore</span>
                </div>
            </div>

            <!-- Call to Action -->
            <div class="card" style="background: linear-gradient(135deg, var(--accent-primary-dim), var(--accent-secondary-dim)); border: 2px solid var(--accent-primary); text-align: center; padding: var(--space-xl);">
                <h2 style="font-size: 2rem; font-weight: 800; margin-bottom: var(--space-md);">
                    Ready to Transform Your PIM Management?
                </h2>
                <p style="font-size: 1.1rem; color: var(--text-secondary); margin-bottom: var(--space-lg); max-width: 600px; margin-left: auto; margin-right: auto;">
                    Connect to your Microsoft Entra ID tenant and start managing privileged access with enterprise-grade tools in minutes.
                </p>
                <button class="btn btn-primary" onclick="document.getElementById('connect-btn').click()" style="font-size: 1.2rem; padding: var(--space-md) var(--space-xl); box-shadow: 0 10px 30px rgba(0, 212, 170, 0.4);">
                    <i class="fas fa-plug"></i> Connect Now
                </button>
            </div>

            <!-- Footer Info -->
            <div style="text-align: center; margin-top: var(--space-xl); padding: var(--space-lg); color: var(--text-muted);">
                <p style="margin-bottom: var(--space-sm);">
                    <i class="fas fa-shield-check" style="color: var(--accent-primary);"></i>
                    Built with enterprise security in mind
                </p>
                <p style="font-size: 0.9rem;">
                    PIMBuddy v1.0.0 | Powered by Microsoft Graph API | Zero Trust Ready
                </p>
            </div>
        `;
    }

    async renderDashboard(container) {
        // Show landing page if not connected
        if (!this.isConnected) {
            this.renderLandingPage(container);
            return;
        }

        let stats = {
            totalGroups: 0,
            eligibleAssignments: 0,
            activeAssignments: 0,
            pendingApprovals: 0,
            expiringAssignments: 0,
            healthScore: 0,
            healthStatus: 'unknown'
        };

        let recentActivities = [];
        let expiringList = [];
        let healthWarnings = [];

        if (this.isConnected) {
            this.showLoading('Loading dashboard data...');
            try {
                // Load all data in parallel
                const [groupsResult, assignmentsResult, approvalsResult, healthResult, auditResult] = await Promise.all([
                    graphService.getPIMGroups(),
                    graphService.getRoleAssignmentsWithExpiration(),
                    graphService.getPendingApprovals(),
                    graphService.runHealthCheck(),
                    graphService.getPIMAuditLogs(7)
                ]);

                if (groupsResult.success) {
                    stats.totalGroups = groupsResult.count;
                }

                if (assignmentsResult.success) {
                    stats.activeAssignments = assignmentsResult.activeCount;
                    stats.eligibleAssignments = assignmentsResult.eligibleCount;
                    stats.expiringAssignments = assignmentsResult.expiringCount;
                    expiringList = assignmentsResult.expiringAssignments.slice(0, 5);
                }

                if (approvalsResult.success) {
                    stats.pendingApprovals = approvalsResult.count;
                }

                if (healthResult.success) {
                    stats.healthScore = healthResult.healthScore;
                    stats.healthStatus = healthResult.status;
                    healthWarnings = healthResult.warnings || [];
                }

                if (auditResult.success) {
                    recentActivities = auditResult.logs.slice(0, 5);
                }
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
            this.hideLoading();
        }

        const setupMessage = !this.isConfigured ? `
            <div class="setup-banner">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Setup Required</strong>
                    <p>Click the <strong>Setup</strong> button in the sidebar to configure PIMBuddy for your tenant.</p>
                </div>
                <button class="btn btn-primary btn-sm" onclick="app.showSetupWizard()">Run Setup</button>
            </div>
        ` : '';

        const getHealthColor = (status) => {
            switch(status) {
                case 'healthy': return 'success';
                case 'warning': return 'warning';
                case 'critical': return 'danger';
                default: return 'secondary';
            }
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString();
        };

        const formatRelativeTime = (dateStr) => {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = date - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            if (days > 0) return `in ${days}d ${hours}h`;
            if (hours > 0) return `in ${hours}h`;
            return 'soon';
        };

        container.innerHTML = `
            <!-- Dramatic Dashboard Header -->
            <div style="position: relative; margin-bottom: var(--space-2xl); overflow: hidden;">
                <div style="position: absolute; top: -100%; right: -10%; width: 400px; height: 400px; background: radial-gradient(circle, var(--accent-primary-dim), transparent); filter: blur(100px); animation: float 12s ease-in-out infinite;"></div>

                <div style="position: relative; z-index: 1;">
                    <div style="display: inline-flex; align-items: center; gap: var(--space-xs); padding: var(--space-xs) var(--space-md); background: rgba(0, 255, 159, 0.05); border: 1px solid var(--accent-primary); border-radius: var(--radius-full); margin-bottom: var(--space-md); font-family: var(--font-mono); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.15em;">
                        <span style="width: 6px; height: 6px; background: var(--accent-primary); border-radius: 50%; box-shadow: 0 0 10px var(--accent-primary); animation: pulse 2s ease-in-out infinite;"></span>
                        <span style="color: var(--accent-primary); font-weight: 600;">SYSTEM STATUS</span>
                        <span style="color: var(--text-muted);">|</span>
                        <span style="color: var(--text-secondary);">REALTIME MONITORING</span>
                    </div>

                    <h1 style="font-family: var(--font-display); font-size: clamp(2rem, 4vw, 3.5rem); font-weight: 800; line-height: 1.1; margin-bottom: var(--space-sm); letter-spacing: -0.03em;">
                        <span style="background: linear-gradient(135deg, var(--accent-primary), #00ffff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 30px rgba(0, 255, 159, 0.3));">
                            COMMAND
                        </span>
                        <span style="color: var(--text-primary);"> CENTER</span>
                    </h1>
                    <p style="font-size: 0.95rem; color: var(--text-secondary); font-family: var(--font-mono);">
                        Privileged Access Management Overview
                    </p>
                </div>
            </div>

            ${setupMessage}

            <!-- Dramatic Stats Grid -->
            <div class="stats-grid" style="margin-bottom: var(--space-2xl);">
                <!-- Health Score - Hero Card -->
                <div class="card stat-card ${stats.healthScore > 0 ? 'clickable' : ''}"
                     onclick="${stats.healthScore > 0 ? 'app.navigateTo(\'health-check\')' : ''}"
                     style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 2px solid ${stats.healthStatus === 'healthy' ? 'var(--accent-primary)' : stats.healthStatus === 'warning' ? 'var(--color-warning)' : 'var(--color-error)'};">
                    <div style="position: absolute; inset: 0; background: radial-gradient(circle at top right, ${stats.healthStatus === 'healthy' ? 'var(--accent-primary-dim)' : stats.healthStatus === 'warning' ? 'rgba(255, 170, 0, 0.1)' : 'rgba(255, 0, 85, 0.1)'}, transparent); filter: blur(40px);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="width: 64px; height: 64px; background: ${stats.healthStatus === 'healthy' ? 'var(--accent-primary-dim)' : stats.healthStatus === 'warning' ? 'var(--color-warning-dim)' : 'rgba(255, 0, 85, 0.1)'}; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-md); box-shadow: 0 0 30px ${stats.healthStatus === 'healthy' ? 'rgba(0, 255, 159, 0.3)' : stats.healthStatus === 'warning' ? 'rgba(255, 170, 0, 0.3)' : 'rgba(255, 0, 85, 0.3)'};">
                            <i class="fas fa-heart-pulse" style="font-size: 2rem; color: ${stats.healthStatus === 'healthy' ? 'var(--accent-primary)' : stats.healthStatus === 'warning' ? 'var(--color-warning)' : 'var(--color-error)'};"></i>
                        </div>
                        <div style="font-family: var(--font-display); font-size: 3rem; font-weight: 800; line-height: 1; margin-bottom: var(--space-xs); background: linear-gradient(135deg, ${stats.healthStatus === 'healthy' ? 'var(--accent-primary), #00ffff' : stats.healthStatus === 'warning' ? 'var(--color-warning), #ffdd00' : 'var(--color-error), #ff0099'}); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            ${stats.healthScore}%
                        </div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); font-family: var(--font-mono); margin-bottom: var(--space-xs);">HEALTH SCORE</div>
                        ${stats.healthScore > 0 ? '<div style="font-size: 0.7rem; color: var(--text-muted); font-family: var(--font-mono);">⚡ CLICK FOR ANALYSIS</div>' : ''}
                    </div>
                </div>

                <!-- Other Stat Cards -->
                <div class="card stat-card" style="position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 50%; right: -20%; width: 150px; height: 150px; background: radial-gradient(circle, rgba(0, 255, 159, 0.05), transparent); filter: blur(40px);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="width: 56px; height: 56px; background: var(--accent-primary-dim); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-md);">
                            <i class="fas fa-users" style="font-size: 1.5rem; color: var(--accent-primary);"></i>
                        </div>
                        <div style="font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: var(--space-xs); color: var(--text-primary);">
                            ${stats.totalGroups}
                        </div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); font-family: var(--font-mono);">PIM GROUPS</div>
                    </div>
                </div>

                <div class="card stat-card" style="position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 50%; right: -20%; width: 150px; height: 150px; background: radial-gradient(circle, rgba(255, 0, 128, 0.05), transparent); filter: blur(40px);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="width: 56px; height: 56px; background: var(--accent-secondary-dim); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-md);">
                            <i class="fas fa-user-check" style="font-size: 1.5rem; color: var(--accent-secondary);"></i>
                        </div>
                        <div style="font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: var(--space-xs); color: var(--text-primary);">
                            ${stats.eligibleAssignments}
                        </div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); font-family: var(--font-mono);">ELIGIBLE</div>
                    </div>
                </div>

                <div class="card stat-card" style="position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 50%; right: -20%; width: 150px; height: 150px; background: radial-gradient(circle, rgba(0, 255, 159, 0.05), transparent); filter: blur(40px);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="width: 56px; height: 56px; background: var(--color-success-dim); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-md);">
                            <i class="fas fa-user-shield" style="font-size: 1.5rem; color: var(--color-success);"></i>
                        </div>
                        <div style="font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: var(--space-xs); color: var(--text-primary);">
                            ${stats.activeAssignments}
                        </div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); font-family: var(--font-mono);">ACTIVE</div>
                    </div>
                </div>

                <div class="card stat-card ${stats.expiringAssignments > 0 ? 'clickable' : ''}"
                     onclick="${stats.expiringAssignments > 0 ? 'app.navigateTo(\'expiring-assignments\')' : ''}"
                     style="position: relative; overflow: hidden; ${stats.expiringAssignments > 0 ? 'border: 1px solid var(--color-warning);' : ''}">
                    <div style="position: absolute; top: 50%; right: -20%; width: 150px; height: 150px; background: radial-gradient(circle, rgba(255, 170, 0, 0.05), transparent); filter: blur(40px);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="width: 56px; height: 56px; background: ${stats.expiringAssignments > 0 ? 'var(--color-warning-dim)' : 'var(--bg-elevated)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-md);">
                            <i class="fas fa-hourglass-end" style="font-size: 1.5rem; color: ${stats.expiringAssignments > 0 ? 'var(--color-warning)' : 'var(--text-muted)'};"></i>
                        </div>
                        <div style="font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: var(--space-xs); color: ${stats.expiringAssignments > 0 ? 'var(--color-warning)' : 'var(--text-primary)'};">
                            ${stats.expiringAssignments}
                        </div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); font-family: var(--font-mono);">EXPIRING</div>
                        ${stats.expiringAssignments > 0 ? '<div style="font-size: 0.7rem; color: var(--text-muted); font-family: var(--font-mono);">⚡ CLICK TO VIEW</div>' : ''}
                    </div>
                </div>

                <div class="card stat-card ${stats.pendingApprovals > 0 ? 'clickable' : ''}"
                     onclick="${stats.pendingApprovals > 0 ? 'app.navigateTo(\'pending-approvals\')' : ''}"
                     style="position: relative; overflow: hidden; ${stats.pendingApprovals > 0 ? 'border: 1px solid var(--color-warning);' : ''}">
                    <div style="position: absolute; top: 50%; right: -20%; width: 150px; height: 150px; background: radial-gradient(circle, rgba(255, 170, 0, 0.05), transparent); filter: blur(40px);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="width: 56px; height: 56px; background: ${stats.pendingApprovals > 0 ? 'var(--color-warning-dim)' : 'var(--bg-elevated)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-md);">
                            <i class="fas fa-clock" style="font-size: 1.5rem; color: ${stats.pendingApprovals > 0 ? 'var(--color-warning)' : 'var(--text-muted)'};"></i>
                        </div>
                        <div style="font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: var(--space-xs); color: ${stats.pendingApprovals > 0 ? 'var(--color-warning)' : 'var(--text-primary)'};">
                            ${stats.pendingApprovals}
                        </div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); font-family: var(--font-mono);">APPROVALS</div>
                        ${stats.pendingApprovals > 0 ? '<div style="font-size: 0.7rem; color: var(--text-muted); font-family: var(--font-mono);">⚡ CLICK TO REVIEW</div>' : ''}
                    </div>
                </div>
            </div>

            <!-- Dashboard Grid with Asymmetric Layout -->
            <div class="dashboard-grid">
                <!-- Quick Actions - Cyberpunk Panel -->
                <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--border-subtle);">
                    <div style="position: absolute; top: -50%; right: -20%; width: 250px; height: 250px; background: radial-gradient(circle, var(--accent-primary-dim), transparent); filter: blur(60px);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 1px solid var(--border-subtle);">
                            <div style="width: 40px; height: 40px; background: var(--accent-primary-dim); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-bolt" style="color: var(--accent-primary); font-size: 1.2rem;"></i>
                            </div>
                            <h2 style="font-family: var(--font-display); font-size: 1.3rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                Quick Actions
                            </h2>
                        </div>
                        <div class="quick-actions" style="display: flex; flex-direction: column; gap: var(--space-sm);">
                            <button class="btn btn-primary btn-block" onclick="app.navigateTo('baseline')" ${!this.isConnected ? 'disabled' : ''} style="position: relative; overflow: hidden; text-align: left; justify-content: flex-start; gap: var(--space-md);">
                                <i class="fas fa-rocket"></i>
                                <span>Deploy Baseline Configuration</span>
                            </button>
                            <button class="btn btn-secondary btn-block" onclick="app.navigateTo('health-check')" ${!this.isConnected ? 'disabled' : ''} style="text-align: left; justify-content: flex-start; gap: var(--space-md);">
                                <i class="fas fa-heart-pulse"></i>
                                <span>Run Security Health Scan</span>
                            </button>
                            <button class="btn btn-secondary btn-block" onclick="app.navigateTo('pim-activity')" ${!this.isConnected ? 'disabled' : ''} style="text-align: left; justify-content: flex-start; gap: var(--space-md);">
                                <i class="fas fa-history"></i>
                                <span>View Audit Activity Log</span>
                            </button>
                            <button class="btn btn-secondary btn-block" onclick="app.navigateTo('role-coverage')" ${!this.isConnected ? 'disabled' : ''} style="text-align: left; justify-content: flex-start; gap: var(--space-md);">
                                <i class="fas fa-chart-pie"></i>
                                <span>Analyze Coverage Report</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Health Warnings - Alert Panel -->
                <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid ${healthWarnings.length > 0 ? 'var(--color-warning)' : 'var(--border-subtle)'};">
                    <div style="position: absolute; top: -50%; left: -20%; width: 250px; height: 250px; background: radial-gradient(circle, ${healthWarnings.length > 0 ? 'rgba(255, 170, 0, 0.05)' : 'var(--accent-secondary-dim)'}, transparent); filter: blur(60px);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 1px solid var(--border-subtle);">
                            <div style="width: 40px; height: 40px; background: ${healthWarnings.length > 0 ? 'var(--color-warning-dim)' : 'var(--accent-secondary-dim)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                <i class="fas ${healthWarnings.length > 0 ? 'fa-exclamation-triangle' : 'fa-shield-check'}" style="color: ${healthWarnings.length > 0 ? 'var(--color-warning)' : 'var(--accent-secondary)'}; font-size: 1.2rem;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h2 style="font-family: var(--font-display); font-size: 1.3rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Alerts & Warnings
                                </h2>
                            </div>
                            ${healthWarnings.length > 0 ? `<span class="badge" style="background: var(--color-warning-dim); color: var(--color-warning); font-family: var(--font-mono); font-size: 0.7rem;">${healthWarnings.length}</span>` : ''}
                        </div>
                        <div class="recommendations-list" style="max-height: 300px; overflow-y: auto;">
                            ${healthWarnings.length > 0 ? healthWarnings.map(w => `
                                <div style="padding: var(--space-md); margin-bottom: var(--space-sm); background: rgba(255, 170, 0, 0.05); border-left: 3px solid ${w.severity === 'warning' ? 'var(--color-warning)' : 'var(--color-info)'}; border-radius: var(--radius-sm);">
                                    <div style="display: flex; align-items: start; gap: var(--space-sm);">
                                        <i class="fas ${w.severity === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}" style="color: ${w.severity === 'warning' ? 'var(--color-warning)' : 'var(--color-info)'}; margin-top: 2px;"></i>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-family: var(--font-mono); font-size: 0.8rem; text-transform: uppercase; color: ${w.severity === 'warning' ? 'var(--color-warning)' : 'var(--color-info)'}; margin-bottom: var(--space-xs);">
                                                ${this.escapeHtml(w.category)}
                                            </div>
                                            <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                                                ${this.escapeHtml(w.message)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : `
                                <div style="text-align: center; padding: var(--space-2xl); color: var(--text-secondary);">
                                    <div style="width: 80px; height: 80px; margin: 0 auto var(--space-lg); background: var(--accent-primary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-shield-check" style="font-size: 2.5rem; color: var(--accent-primary);"></i>
                                    </div>
                                    <div style="font-family: var(--font-display); font-size: 1.2rem; font-weight: 700; margin-bottom: var(--space-xs); color: var(--text-primary);">
                                        All Systems Operational
                                    </div>
                                    <div style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted);">
                                        No security issues detected
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>

                <!-- Recent Activity - Data Stream Panel -->
                <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--border-subtle);">
                    <div style="position: absolute; bottom: -50%; left: -20%; width: 250px; height: 250px; background: radial-gradient(circle, var(--accent-secondary-dim), transparent); filter: blur(60px);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 1px solid var(--border-subtle);">
                            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                <div style="width: 40px; height: 40px; background: var(--accent-secondary-dim); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-history" style="color: var(--accent-secondary); font-size: 1.2rem;"></i>
                                </div>
                                <h2 style="font-family: var(--font-display); font-size: 1.3rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Recent Activity
                                </h2>
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="app.navigateTo('pim-activity')" ${!this.isConnected ? 'disabled' : ''} style="font-family: var(--font-mono); font-size: 0.7rem;">
                                VIEW ALL →
                            </button>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${recentActivities.length > 0 ? recentActivities.map((activity, idx) => `
                                <div style="padding: var(--space-md); margin-bottom: var(--space-xs); background: ${idx % 2 === 0 ? 'rgba(255, 0, 128, 0.02)' : 'rgba(0, 255, 159, 0.02)'}; border-left: 2px solid ${idx % 2 === 0 ? 'var(--accent-secondary)' : 'var(--accent-primary)'}; border-radius: var(--radius-sm);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: var(--space-md);">
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: var(--space-xs); color: var(--text-primary); overflow: hidden; text-overflow: ellipsis;">
                                                ${this.escapeHtml(activity.activityDisplayName || 'Activity')}
                                            </div>
                                            <div style="display: flex; align-items: center; gap: var(--space-xs); font-size: 0.8rem; color: var(--text-secondary); font-family: var(--font-mono);">
                                                <i class="fas fa-user" style="font-size: 0.7rem;"></i>
                                                <span>${this.escapeHtml(activity.initiatedBy?.user?.displayName || 'System')}</span>
                                            </div>
                                        </div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono); white-space: nowrap;">
                                            ${formatDate(activity.activityDateTime)}
                                        </div>
                                    </div>
                                </div>
                            `).join('') : `
                                <div style="text-align: center; padding: var(--space-2xl); color: var(--text-secondary);">
                                    <div style="width: 80px; height: 80px; margin: 0 auto var(--space-lg); background: var(--accent-secondary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-inbox" style="font-size: 2.5rem; color: var(--accent-secondary); opacity: 0.5;"></i>
                                    </div>
                                    <div style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted);">
                                        ${this.isConnected ? 'No recent activity detected' : 'Connect to view activity stream'}
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>

                <!-- Expiring Assignments - Warning Panel -->
                <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid ${expiringList.length > 0 ? 'var(--color-warning)' : 'var(--border-subtle)'};">
                    <div style="position: absolute; bottom: -50%; right: -20%; width: 250px; height: 250px; background: radial-gradient(circle, ${expiringList.length > 0 ? 'rgba(255, 170, 0, 0.05)' : 'var(--accent-primary-dim)'}, transparent); filter: blur(60px);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 1px solid var(--border-subtle);">
                            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                <div style="width: 40px; height: 40px; background: ${expiringList.length > 0 ? 'var(--color-warning-dim)' : 'var(--accent-primary-dim)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-hourglass-end" style="color: ${expiringList.length > 0 ? 'var(--color-warning)' : 'var(--accent-primary)'}; font-size: 1.2rem;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h2 style="font-family: var(--font-display); font-size: 1.3rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                        Expiring Soon
                                    </h2>
                                </div>
                                ${expiringList.length > 0 ? `<span class="badge" style="background: var(--color-warning-dim); color: var(--color-warning); font-family: var(--font-mono); font-size: 0.7rem;">${expiringList.length}</span>` : ''}
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="app.navigateTo('expiring-assignments')" ${!this.isConnected || expiringList.length === 0 ? 'disabled' : ''} style="font-family: var(--font-mono); font-size: 0.7rem;">
                                VIEW ALL →
                            </button>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${expiringList.length > 0 ? expiringList.map(assignment => `
                                <div style="padding: var(--space-md); margin-bottom: var(--space-sm); background: rgba(255, 170, 0, 0.05); border-left: 3px solid var(--color-warning); border-radius: var(--radius-sm);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: var(--space-md);">
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: var(--space-xs); color: var(--text-primary);">
                                                ${this.escapeHtml(assignment.principal?.displayName || 'Unknown')}
                                            </div>
                                            <div style="display: flex; align-items: center; gap: var(--space-xs); font-size: 0.8rem; color: var(--text-secondary); flex-wrap: wrap;">
                                                <span style="font-family: var(--font-mono);">${this.escapeHtml(assignment.roleDefinition?.displayName || 'Unknown Role')}</span>
                                                <span class="badge" style="background: ${assignment.type === 'active' ? 'var(--color-success-dim)' : 'var(--bg-elevated)'}; color: ${assignment.type === 'active' ? 'var(--color-success)' : 'var(--text-secondary)'}; font-size: 0.7rem; text-transform: uppercase;">
                                                    ${assignment.type}
                                                </span>
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--space-xs); font-size: 0.8rem; color: var(--color-warning); font-family: var(--font-mono); white-space: nowrap; font-weight: 600;">
                                            <i class="fas fa-clock" style="font-size: 0.7rem;"></i>
                                            <span>${formatRelativeTime(assignment.endDateTime)}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : `
                                <div style="text-align: center; padding: var(--space-2xl); color: var(--text-secondary);">
                                    <div style="width: 80px; height: 80px; margin: 0 auto var(--space-lg); background: var(--accent-primary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-check-circle" style="font-size: 2.5rem; color: var(--accent-primary);"></i>
                                    </div>
                                    <div style="font-family: var(--font-display); font-size: 1.2rem; font-weight: 700; margin-bottom: var(--space-xs); color: var(--text-primary);">
                                        All Clear
                                    </div>
                                    <div style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted);">
                                        ${this.isConnected ? 'No assignments expiring within 7 days' : 'Connect to monitor expiring assignments'}
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async renderGroups(container) {
        let allGroups = [];

        if (this.isConnected) {
            this.showLoading('Loading groups...');

            if (!this.cache.groups) {
                const result = await graphService.getPIMGroups();
                if (result.success) {
                    this.cache.groups = result.groups;
                }
            }
            allGroups = this.cache.groups || [];

            this.hideLoading();
        }

        // Update paginator with all groups
        this.paginators.groups.updateItems(allGroups);

        // Get current page items
        const groups = this.paginators.groups.getCurrentPageItems();

        container.innerHTML = `
            <div class="page-header-row">
                <h1 class="page-header">PIM Groups</h1>
                <button class="btn btn-primary" onclick="app.showCreateGroup()" ${!this.isConnected ? 'disabled' : ''}>
                    <i class="fas fa-plus"></i> Create Group
                </button>
            </div>

            <div class="toolbar">
                <input type="text" id="group-search" class="input" placeholder="Search groups..." oninput="app.filterGroups(this.value)">
                <button class="btn btn-secondary" onclick="app.showExportMenu('groups')" ${!this.isConnected || allGroups.length === 0 ? 'disabled' : ''}>
                    <i class="fas fa-file-export"></i> Export
                </button>
                <button class="btn btn-secondary" onclick="app.refreshGroups()" ${!this.isConnected ? 'disabled' : ''}>
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>

            <div class="card">
                <table class="data-table" id="groups-table">
                    <thead>
                        <tr>
                            <th>Display Name</th>
                            <th>Description</th>
                            <th>Members</th>
                            <th>Owners</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${groups.length > 0 ? groups.map(g => `
                            <tr data-id="${g.id}">
                                <td><strong>${this.escapeHtml(g.displayName)}</strong></td>
                                <td>${this.escapeHtml(g.description || '-')}</td>
                                <td>${g.memberCount || 0}</td>
                                <td>${g.ownerCount || 0}</td>
                                <td>${g.createdDateTime ? new Date(g.createdDateTime).toLocaleDateString() : '-'}</td>
                                <td>
                                    <button class="icon-btn" onclick="app.manageGroup('${g.id}')" title="Manage">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <button class="icon-btn danger" onclick="app.deleteGroup('${g.id}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('') : `
                            <tr>
                                <td colspan="6" class="empty-state">
                                    ${this.isConnected ? 'No PIM groups found' : 'Connect to view groups'}
                                </td>
                            </tr>
                        `}
                    </tbody>
                </table>

                ${this.paginators.groups.renderControls('app.handleGroupsPageChange')}
            </div>
        `;
    }

    async renderRoles(container) {
        let allRoles = [];
        this.roleSortOrder = this.roleSortOrder || 'privilege-desc';

        if (this.isConnected) {
            this.showLoading('Loading roles...');

            if (!this.cache.roles) {
                const result = await graphService.getRoleDefinitions();
                if (result.success) {
                    this.cache.roles = result.roles;
                }
            }
            allRoles = this.cache.roles || [];

            // Sort roles by privilege level
            allRoles = this.sortRolesByPrivilege(allRoles, this.roleSortOrder);

            this.hideLoading();
        }

        // Update paginator with all roles
        this.paginators.roles.updateItems(allRoles);

        // Get current page items
        const roles = this.paginators.roles.getCurrentPageItems();

        const privilegeBadge = (level) => {
            const config = {
                critical: { class: 'badge-critical', icon: 'fa-skull-crossbones', label: 'Critical' },
                high: { class: 'badge-high', icon: 'fa-exclamation-triangle', label: 'High' },
                medium: { class: 'badge-medium', icon: 'fa-shield-alt', label: 'Medium' },
                low: { class: 'badge-low', icon: 'fa-check-circle', label: 'Low' }
            };
            const c = config[level] || config.low;
            return `<span class="badge privilege-badge ${c.class}"><i class="fas ${c.icon}"></i> ${c.label}</span>`;
        };

        container.innerHTML = `
            <div class="page-header-row">
                <h1 class="page-header">Entra ID Roles</h1>
            </div>

            <div class="toolbar">
                <input type="text" id="role-search" class="input" placeholder="Search roles..." oninput="app.filterRoles(this.value)">
                <select id="role-sort" class="input input-select" onchange="app.sortRoles(this.value)">
                    <option value="privilege-desc" ${this.roleSortOrder === 'privilege-desc' ? 'selected' : ''}>Privilege: High to Low</option>
                    <option value="privilege-asc" ${this.roleSortOrder === 'privilege-asc' ? 'selected' : ''}>Privilege: Low to High</option>
                    <option value="name-asc" ${this.roleSortOrder === 'name-asc' ? 'selected' : ''}>Name: A to Z</option>
                    <option value="name-desc" ${this.roleSortOrder === 'name-desc' ? 'selected' : ''}>Name: Z to A</option>
                </select>
                <button class="btn btn-secondary" onclick="app.showExportMenu('roles')" ${!this.isConnected || allRoles.length === 0 ? 'disabled' : ''}>
                    <i class="fas fa-file-export"></i> Export
                </button>
                <button class="btn btn-secondary" onclick="app.refreshRoles()" ${!this.isConnected ? 'disabled' : ''}>
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>

            <div class="card">
                <table class="data-table" id="roles-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="app.sortRoles('name')">Role Name <i class="fas fa-sort"></i></th>
                            <th>Description</th>
                            <th class="sortable" onclick="app.sortRoles('privilege')">Privilege <i class="fas fa-sort"></i></th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${roles.length > 0 ? roles.map(r => `
                            <tr data-id="${r.id}" data-privilege="${r.privilegeLevel}">
                                <td><strong>${this.escapeHtml(r.displayName)}</strong></td>
                                <td class="description-cell">${this.escapeHtml((r.description || '').substring(0, 80))}${(r.description || '').length > 80 ? '...' : ''}</td>
                                <td>${privilegeBadge(r.privilegeLevel)}</td>
                                <td>${r.isBuiltIn ? '<span class="badge">Built-in</span>' : '<span class="badge badge-secondary">Custom</span>'}</td>
                                <td>
                                    <button class="icon-btn" onclick="app.configureRolePolicy('${r.id}')" title="Configure Policy">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('') : `
                            <tr>
                                <td colspan="5" class="empty-state">
                                    ${this.isConnected ? 'No roles found' : 'Connect to view roles'}
                                </td>
                            </tr>
                        `}
                    </tbody>
                </table>

                ${this.paginators.roles.renderControls('app.handleRolesPageChange')}
            </div>

            <div class="privilege-legend">
                <span class="legend-title">Privilege Levels:</span>
                <span class="badge privilege-badge badge-critical"><i class="fas fa-skull-crossbones"></i> Critical</span>
                <span class="badge privilege-badge badge-high"><i class="fas fa-exclamation-triangle"></i> High</span>
                <span class="badge privilege-badge badge-medium"><i class="fas fa-shield-alt"></i> Medium</span>
                <span class="badge privilege-badge badge-low"><i class="fas fa-check-circle"></i> Low</span>
            </div>
        `;
    }

    sortRolesByPrivilege(roles, order) {
        const privilegeOrder = { critical: 0, high: 1, medium: 2, low: 3 };

        return [...roles].sort((a, b) => {
            if (order === 'privilege-desc') {
                return privilegeOrder[a.privilegeLevel] - privilegeOrder[b.privilegeLevel];
            } else if (order === 'privilege-asc') {
                return privilegeOrder[b.privilegeLevel] - privilegeOrder[a.privilegeLevel];
            } else if (order === 'name-asc') {
                return a.displayName.localeCompare(b.displayName);
            } else if (order === 'name-desc') {
                return b.displayName.localeCompare(a.displayName);
            }
            return 0;
        });
    }

    sortRoles(order) {
        // Toggle direction if clicking same column header
        if (order === 'privilege') {
            order = this.roleSortOrder === 'privilege-desc' ? 'privilege-asc' : 'privilege-desc';
        } else if (order === 'name') {
            order = this.roleSortOrder === 'name-asc' ? 'name-desc' : 'name-asc';
        }

        this.roleSortOrder = order;
        this.renderPage('roles');
    }

    async renderPimmaid(container) {
        const diagramTypes = pimmaidService.getDiagramTypes();

        container.innerHTML = `
            <div class="page-header-row">
                <h1 class="page-header">
                    <i class="fas fa-project-diagram"></i> PIMMaid
                </h1>
                <span class="page-subtitle">Visualize PIM as Mermaid Diagrams</span>
            </div>
            <p class="page-description">Generate visual diagrams of your PIM configuration showing relationships between users, groups, and roles.</p>

            <div class="pimmaid-layout">
                <div class="pimmaid-controls card">
                    <h3><i class="fas fa-sliders-h"></i> Diagram Options</h3>

                    <div class="form-group">
                        <label>Diagram Type</label>
                        <div class="diagram-type-grid">
                            ${Object.entries(diagramTypes).map(([key, type]) => `
                                <label class="diagram-type-option ${key === 'full-hierarchy' ? 'selected' : ''}" data-type="${key}">
                                    <input type="radio" name="diagram-type" value="${key}" ${key === 'full-hierarchy' ? 'checked' : ''}>
                                    <i class="fas ${type.icon}"></i>
                                    <span class="type-name">${type.name}</span>
                                    <span class="type-desc">${type.description}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Options</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="pimmaid-eligible" checked>
                                <span>Show Eligible Assignments</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="pimmaid-active" checked>
                                <span>Show Active Assignments</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Direction</label>
                        <select id="pimmaid-direction" class="input">
                            <option value="LR">Left to Right</option>
                            <option value="TB">Top to Bottom</option>
                            <option value="RL">Right to Left</option>
                            <option value="BT">Bottom to Top</option>
                        </select>
                    </div>

                    <button class="btn btn-primary btn-block" onclick="app.generatePimmaidDiagram()" ${!this.isConnected ? 'disabled' : ''}>
                        <i class="fas fa-magic"></i> Generate Diagram
                    </button>

                    <div id="pimmaid-stats" class="pimmaid-stats hidden"></div>
                </div>

                <div class="pimmaid-output card">
                    <div class="pimmaid-output-header">
                        <h3><i class="fas fa-code"></i> Mermaid Output</h3>
                        <div class="pimmaid-actions">
                            <button class="btn btn-sm btn-secondary" onclick="app.copyPimmaidCode()" id="copy-mermaid-btn" disabled>
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="app.downloadPimmaidCode()" id="download-mermaid-btn" disabled>
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="app.openInMermaidLive()" id="live-mermaid-btn" disabled>
                                <i class="fas fa-external-link-alt"></i> Open in Mermaid Live
                            </button>
                        </div>
                    </div>

                    <div class="pimmaid-code-container">
                        <pre id="pimmaid-code" class="pimmaid-code">${this.isConnected ? '// Click "Generate Diagram" to create your PIM visualization' : '// Connect to Azure AD to generate diagrams'}</pre>
                    </div>

                    <div class="pimmaid-preview-section">
                        <h4><i class="fas fa-eye"></i> Preview</h4>
                        <p class="preview-hint">Paste the code above into <a href="https://mermaid.live" target="_blank">Mermaid Live Editor</a> to see the rendered diagram.</p>
                        <div id="pimmaid-preview" class="pimmaid-preview">
                            <div class="empty-preview">
                                <i class="fas fa-project-diagram"></i>
                                <p>Diagram preview will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add event listeners for diagram type selection
        document.querySelectorAll('.diagram-type-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.diagram-type-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                option.querySelector('input').checked = true;
            });
        });
    }

    async generatePimmaidDiagram() {
        const diagramType = document.querySelector('input[name="diagram-type"]:checked')?.value || 'full-hierarchy';
        const showEligible = document.getElementById('pimmaid-eligible').checked;
        const showActive = document.getElementById('pimmaid-active').checked;
        const direction = document.getElementById('pimmaid-direction').value;

        this.showLoading('Fetching PIM data...');

        try {
            // Fetch all necessary data
            const [groupsResult, rolesResult] = await Promise.all([
                graphService.getPIMGroups(),
                graphService.getRoleDefinitions()
            ]);

            if (!groupsResult.success || !rolesResult.success) {
                throw new Error('Failed to fetch PIM data');
            }

            const groups = groupsResult.groups;
            const roles = rolesResult.roles;

            this.showLoading('Fetching assignments...');

            // Fetch assignments based on diagram type
            let groupAssignments = {};
            let roleAssignments = {};

            if (['user-group', 'full-hierarchy'].includes(diagramType)) {
                const assignmentsResult = await graphService.getAllGroupAssignments(groups);
                groupAssignments = assignmentsResult.assignments || {};
            }

            if (['group-role', 'full-hierarchy', 'role-assignments'].includes(diagramType)) {
                const roleAssignmentsResult = await graphService.getAllRoleAssignments();
                roleAssignments = roleAssignmentsResult.assignments || {};
            }

            this.hideLoading();

            // Generate the diagram
            const data = { groups, roles, groupAssignments, roleAssignments };
            const options = { showEligible, showActive, direction };

            const mermaidCode = pimmaidService.generateDiagram(diagramType, data, options);
            const stats = pimmaidService.getStats(data);

            // Update UI
            document.getElementById('pimmaid-code').textContent = mermaidCode;
            document.getElementById('copy-mermaid-btn').disabled = false;
            document.getElementById('download-mermaid-btn').disabled = false;
            document.getElementById('live-mermaid-btn').disabled = false;

            // Show stats
            const statsDiv = document.getElementById('pimmaid-stats');
            statsDiv.innerHTML = `
                <h4><i class="fas fa-chart-bar"></i> Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value">${stats.totalUsers}</span>
                        <span class="stat-label">Users</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${stats.totalGroups}</span>
                        <span class="stat-label">Groups</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${stats.totalRoles}</span>
                        <span class="stat-label">Roles</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${stats.eligibleAssignments}</span>
                        <span class="stat-label">Eligible</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${stats.activeAssignments}</span>
                        <span class="stat-label">Active</span>
                    </div>
                </div>
                <div class="role-stats">
                    <span class="badge privilege-badge badge-critical">${stats.rolesByPrivilege.critical} Critical</span>
                    <span class="badge privilege-badge badge-high">${stats.rolesByPrivilege.high} High</span>
                    <span class="badge privilege-badge badge-medium">${stats.rolesByPrivilege.medium} Medium</span>
                    <span class="badge privilege-badge badge-low">${stats.rolesByPrivilege.low} Low</span>
                </div>
            `;
            statsDiv.classList.remove('hidden');

            // Update preview hint
            document.getElementById('pimmaid-preview').innerHTML = `
                <div class="preview-placeholder">
                    <i class="fas fa-check-circle"></i>
                    <p>Diagram generated! Copy the code or open in Mermaid Live to view.</p>
                    <p class="code-lines">${mermaidCode.split('\n').length} lines generated</p>
                </div>
            `;

            this.showToast('Diagram generated successfully', 'success');

        } catch (error) {
            this.hideLoading();
            this.showToast('Failed to generate diagram: ' + error.message, 'error');
        }
    }

    copyPimmaidCode() {
        const code = document.getElementById('pimmaid-code').textContent;
        navigator.clipboard.writeText(code).then(() => {
            this.showToast('Mermaid code copied to clipboard', 'success');
        }).catch(() => {
            this.showToast('Failed to copy', 'error');
        });
    }

    downloadPimmaidCode() {
        const code = document.getElementById('pimmaid-code').textContent;
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pimmaid-diagram-${new Date().toISOString().split('T')[0]}.mmd`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        this.showToast('Diagram downloaded', 'success');
    }

    openInMermaidLive() {
        const code = document.getElementById('pimmaid-code').textContent;
        // Encode the code for URL
        const encoded = btoa(unescape(encodeURIComponent(code)));
        const url = `https://mermaid.live/edit#pako:${encoded}`;

        // Mermaid Live uses pako compression, but we can use a simpler approach
        // by opening with the code in state parameter
        const stateObj = {
            code: code,
            mermaid: { theme: 'dark' }
        };
        const state = btoa(JSON.stringify(stateObj));

        window.open(`https://mermaid.live/edit#base64:${state}`, '_blank');
    }

    // ==========================================
    // Baseline Deployment
    // ==========================================

    async renderBaseline(container) {
        const baselines = baselineService.getBaselineConfigurations();

        container.innerHTML = `
            <div class="page-header-row">
                <h1 class="page-header">
                    <i class="fas fa-rocket"></i> PIM Baseline Deployment
                </h1>
                <span class="page-subtitle">One-shot PIM configuration based on best practices</span>
            </div>
            <p class="page-description">Deploy a complete PIM configuration with groups, policies, and role assignments based on industry best practices and Zero Trust principles.</p>

            <div id="baseline-wizard-step" data-step="1">
                <!-- Step 1: Baseline Selection -->
                <div id="baseline-step-1" class="baseline-step active">
                    <h2 class="step-title"><i class="fas fa-list-check"></i> Step 1: Choose Your Baseline</h2>

                    <div class="baseline-grid">
                        ${Object.entries(baselines).map(([key, baseline]) => `
                            <div class="card baseline-card" data-baseline="${key}">
                                <div class="baseline-header">
                                    <i class="fas ${baseline.icon} baseline-icon"></i>
                                    <h3>${baseline.name}</h3>
                                </div>
                                <p class="baseline-desc">${baseline.description}</p>

                                <div class="baseline-features">
                                    <h4>Key Features:</h4>
                                    <ul>
                                        ${baseline.features.map(f => `<li><i class="fas fa-check-circle"></i> ${f}</li>`).join('')}
                                    </ul>
                                </div>

                                <div class="baseline-stats">
                                    <span class="stat-badge"><i class="fas fa-layer-group"></i> ${baseline.tiers.length} Tiers</span>
                                    <span class="stat-badge"><i class="fas fa-users"></i> ${baseline.tiers.reduce((sum, t) => sum + t.groups.length, 0)} Groups</span>
                                </div>

                                <button class="btn btn-primary btn-block" onclick="app.selectBaseline('${key}')" ${!this.isConnected ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-right"></i> Select This Baseline
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Step 2: Tier & Group Selection -->
                <div id="baseline-step-2" class="baseline-step">
                    <h2 class="step-title"><i class="fas fa-layer-group"></i> Step 2: Configure Tiers & Groups</h2>

                    <div class="step-navigation">
                        <button class="btn btn-secondary" onclick="app.previousBaselineStep()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                    </div>

                    <div id="baseline-tier-config" class="tier-config-container">
                        <!-- Populated dynamically -->
                    </div>

                    <div class="step-actions">
                        <button class="btn btn-primary" onclick="app.validateBaseline()">
                            <i class="fas fa-check-circle"></i> Validate Configuration
                        </button>
                    </div>
                </div>

                <!-- Step 3: Validation & Review -->
                <div id="baseline-step-3" class="baseline-step">
                    <h2 class="step-title"><i class="fas fa-clipboard-check"></i> Step 3: Review & Deploy</h2>

                    <div class="step-navigation">
                        <button class="btn btn-secondary" onclick="app.previousBaselineStep()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                    </div>

                    <div id="baseline-validation-results" class="validation-results">
                        <!-- Populated after validation -->
                    </div>

                    <div id="baseline-deployment-plan" class="deployment-plan">
                        <!-- Populated after validation -->
                    </div>

                    <div class="step-actions">
                        <button class="btn btn-success btn-lg" onclick="app.executeBaselineDeployment()" id="deploy-baseline-btn">
                            <i class="fas fa-rocket"></i> Deploy Baseline
                        </button>
                    </div>
                </div>

                <!-- Step 4: Deployment Progress -->
                <div id="baseline-step-4" class="baseline-step">
                    <h2 class="step-title"><i class="fas fa-tasks"></i> Deployment in Progress</h2>

                    <div id="baseline-deployment-progress" class="deployment-progress">
                        <!-- Populated during deployment -->
                    </div>
                </div>
            </div>
        `;

        this.baselineState = {
            selectedBaseline: null,
            selectedTiers: [],
            validationResults: null,
            deploymentPlan: null
        };
    }

    selectBaseline(baselineKey) {
        const baseline = baselineService.getBaseline(baselineKey);
        this.baselineState.selectedBaseline = baselineKey;

        // Populate tier configuration
        const tierConfigDiv = document.getElementById('baseline-tier-config');
        tierConfigDiv.innerHTML = `
            <div class="card">
                <h3><i class="fas fa-info-circle"></i> Selected: ${baseline.name}</h3>
                <p>${baseline.description}</p>
            </div>

            <div class="tiers-list">
                ${baseline.tiers.map((tier, index) => `
                    <div class="card tier-card">
                        <div class="tier-header">
                            <label class="checkbox-label tier-checkbox">
                                <input type="checkbox" class="tier-select" data-tier="${index}" checked>
                                <h3>
                                    ${tier.tier === 0 ? '💀' : tier.tier === 1 ? '⚠️' : '🔵'}
                                    ${tier.name}
                                </h3>
                            </label>
                        </div>

                        <div class="tier-policy-summary">
                            <h4>Policy Configuration:</h4>
                            <div class="policy-grid">
                                <div class="policy-item">
                                    <i class="fas fa-clock"></i>
                                    <span>Max Duration: ${tier.policy.maximumDurationHours}h</span>
                                </div>
                                <div class="policy-item">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>MFA: ${tier.policy.requireMfa ? 'Required' : 'Optional'}</span>
                                </div>
                                <div class="policy-item">
                                    <i class="fas fa-clipboard-check"></i>
                                    <span>Approval: ${tier.policy.requireApproval ? 'Required' : 'Not Required'}</span>
                                </div>
                                <div class="policy-item">
                                    <i class="fas fa-comment-dots"></i>
                                    <span>Justification: ${tier.policy.requireJustification ? 'Required' : 'Optional'}</span>
                                </div>
                            </div>
                        </div>

                        <div class="tier-groups">
                            <h4>Groups to Create (${tier.groups.length}):</h4>
                            <p class="form-hint"><i class="fas fa-info-circle"></i> Click the arrow (▼) on each group to customize name and add users</p>
                            <div class="groups-list">
                                ${tier.groups.map((group, gIndex) => `
                                    <div class="group-item baseline-group-item" data-tier="${index}" data-group-index="${gIndex}">
                                        <div class="group-item-header">
                                            <label class="checkbox-label">
                                                <input type="checkbox" class="group-select" data-tier="${index}" data-group="${group.name}" checked>
                                                <div class="group-info-compact">
                                                    <i class="fas fa-users"></i>
                                                    <span>${group.name}</span>
                                                </div>
                                            </label>
                                            <button class="btn btn-sm btn-secondary" onclick="app.toggleGroupDetails(${index}, ${gIndex})">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                        </div>

                                        <div class="group-item-details" id="group-details-${index}-${gIndex}">
                                            <div class="form-group">
                                                <label>Group Name</label>
                                                <input type="text" class="input group-name-input"
                                                    data-tier="${index}"
                                                    data-group-index="${gIndex}"
                                                    data-original="${group.name}"
                                                    value="${group.name}">
                                                <small class="form-hint">Customize the group name (must be unique)</small>
                                            </div>

                                            <div class="form-group">
                                                <label>Description</label>
                                                <textarea class="input group-desc-input"
                                                    data-tier="${index}"
                                                    data-group-index="${gIndex}"
                                                    rows="2">${group.description}</textarea>
                                            </div>

                                            <div class="form-group">
                                                <label>Assigned Roles</label>
                                                <div class="group-roles-list">
                                                    <i class="fas fa-user-shield"></i>
                                                    ${group.roles.length} role${group.roles.length !== 1 ? 's' : ''}
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label>Assignment Type</label>
                                                <div class="assignment-type-toggle">
                                                    <label class="toggle-option ${!group.isActive ? 'active' : ''}" data-tier="${index}" data-group-index="${gIndex}" data-type="eligible">
                                                        <input type="radio" name="assignment-type-${index}-${gIndex}" value="eligible" checked>
                                                        <div class="toggle-content">
                                                            <i class="fas fa-clock"></i>
                                                            <span>Eligible</span>
                                                            <small>Users activate when needed</small>
                                                        </div>
                                                    </label>
                                                    <label class="toggle-option ${group.isActive ? 'active' : ''}" data-tier="${index}" data-group-index="${gIndex}" data-type="active">
                                                        <input type="radio" name="assignment-type-${index}-${gIndex}" value="active">
                                                        <div class="toggle-content">
                                                            <i class="fas fa-check-circle"></i>
                                                            <span>Active</span>
                                                            <small>Always active (permanent)</small>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label>Add Users (Optional)</label>
                                                <div class="user-search-container">
                                                    <input type="text"
                                                        class="input user-search-input"
                                                        data-tier="${index}"
                                                        data-group-index="${gIndex}"
                                                        placeholder="Search users by name or email...">
                                                    <div class="user-search-results" id="user-search-results-${index}-${gIndex}"></div>
                                                </div>
                                                <div class="selected-users-list" id="selected-users-${index}-${gIndex}">
                                                    <small class="form-hint">No users added yet. Search above to add users.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        // Navigate to step 2
        this.goToBaselineStep(2);

        // Initialize user selections storage
        this.baselineState.groupUsers = {};
        this.baselineState.groupCustomizations = {};

        // Add event listeners for tier checkboxes
        document.querySelectorAll('.tier-select').forEach(cb => {
            cb.addEventListener('change', (e) => {
                const tierIndex = parseInt(e.target.dataset.tier);
                const groupCheckboxes = document.querySelectorAll(`.group-select[data-tier="${tierIndex}"]`);
                groupCheckboxes.forEach(gcb => {
                    gcb.checked = e.target.checked;
                    gcb.disabled = !e.target.checked;
                });
            });
        });

        // Add event listeners for assignment type toggle
        document.querySelectorAll('.toggle-option').forEach(option => {
            option.addEventListener('click', (e) => {
                const label = e.currentTarget;
                const tierIndex = label.dataset.tier;
                const groupIndex = label.dataset.groupIndex;
                const type = label.dataset.type;

                // Update UI
                const siblingOptions = document.querySelectorAll(`.toggle-option[data-tier="${tierIndex}"][data-group-index="${groupIndex}"]`);
                siblingOptions.forEach(opt => opt.classList.remove('active'));
                label.classList.add('active');

                // Update radio button
                label.querySelector('input[type="radio"]').checked = true;

                // Store in state
                const key = `${tierIndex}-${groupIndex}`;
                if (!this.baselineState.groupCustomizations[key]) {
                    this.baselineState.groupCustomizations[key] = {};
                }
                this.baselineState.groupCustomizations[key].assignmentType = type;
            });
        });

        // Add event listeners for user search
        document.querySelectorAll('.user-search-input').forEach(input => {
            let searchTimeout;
            input.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                const tierIndex = e.target.dataset.tier;
                const groupIndex = e.target.dataset.groupIndex;

                if (query.length < 2) {
                    document.getElementById(`user-search-results-${tierIndex}-${groupIndex}`).innerHTML = '';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    this.searchUsersForBaseline(tierIndex, groupIndex, query);
                }, 300);
            });
        });
    }

    toggleGroupDetails(tierIndex, groupIndex) {
        const detailsDiv = document.getElementById(`group-details-${tierIndex}-${groupIndex}`);
        const button = event.target.closest('button');
        const icon = button.querySelector('i');

        if (detailsDiv.style.display === 'none' || !detailsDiv.style.display) {
            detailsDiv.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
        } else {
            detailsDiv.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
        }
    }

    async searchUsersForBaseline(tierIndex, groupIndex, query) {
        const resultsDiv = document.getElementById(`user-search-results-${tierIndex}-${groupIndex}`);
        resultsDiv.innerHTML = '<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';

        try {
            const result = await graphService.searchUsers(query);

            if (result.success && result.users.length > 0) {
                resultsDiv.innerHTML = result.users.map(user => `
                    <div class="user-search-result" onclick="app.addUserToGroup(${tierIndex}, ${groupIndex}, '${user.id}', '${user.displayName}', '${user.userPrincipalName}')">
                        <div class="user-info">
                            <i class="fas fa-user"></i>
                            <div>
                                <div class="user-name">${user.displayName}</div>
                                <div class="user-email">${user.userPrincipalName}</div>
                            </div>
                        </div>
                        <i class="fas fa-plus-circle"></i>
                    </div>
                `).join('');
            } else {
                resultsDiv.innerHTML = '<div class="search-no-results">No users found</div>';
            }
        } catch (error) {
            resultsDiv.innerHTML = '<div class="search-error">Search failed</div>';
        }
    }

    addUserToGroup(tierIndex, groupIndex, userId, displayName, userPrincipalName) {
        const key = `${tierIndex}-${groupIndex}`;

        // Initialize array if needed
        if (!this.baselineState.groupUsers[key]) {
            this.baselineState.groupUsers[key] = [];
        }

        // Check if user already added
        if (this.baselineState.groupUsers[key].some(u => u.id === userId)) {
            this.showToast('User already added to this group', 'info');
            return;
        }

        // Add user
        this.baselineState.groupUsers[key].push({ id: userId, displayName, userPrincipalName });

        // Update UI
        this.updateSelectedUsersList(tierIndex, groupIndex);

        // Clear search
        document.querySelector(`.user-search-input[data-tier="${tierIndex}"][data-group-index="${groupIndex}"]`).value = '';
        document.getElementById(`user-search-results-${tierIndex}-${groupIndex}`).innerHTML = '';

        this.showToast(`Added ${displayName} to group`, 'success');
    }

    removeUserFromGroup(tierIndex, groupIndex, userId) {
        const key = `${tierIndex}-${groupIndex}`;

        if (this.baselineState.groupUsers[key]) {
            this.baselineState.groupUsers[key] = this.baselineState.groupUsers[key].filter(u => u.id !== userId);
            this.updateSelectedUsersList(tierIndex, groupIndex);
        }
    }

    updateSelectedUsersList(tierIndex, groupIndex) {
        const key = `${tierIndex}-${groupIndex}`;
        const users = this.baselineState.groupUsers[key] || [];
        const listDiv = document.getElementById(`selected-users-${tierIndex}-${groupIndex}`);

        if (users.length === 0) {
            listDiv.innerHTML = '<small class="form-hint">No users added yet. Search above to add users.</small>';
        } else {
            listDiv.innerHTML = `
                <div class="selected-users-header">
                    <strong>${users.length} user${users.length !== 1 ? 's' : ''} will be added:</strong>
                </div>
                ${users.map(user => `
                    <div class="selected-user-item">
                        <div class="user-info">
                            <i class="fas fa-user"></i>
                            <div>
                                <div class="user-name">${user.displayName}</div>
                                <div class="user-email">${user.userPrincipalName}</div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="app.removeUserFromGroup(${tierIndex}, ${groupIndex}, '${user.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('')}
            `;
        }
    }

    async validateBaseline() {
        if (!this.baselineState.selectedBaseline) {
            this.showToast('No baseline selected', 'error');
            return;
        }

        this.showLoading('Validating configuration...');

        try {
            const baseline = baselineService.getBaseline(this.baselineState.selectedBaseline);

            // Collect selected tiers and groups
            const selectedConfig = {
                baseline: this.baselineState.selectedBaseline,
                tiers: []
            };

            document.querySelectorAll('.tier-select:checked').forEach(tierCb => {
                const tierIndex = parseInt(tierCb.dataset.tier);
                const tier = baseline.tiers[tierIndex];

                const selectedGroups = [];
                document.querySelectorAll(`.group-select[data-tier="${tierIndex}"]:checked`).forEach((groupCb) => {
                    const groupName = groupCb.dataset.group;
                    const groupIndex = tier.groups.findIndex(g => g.name === groupName);
                    const group = tier.groups[groupIndex];

                    if (group && groupIndex !== -1) {
                        // Get customized values using the actual group index
                        const nameInput = document.querySelector(`.group-name-input[data-tier="${tierIndex}"][data-group-index="${groupIndex}"]`);
                        const descInput = document.querySelector(`.group-desc-input[data-tier="${tierIndex}"][data-group-index="${groupIndex}"]`);
                        const assignmentTypeRadio = document.querySelector(`input[name="assignment-type-${tierIndex}-${groupIndex}"]:checked`);

                        const customizedGroup = {
                            ...group,
                            name: nameInput ? nameInput.value.trim() : group.name,
                            description: descInput ? descInput.value.trim() : group.description,
                            originalName: group.name,
                            assignmentType: assignmentTypeRadio ? assignmentTypeRadio.value : 'eligible'
                        };

                        // Store customizations
                        const key = `${tierIndex}-${groupIndex}`;
                        this.baselineState.groupCustomizations[key] = {
                            name: customizedGroup.name,
                            description: customizedGroup.description,
                            users: this.baselineState.groupUsers[key] || [],
                            assignmentType: customizedGroup.assignmentType
                        };

                        selectedGroups.push(customizedGroup);
                    }
                });

                if (selectedGroups.length > 0) {
                    selectedConfig.tiers.push({
                        ...tier,
                        groups: selectedGroups
                    });
                }
            });

            this.baselineState.selectedTiers = selectedConfig.tiers;

            // Validate against existing environment
            const existingGroups = await graphService.getPIMGroups();
            const existingRoles = await graphService.getRoleDefinitions();

            const validation = baselineService.validateBaseline(selectedConfig, {
                existingGroups: existingGroups.groups || [],
                existingRoles: existingRoles.roles || []
            });

            this.baselineState.validationResults = validation;

            // Calculate deployment plan
            const deploymentPlan = baselineService.calculateDeploymentPlan(selectedConfig, {
                existingGroups: existingGroups.groups || [],
                existingRoles: existingRoles.roles || []
            });

            this.baselineState.deploymentPlan = deploymentPlan;

            this.hideLoading();

            // Display validation results
            this.displayValidationResults(validation, deploymentPlan);
            this.goToBaselineStep(3);

        } catch (error) {
            this.hideLoading();
            this.showToast('Validation failed: ' + error.message, 'error');
        }
    }

    displayValidationResults(validation, plan) {
        const resultsDiv = document.getElementById('baseline-validation-results');
        const planDiv = document.getElementById('baseline-deployment-plan');

        // Validation results
        const hasErrors = validation.errors.length > 0;
        const hasWarnings = validation.warnings.length > 0;

        resultsDiv.innerHTML = `
            <div class="card ${hasErrors ? 'validation-error' : hasWarnings ? 'validation-warning' : 'validation-success'}">
                <h3>
                    <i class="fas ${hasErrors ? 'fa-times-circle' : hasWarnings ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
                    Validation ${hasErrors ? 'Failed' : hasWarnings ? 'Passed with Warnings' : 'Passed'}
                </h3>

                ${validation.errors.length > 0 ? `
                    <div class="validation-section validation-errors">
                        <h4><i class="fas fa-times-circle"></i> Errors</h4>
                        <ul>
                            ${validation.errors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${validation.warnings.length > 0 ? `
                    <div class="validation-section validation-warnings">
                        <h4><i class="fas fa-exclamation-triangle"></i> Warnings</h4>
                        <ul>
                            ${validation.warnings.map(warn => `<li>${warn}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${!hasErrors && !hasWarnings ? `
                    <p><i class="fas fa-check"></i> Configuration is valid and ready for deployment.</p>
                ` : ''}

                ${validation.newGroups && validation.newGroups.length > 0 ? `
                    <div class="validation-summary">
                        <h4><i class="fas fa-info-circle"></i> Summary</h4>
                        <p><strong>${validation.newGroups.length} new group(s)</strong> will be created:</p>
                        <ul class="group-list-compact">
                            ${validation.newGroups.map(name => `<li><i class="fas fa-plus-circle"></i> ${name}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${validation.existingGroups && validation.existingGroups.length > 0 ? `
                    <div class="validation-summary">
                        <p><strong>${validation.existingGroups.length} existing group(s)</strong> will be skipped:</p>
                        <ul class="group-list-compact">
                            ${validation.existingGroups.map(name => `<li><i class="fas fa-check-circle"></i> ${name}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        `;

        // Deployment plan
        const summary = baselineService.getBaselineSummary(this.baselineState.selectedBaseline);

        planDiv.innerHTML = `
            <div class="card deployment-plan-card">
                <h3><i class="fas fa-tasks"></i> Deployment Plan</h3>

                <div class="plan-summary">
                    <div class="plan-stat">
                        <span class="plan-value">${plan.groupsToCreate.length}</span>
                        <span class="plan-label">Groups to Create</span>
                    </div>
                    <div class="plan-stat">
                        <span class="plan-value">${plan.policiesToConfigure.length}</span>
                        <span class="plan-label">Policies to Configure</span>
                    </div>
                    <div class="plan-stat">
                        <span class="plan-value">${plan.roleAssignmentsToCreate.length}</span>
                        <span class="plan-label">Role Assignments</span>
                    </div>
                    <div class="plan-stat">
                        <span class="plan-value">${plan.estimatedTime}</span>
                        <span class="plan-label">Est. Time</span>
                    </div>
                </div>

                <div class="plan-details">
                    <h4>Deployment Steps:</h4>
                    <ol class="deployment-steps-list">
                        ${plan.steps.map(step => `
                            <li>
                                <i class="fas ${step.icon}"></i>
                                <strong>${step.title}</strong>
                                <p>${step.description}</p>
                            </li>
                        `).join('')}
                    </ol>
                </div>

                <div class="plan-groups-preview">
                    <h4>Groups to be created:</h4>
                    <div class="groups-preview-list">
                        ${plan.groupsToCreate.map(group => `
                            <div class="group-preview-item">
                                <i class="fas fa-users"></i>
                                <div>
                                    <strong>${group.displayName}</strong>
                                    <p>${group.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        // Enable/disable deploy button based on validation
        const deployBtn = document.getElementById('deploy-baseline-btn');
        if (deployBtn) {
            deployBtn.disabled = hasErrors;
        }
    }

    async executeBaselineDeployment() {
        if (!this.baselineState.deploymentPlan) {
            this.showToast('No deployment plan available', 'error');
            return;
        }

        const confirmed = confirm(
            `This will create ${this.baselineState.deploymentPlan.groupsToCreate.length} groups and configure their policies.\n\n` +
            'This action cannot be undone automatically. Continue?'
        );

        if (!confirmed) return;

        this.goToBaselineStep(4);

        const progressDiv = document.getElementById('baseline-deployment-progress');
        const plan = this.baselineState.deploymentPlan;
        // Calculate total steps: group creation + role assignments + policy updates
        const totalRoleAssignments = plan.groupsToCreate.reduce((sum, g) => sum + (g.roles?.length || 0), 0);
        const totalSteps = plan.groupsToCreate.length + totalRoleAssignments + totalRoleAssignments; // groups + assignments + policies
        let completedSteps = 0;

        const updateProgress = (message, isError = false) => {
            completedSteps++;
            const percentage = Math.round((completedSteps / totalSteps) * 100);

            const logEntry = document.createElement('div');
            logEntry.className = `deployment-log-entry ${isError ? 'log-error' : 'log-success'}`;
            logEntry.innerHTML = `
                <i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'}"></i>
                <span>${message}</span>
            `;

            const logContainer = progressDiv.querySelector('.deployment-log') || (() => {
                const container = document.createElement('div');
                container.className = 'deployment-log';
                progressDiv.appendChild(container);
                return container;
            })();

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Update progress bar
            const progressBar = progressDiv.querySelector('.progress-bar-fill');
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
                progressBar.textContent = `${percentage}%`;
            }
        };

        progressDiv.innerHTML = `
            <div class="card">
                <h3><i class="fas fa-spinner fa-spin"></i> Deploying Baseline Configuration</h3>
                <div class="progress-bar">
                    <div class="progress-bar-fill" style="width: 0%">0%</div>
                </div>
                <div class="deployment-log"></div>
            </div>
        `;

        try {
            // Step 0: Fetch all roles for display names
            updateProgress('Fetching role information...');
            const rolesResult = await graphService.getRoleDefinitions();
            const rolesMap = new Map();
            if (rolesResult.success) {
                rolesResult.roles.forEach(role => {
                    rolesMap.set(role.id, role.displayName);
                });
            }

            // Step 1: Create groups
            updateProgress('Starting group creation...');
            const createdGroups = [];

            for (const groupConfig of plan.groupsToCreate) {
                try {
                    const result = await graphService.createPIMGroup(
                        groupConfig.displayName,
                        groupConfig.description,
                        groupConfig.mailNickname
                    );
                    if (result.success) {
                        createdGroups.push({ config: groupConfig, group: result.group });
                        updateProgress(`✓ Created group: ${groupConfig.displayName}`);
                    } else {
                        updateProgress(`✗ Failed to create group: ${groupConfig.displayName} - ${result.error}`, true);
                    }
                } catch (error) {
                    updateProgress(`✗ Error creating group: ${groupConfig.displayName} - ${error.message}`, true);
                }
            }

            // Step 2: Wait for groups to be fully provisioned
            updateProgress('Waiting for groups to provision (this may take 30-60 seconds)...');
            await new Promise(resolve => setTimeout(resolve, 30000)); // Wait 30 seconds

            // Step 3: Assign groups to roles
            updateProgress('Assigning groups to roles...');
            const roleAssignments = [];

            for (const createdGroup of createdGroups) {
                // Get the roles for this group from config
                const roles = createdGroup.config.roles || [];

                // Find the customization for this group to get assignment type
                const customizationEntry = Object.entries(this.baselineState.groupCustomizations || {}).find(
                    ([key, value]) => value.name === createdGroup.config.displayName
                );
                const assignmentType = customizationEntry ? customizationEntry[1].assignmentType : 'eligible';

                for (const roleId of roles) {
                    try {
                        let assignResult;

                        if (assignmentType === 'active') {
                            // Create active (permanent) assignment
                            assignResult = await graphService.createDirectoryRoleActiveAssignment(
                                createdGroup.group.id,
                                roleId,
                                `Baseline deployment (Active): ${createdGroup.config.displayName}`
                            );
                        } else {
                            // Create eligible assignment (default)
                            assignResult = await graphService.createDirectoryRoleEligibilityAssignment(
                                createdGroup.group.id,
                                roleId,
                                `Baseline deployment (Eligible): ${createdGroup.config.displayName}`,
                                12 // 12 months eligibility
                            );
                        }

                        if (assignResult.success) {
                            const roleName = rolesMap.get(roleId) || roleId;
                            roleAssignments.push({
                                groupId: createdGroup.group.id,
                                groupName: createdGroup.config.displayName,
                                roleId: roleId,
                                roleName: roleName,
                                policy: createdGroup.config.policy
                            });
                            updateProgress(`✓ Assigned ${createdGroup.config.displayName} to ${roleName} (${assignmentType})`);
                        } else {
                            updateProgress(`✗ Failed to assign ${createdGroup.config.displayName}: ${assignResult.error}`, true);
                        }
                    } catch (error) {
                        updateProgress(`✗ Error assigning ${createdGroup.config.displayName}: ${error.message}`, true);
                    }
                }
            }

            // Step 4: Wait for role assignments to propagate
            updateProgress('Waiting for role assignments to propagate (10 seconds)...');
            await new Promise(resolve => setTimeout(resolve, 10000));

            updateProgress(`✓ Role assignments complete. ${roleAssignments.length} groups assigned to roles.`);

            // Step 5: Configure role policies (NOTE: These are global settings per role)
            if (roleAssignments.length > 0) {
                updateProgress('Configuring role policies...');

                // Group assignments by role to avoid duplicate policy updates
                const roleConfigMap = new Map();
                roleAssignments.forEach(assignment => {
                    if (!roleConfigMap.has(assignment.roleId)) {
                        roleConfigMap.set(assignment.roleId, {
                            roleId: assignment.roleId,
                            roleName: assignment.roleName,
                            groupName: assignment.groupName,
                            policy: assignment.policy
                        });
                    }
                });

                for (const [roleId, config] of roleConfigMap) {
                    try {
                        // Get the role policy
                        updateProgress(`Fetching policy for ${config.roleName}...`);
                        const policiesResult = await graphService.getRolePolicy(roleId);

                        console.log(`Policy result for ${config.roleName}:`, policiesResult);

                        if (policiesResult.success && policiesResult.policy) {
                            let updatedCount = 0;

                            // Update expiration rule
                            try {
                                await graphService.updateRolePolicy(
                                    policiesResult.policy.id,
                                    'Expiration_EndUser_Assignment',
                                    {
                                        maximumDuration: `PT${config.policy.maximumDurationHours}H`,
                                        isExpirationRequired: true
                                    }
                                );
                                updatedCount++;
                            } catch (err) {
                                console.error('Expiration rule update failed:', err);
                            }

                            // Update enablement rule
                            try {
                                await graphService.updateRolePolicy(
                                    policiesResult.policy.id,
                                    'Enablement_EndUser_Assignment',
                                    {
                                        enabledRules: [
                                            config.policy.requireMfa ? 'MultiFactorAuthentication' : null,
                                            config.policy.requireJustification ? 'Justification' : null,
                                            config.policy.requireTicketInfo ? 'Ticketing' : null
                                        ].filter(r => r !== null)
                                    }
                                );
                                updatedCount++;
                            } catch (err) {
                                console.error('Enablement rule update failed:', err);
                            }

                            // Update approval rule
                            try {
                                await graphService.updateRolePolicy(
                                    policiesResult.policy.id,
                                    'Approval_EndUser_Assignment',
                                    {
                                        isApprovalRequired: config.policy.requireApproval
                                    }
                                );
                                updatedCount++;
                            } catch (err) {
                                console.error('Approval rule update failed:', err);
                            }

                            if (updatedCount > 0) {
                                updateProgress(`✓ Updated ${config.roleName} policy (${updatedCount}/3 rules)`);
                            } else {
                                updateProgress(`⚠ Could not update ${config.roleName} policy`, false);
                            }
                        } else {
                            const errorMsg = policiesResult.error || 'Unknown error';
                            updateProgress(`⚠ Could not fetch ${config.roleName} policy: ${errorMsg}`, false);
                        }
                    } catch (error) {
                        updateProgress(`⚠ Policy update error: ${error.message}`, false);
                    }
                }
            }

            // Step 6: Add users to groups (if any were selected)
            const totalUsersToAdd = Object.values(this.baselineState.groupUsers || {}).reduce((sum, users) => sum + users.length, 0);

            if (totalUsersToAdd > 0) {
                updateProgress(`Adding ${totalUsersToAdd} users to groups...`);

                for (const createdGroup of createdGroups) {
                    // Find the customization key for this group
                    const customizationEntry = Object.entries(this.baselineState.groupCustomizations || {}).find(
                        ([key, value]) => value.name === createdGroup.config.displayName
                    );

                    if (customizationEntry && customizationEntry[1].users && customizationEntry[1].users.length > 0) {
                        const users = customizationEntry[1].users;

                        for (const user of users) {
                            try {
                                // Create eligible assignment for member role (access to group)
                                const assignResult = await graphService.createEligibleAssignment(
                                    createdGroup.group.id,
                                    user.id,
                                    'member', // member access
                                    null,
                                    null // no expiration for now
                                );

                                if (assignResult.success) {
                                    updateProgress(`✓ Added ${user.displayName} to ${createdGroup.config.displayName}`);
                                } else {
                                    updateProgress(`✗ Failed to add ${user.displayName}: ${assignResult.error}`, true);
                                }
                            } catch (error) {
                                updateProgress(`✗ Error adding ${user.displayName}: ${error.message}`, true);
                            }
                        }
                    }
                }
            }

            // Step 7: Complete
            updateProgress('Deployment completed!');

            progressDiv.innerHTML += `
                <div class="deployment-complete">
                    <i class="fas fa-check-circle"></i>
                    <h3>Baseline Deployed Successfully!</h3>
                    <p>Created ${createdGroups.length} groups with configured policies.</p>
                    <div class="deployment-actions">
                        <button class="btn btn-primary" onclick="app.navigateTo('groups')">
                            <i class="fas fa-users"></i> View Groups
                        </button>
                        <button class="btn btn-secondary" onclick="app.renderPage('baseline')">
                            <i class="fas fa-redo"></i> Deploy Another Baseline
                        </button>
                    </div>
                </div>
            `;

            this.showToast('Baseline deployed successfully!', 'success');

        } catch (error) {
            updateProgress(`✗ Deployment failed: ${error.message}`, true);
            this.showToast('Deployment failed: ' + error.message, 'error');

            progressDiv.innerHTML += `
                <div class="deployment-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Deployment Failed</h3>
                    <p>${error.message}</p>
                    <button class="btn btn-secondary" onclick="app.previousBaselineStep()">
                        <i class="fas fa-arrow-left"></i> Go Back
                    </button>
                </div>
            `;
        }
    }

    goToBaselineStep(stepNumber) {
        // Hide all steps
        document.querySelectorAll('.baseline-step').forEach(step => {
            step.classList.remove('active');
        });

        // Show target step
        const targetStep = document.getElementById(`baseline-step-${stepNumber}`);
        if (targetStep) {
            targetStep.classList.add('active');
            document.getElementById('baseline-wizard-step').dataset.step = stepNumber;
        }
    }

    previousBaselineStep() {
        const currentStep = parseInt(document.getElementById('baseline-wizard-step').dataset.step);
        if (currentStep > 1) {
            this.goToBaselineStep(currentStep - 1);
        }
    }

    async renderExport(container) {
        container.innerHTML = `
            <h1 class="page-header">Import / Export</h1>

            <div class="export-grid">
                <div class="card">
                    <div class="card-header-icon">
                        <i class="fas fa-file-export primary"></i>
                        <h2>Export</h2>
                    </div>
                    <p>Export your PIM configuration for backup or migration.</p>

                    <div class="checkbox-group">
                        <label><input type="checkbox" id="export-groups" checked> PIM Groups</label>
                        <label><input type="checkbox" id="export-policies" checked> Policy Configurations</label>
                        <label><input type="checkbox" id="export-assignments" checked> Role Assignments</label>
                    </div>

                    <select class="input" id="export-format">
                        <option value="json">JSON (Full Configuration)</option>
                        <option value="csv">CSV (Audit Report)</option>
                    </select>

                    <button class="btn btn-primary" onclick="app.exportConfig()" ${!this.isConnected ? 'disabled' : ''}>
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>

                <div class="card">
                    <div class="card-header-icon">
                        <i class="fas fa-file-import secondary"></i>
                        <h2>Import</h2>
                    </div>
                    <p>Import PIM configuration from a JSON file.</p>

                    <div class="drop-zone" id="import-drop-zone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drop file here or click to browse</p>
                    </div>

                    <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()" ${!this.isConnected ? 'disabled' : ''}>
                        <i class="fas fa-folder-open"></i> Browse Files
                    </button>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="app.handleImport(this.files)">
                </div>
            </div>
        `;
    }

    async renderSettings(container) {
        const config = getSavedAppConfig();

        container.innerHTML = `
            <h1 class="page-header">Settings</h1>

            <div class="settings-container">
                <div class="card">
                    <h2>Appearance</h2>
                    <div class="setting-row">
                        <div>
                            <strong>Theme</strong>
                            <p>Choose between light and dark mode</p>
                        </div>
                        <select class="input" id="theme-select" onchange="app.setTheme(this.value)">
                            <option value="light" ${!this.isDarkMode ? 'selected' : ''}>Light</option>
                            <option value="dark" ${this.isDarkMode ? 'selected' : ''}>Dark</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <h2>App Configuration</h2>
                    ${config ? `
                        <div class="config-info">
                            <p><strong>Client ID:</strong> <code>${config.clientId}</code></p>
                            <p><strong>Tenant ID:</strong> <code>${config.tenantId}</code></p>
                            <p><strong>Configured:</strong> ${new Date(config.createdAt).toLocaleString()}</p>
                        </div>
                        <button class="btn btn-secondary" onclick="app.resetSetup()">
                            <i class="fas fa-redo"></i> Reset Configuration
                        </button>
                    ` : `
                        <p>App is not configured.</p>
                        <button class="btn btn-primary" onclick="app.showSetupWizard()">
                            <i class="fas fa-magic"></i> Run Setup
                        </button>
                    `}
                </div>

                <div class="card">
                    <h2>About</h2>
                    <p><strong>PIMBuddy Web</strong> v1.0.0</p>
                    <p class="caption">Privileged Identity Management Tool for Microsoft Entra ID</p>
                    <p class="caption">Built with MSAL.js and Microsoft Graph API</p>
                </div>
            </div>
        `;
    }

    // ==========================================
    // Actions
    // ==========================================

    async showCreateGroup() {
        const html = `
            <h2>Create PIM Group</h2>
            <form id="create-group-form">
                <div class="form-group">
                    <label>Display Name *</label>
                    <input type="text" id="group-name" class="input" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="group-description" class="input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Mail Nickname</label>
                    <input type="text" id="group-nickname" class="input" placeholder="Auto-generated if empty">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Group</button>
                </div>
            </form>
        `;

        this.showModal(html);

        document.getElementById('create-group-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('group-name').value;
            const description = document.getElementById('group-description').value;
            const nickname = document.getElementById('group-nickname').value;

            this.showLoading('Creating group...');
            const result = await graphService.createPIMGroup(name, description, nickname);
            this.hideLoading();

            if (result.success) {
                this.closeModal();
                this.showToast('Group created successfully', 'success');
                this.cache.groups = null;
                this.refreshCurrentPage();
            } else {
                this.showToast(result.error, 'error');
            }
        });
    }

    async deleteGroup(groupId) {
        if (!confirm('Are you sure you want to delete this group? This action cannot be undone.')) {
            return;
        }

        this.showLoading('Deleting group...');
        const result = await graphService.deleteGroup(groupId);
        this.hideLoading();

        if (result.success) {
            this.showToast('Group deleted successfully', 'success');
            this.cache.groups = null;
            this.refreshCurrentPage();
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async manageGroup(groupId) {
        this.showLoading('Loading group members...');

        const group = this.cache.groups?.find(g => g.id === groupId);
        const membersResult = await graphService.getGroupMembers(groupId);

        this.hideLoading();

        const members = membersResult.success ? membersResult.members : [];

        const html = `
            <h2>Manage Group: ${this.escapeHtml(group?.displayName || 'Unknown')}</h2>

            <div style="margin: var(--space-md) 0;">
                <h3 style="margin-bottom: var(--space-sm);">Current Members (${members.length})</h3>

                <div id="members-list" style="max-height: 300px; overflow-y: auto; margin-bottom: var(--space-md);">
                    ${members.length > 0 ? members.map(member => `
                        <div class="member-item" style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-sm); border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                <i class="fas fa-user" style="color: var(--text-secondary);"></i>
                                <div>
                                    <div style="font-weight: 500;">${this.escapeHtml(member.displayName)}</div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">${this.escapeHtml(member.userPrincipalName || member.mail || '')}</div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-danger" onclick="app.removeGroupMember('${groupId}', '${member.id}')">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>
                    `).join('') : `
                        <p style="color: var(--text-secondary); text-align: center; padding: var(--space-lg);">
                            <i class="fas fa-users" style="font-size: 2em; opacity: 0.3; display: block; margin-bottom: var(--space-sm);"></i>
                            No members yet
                        </p>
                    `}
                </div>

                <h3 style="margin-bottom: var(--space-sm);">Add Member</h3>
                <div style="display: flex; gap: var(--space-sm);">
                    <input type="text" id="user-search" class="input" placeholder="Search for user by name or email..." style="flex: 1;">
                    <button type="button" class="btn btn-primary" onclick="app.searchAndAddMember('${groupId}')">
                        <i class="fas fa-search"></i> Search & Add
                    </button>
                </div>
                <div id="search-results" style="margin-top: var(--space-sm);"></div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Close</button>
            </div>
        `;

        this.showModal(html);
    }

    async searchAndAddMember(groupId) {
        const searchInput = document.getElementById('user-search');
        const query = searchInput.value.trim();

        if (!query || query.length < 2) {
            this.showToast('Please enter at least 2 characters to search', 'warning');
            return;
        }

        const searchResultsDiv = document.getElementById('search-results');
        searchResultsDiv.innerHTML = '<p style="color: var(--text-secondary);"><i class="fas fa-spinner fa-spin"></i> Searching...</p>';

        const result = await graphService.searchUsers(query);

        if (!result.success || result.users.length === 0) {
            searchResultsDiv.innerHTML = '<p style="color: var(--text-secondary);">No users found</p>';
            return;
        }

        searchResultsDiv.innerHTML = `
            <div style="border: 1px solid var(--border-color); border-radius: var(--radius-md); max-height: 200px; overflow-y: auto;">
                ${result.users.map(user => `
                    <div style="padding: var(--space-sm); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 500;">${this.escapeHtml(user.displayName)}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${this.escapeHtml(user.userPrincipalName)}</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="app.addUserToGroup('${groupId}', '${user.id}')">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    async addUserToGroup(groupId, userId) {
        this.showLoading('Adding member...');
        const result = await graphService.addGroupMember(groupId, userId);
        this.hideLoading();

        if (result.success) {
            this.showToast('Member added successfully', 'success');
            // Refresh the group management modal
            this.closeModal();
            setTimeout(() => this.manageGroup(groupId), 300);
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async removeGroupMember(groupId, memberId) {
        if (!confirm('Remove this member from the group?')) {
            return;
        }

        this.showLoading('Removing member...');
        const result = await graphService.removeGroupMember(groupId, memberId);
        this.hideLoading();

        if (result.success) {
            this.showToast('Member removed successfully', 'success');
            // Refresh the group management modal
            this.closeModal();
            setTimeout(() => this.manageGroup(groupId), 300);
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async saveGroupPolicy(groupId) {
        const settings = {
            maximumDurationHours: parseInt(document.getElementById('max-duration').value),
            requireMfa: document.getElementById('require-mfa').checked,
            requireJustification: document.getElementById('require-justification').checked,
            requireApproval: document.getElementById('require-approval').checked
        };

        this.showLoading('Saving policy...');
        const result = await graphService.updateGroupPolicy(groupId, 'member', settings);
        this.hideLoading();

        if (result.success) {
            this.closeModal();
            this.showToast('Policy updated successfully', 'success');
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async refreshGroups() {
        this.cache.groups = null;
        await this.renderPage('groups');
    }

    async refreshRoles() {
        this.cache.roles = null;
        await this.renderPage('roles');
    }

    filterGroups(query) {
        const rows = document.querySelectorAll('#groups-table tbody tr');
        const q = query.toLowerCase();
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(q) ? '' : 'none';
        });
    }

    filterRoles(query) {
        const rows = document.querySelectorAll('#roles-table tbody tr');
        const q = query.toLowerCase();
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(q) ? '' : 'none';
        });
    }

    // Pagination handlers
    handleGroupsPageChange(page) {
        this.paginators.groups.goToPage(page);
        this.renderPage('groups');
    }

    handleGroupsPageSizeChange(size) {
        this.paginators.groups.setPageSize(size);
        this.renderPage('groups');
    }

    handleRolesPageChange(page) {
        this.paginators.roles.goToPage(page);
        this.renderPage('roles');
    }

    handleRolesPageSizeChange(size) {
        this.paginators.roles.setPageSize(size);
        this.renderPage('roles');
    }

    handleActivityPageChange(page) {
        this.paginators.activity.goToPage(page);
        this.renderPage('pim-activity');
    }

    handleActivityPageSizeChange(size) {
        this.paginators.activity.setPageSize(size);
        this.renderPage('pim-activity');
    }

    showGlobalSearch() {
        this.showToast('Global search coming soon', 'info');
    }

    // Export methods
    exportGroupsToCSV() {
        try {
            const groups = this.cache.groups || [];
            if (groups.length === 0) {
                this.showToast('No groups to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('pim-groups');
            ExportUtils.exportToCSV(groups, filename, ExportConfigs.groups.columns);
            this.showToast(`Exported ${groups.length} groups to CSV`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    exportGroupsToJSON() {
        try {
            const groups = this.cache.groups || [];
            if (groups.length === 0) {
                this.showToast('No groups to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('pim-groups');
            ExportUtils.exportToJSON(groups, filename);
            this.showToast(`Exported ${groups.length} groups to JSON`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    exportRolesToCSV() {
        try {
            const roles = this.cache.roles || [];
            if (roles.length === 0) {
                this.showToast('No roles to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('entra-roles');
            ExportUtils.exportToCSV(roles, filename, ExportConfigs.roles.columns);
            this.showToast(`Exported ${roles.length} roles to CSV`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    exportRolesToJSON() {
        try {
            const roles = this.cache.roles || [];
            if (roles.length === 0) {
                this.showToast('No roles to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('entra-roles');
            ExportUtils.exportToJSON(roles, filename);
            this.showToast(`Exported ${roles.length} roles to JSON`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    exportActivityToCSV() {
        try {
            const logs = this.paginators.activity.allItems || [];
            if (logs.length === 0) {
                this.showToast('No activity logs to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('pim-activity');
            ExportUtils.exportToCSV(logs, filename, ExportConfigs.activity.columns);
            this.showToast(`Exported ${logs.length} activity logs to CSV`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    exportActivityToJSON() {
        try {
            const logs = this.paginators.activity.allItems || [];
            if (logs.length === 0) {
                this.showToast('No activity logs to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('pim-activity');
            ExportUtils.exportToJSON(logs, filename);
            this.showToast(`Exported ${logs.length} activity logs to JSON`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    showExportMenu(type) {
        const content = `
            <div style="text-align: center; padding: var(--space-xl);">
                <div style="width: 80px; height: 80px; margin: 0 auto var(--space-lg); background: var(--accent-primary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-file-export" style="font-size: 2.5rem; color: var(--accent-primary);"></i>
                </div>

                <h2 style="font-family: var(--font-display); font-size: 1.5rem; font-weight: 800; margin-bottom: var(--space-md);">
                    Export ${type.charAt(0).toUpperCase() + type.slice(1)}
                </h2>

                <p style="font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-secondary); margin-bottom: var(--space-xl);">
                    Choose your preferred export format
                </p>

                <div style="display: flex; flex-direction: column; gap: var(--space-md); max-width: 400px; margin: 0 auto;">
                    <button class="btn btn-primary" onclick="app.export${type.charAt(0).toUpperCase() + type.slice(1)}ToCSV(); app.closeModal();" style="justify-content: center; font-family: var(--font-mono); padding: var(--space-md);">
                        <i class="fas fa-file-csv"></i> Export as CSV
                        <span style="font-size: 0.75rem; opacity: 0.7; margin-left: auto;">Spreadsheet compatible</span>
                    </button>

                    <button class="btn btn-secondary" onclick="app.export${type.charAt(0).toUpperCase() + type.slice(1)}ToJSON(); app.closeModal();" style="justify-content: center; font-family: var(--font-mono); padding: var(--space-md);">
                        <i class="fas fa-file-code"></i> Export as JSON
                        <span style="font-size: 0.75rem; opacity: 0.7; margin-left: auto;">Developer friendly</span>
                    </button>
                </div>

                <button class="btn btn-secondary btn-sm" onclick="app.closeModal()" style="margin-top: var(--space-xl); font-family: var(--font-mono);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        `;

        this.showModal(content);
    }

    viewTemplateDetails(templateId) {
        const template = templateService.getTemplate(templateId);
        if (!template) {
            this.showToast('Template not found', 'error');
            return;
        }

        const settings = template.settings;
        const html = `
            <h2><i class="fas ${template.icon}"></i> ${this.escapeHtml(template.name)}</h2>
            <p>${this.escapeHtml(template.description)}</p>

            <div class="template-detail-sections">
                <div class="detail-section">
                    <h3>Activation Settings</h3>
                    <table class="settings-table">
                        <tr><td>Maximum Duration</td><td>${settings.activation.maximumDurationHours} hours</td></tr>
                        <tr><td>Require MFA</td><td>${settings.activation.requireMfa ? '<span class="badge success">Yes</span>' : '<span class="badge">No</span>'}</td></tr>
                        <tr><td>Require Justification</td><td>${settings.activation.requireJustification ? '<span class="badge success">Yes</span>' : '<span class="badge">No</span>'}</td></tr>
                        <tr><td>Require Ticket Info</td><td>${settings.activation.requireTicketInfo ? '<span class="badge success">Yes</span>' : '<span class="badge">No</span>'}</td></tr>
                        <tr><td>Require Approval</td><td>${settings.activation.requireApproval ? '<span class="badge warning">Yes</span>' : '<span class="badge">No</span>'}</td></tr>
                    </table>
                </div>

                <div class="detail-section">
                    <h3>Eligible Assignment Settings</h3>
                    <table class="settings-table">
                        <tr><td>Allow Permanent</td><td>${settings.eligibleAssignment.allowPermanent ? '<span class="badge">Yes</span>' : '<span class="badge warning">No</span>'}</td></tr>
                        <tr><td>Maximum Duration</td><td>${settings.eligibleAssignment.maximumDurationDays} days</td></tr>
                    </table>
                </div>

                <div class="detail-section">
                    <h3>Active Assignment Settings</h3>
                    <table class="settings-table">
                        <tr><td>Allow Permanent</td><td>${settings.activeAssignment.allowPermanent ? '<span class="badge">Yes</span>' : '<span class="badge warning">No</span>'}</td></tr>
                        <tr><td>Maximum Duration</td><td>${settings.activeAssignment.maximumDurationDays} days</td></tr>
                    </table>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="app.closeModal(); app.applyTemplate('${templateId}')">
                    <i class="fas fa-play"></i> Apply Template
                </button>
            </div>
        `;

        this.showModal(html);
    }

    async applyTemplate(templateId) {
        const template = templateService.getTemplate(templateId);
        if (!template) {
            this.showToast('Template not found', 'error');
            return;
        }

        // Load groups if not cached
        if (!this.cache.groups) {
            this.showLoading('Loading groups...');
            const result = await graphService.getPIMGroups();
            this.hideLoading();
            if (result.success) {
                this.cache.groups = result.groups;
            } else {
                this.showToast(result.error, 'error');
                return;
            }
        }

        const groups = this.cache.groups || [];

        if (groups.length === 0) {
            this.showToast('No PIM groups found to apply template', 'warning');
            return;
        }

        const html = `
            <h2><i class="fas fa-copy"></i> Apply Template: ${this.escapeHtml(template.name)}</h2>
            <p>Select the groups to apply this policy template to.</p>

            <div class="template-summary">
                <div class="summary-item"><span>Max Duration:</span> ${template.settings.activation.maximumDurationHours}h</div>
                <div class="summary-item"><span>MFA:</span> ${template.settings.activation.requireMfa ? 'Required' : 'Optional'}</div>
                <div class="summary-item"><span>Approval:</span> ${template.settings.activation.requireApproval ? 'Required' : 'Optional'}</div>
            </div>

            <div class="group-select-toolbar">
                <button type="button" class="btn btn-sm btn-secondary" onclick="app.selectAllGroups(true)">Select All</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="app.selectAllGroups(false)">Deselect All</button>
                <input type="text" class="input input-sm" placeholder="Filter groups..." oninput="app.filterTemplateGroups(this.value)">
            </div>

            <div class="group-select-list" id="template-group-list">
                ${groups.map(g => `
                    <label class="group-select-item" data-name="${this.escapeHtml(g.displayName.toLowerCase())}">
                        <input type="checkbox" name="template-groups" value="${g.id}">
                        <div class="group-info">
                            <strong>${this.escapeHtml(g.displayName)}</strong>
                            <span class="group-description">${this.escapeHtml(g.description || 'No description')}</span>
                        </div>
                    </label>
                `).join('')}
            </div>

            <div id="apply-progress" class="apply-progress hidden"></div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                <button type="button" class="btn btn-primary" id="apply-template-btn" onclick="app.executeApplyTemplate('${templateId}')">
                    <i class="fas fa-play"></i> Apply to Selected
                </button>
            </div>
        `;

        this.showModal(html);
    }

    selectAllGroups(select) {
        const checkboxes = document.querySelectorAll('input[name="template-groups"]');
        checkboxes.forEach(cb => cb.checked = select);
    }

    filterTemplateGroups(query) {
        const items = document.querySelectorAll('.group-select-item');
        const q = query.toLowerCase();
        items.forEach(item => {
            const name = item.dataset.name;
            item.style.display = name.includes(q) ? '' : 'none';
        });
    }

    async executeApplyTemplate(templateId) {
        const template = templateService.getTemplate(templateId);
        const selectedGroups = Array.from(document.querySelectorAll('input[name="template-groups"]:checked'))
            .map(cb => cb.value);

        if (selectedGroups.length === 0) {
            this.showToast('Please select at least one group', 'warning');
            return;
        }

        const progressDiv = document.getElementById('apply-progress');
        const applyBtn = document.getElementById('apply-template-btn');

        progressDiv.classList.remove('hidden');
        applyBtn.disabled = true;
        applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying...';

        const results = { success: 0, failed: 0, errors: [] };

        for (let i = 0; i < selectedGroups.length; i++) {
            const groupId = selectedGroups[i];
            const group = this.cache.groups?.find(g => g.id === groupId);
            const groupName = group?.displayName || groupId;

            progressDiv.innerHTML = `
                <div class="progress-info">
                    <span>Applying to ${this.escapeHtml(groupName)}...</span>
                    <span>${i + 1} / ${selectedGroups.length}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${((i + 1) / selectedGroups.length) * 100}%"></div>
                </div>
            `;

            const result = await graphService.updateGroupPolicy(groupId, 'member', {
                maximumDurationHours: template.settings.activation.maximumDurationHours,
                requireMfa: template.settings.activation.requireMfa,
                requireJustification: template.settings.activation.requireJustification,
                requireTicketInfo: template.settings.activation.requireTicketInfo,
                requireApproval: template.settings.activation.requireApproval
            });

            if (result.success) {
                results.success++;
            } else {
                results.failed++;
                results.errors.push({ group: groupName, error: result.error });
            }
        }

        // Show results
        progressDiv.innerHTML = `
            <div class="apply-results ${results.failed > 0 ? 'has-errors' : 'success'}">
                <div class="results-summary">
                    <i class="fas ${results.failed === 0 ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
                    <div>
                        <strong>${results.success} group(s) updated successfully</strong>
                        ${results.failed > 0 ? `<p class="error-text">${results.failed} group(s) failed</p>` : ''}
                    </div>
                </div>
                ${results.errors.length > 0 ? `
                    <div class="error-list">
                        ${results.errors.map(e => `<div class="error-item"><strong>${this.escapeHtml(e.group)}:</strong> ${this.escapeHtml(e.error)}</div>`).join('')}
                    </div>
                ` : ''}
            </div>
        `;

        applyBtn.innerHTML = '<i class="fas fa-check"></i> Done';
        applyBtn.onclick = () => this.closeModal();

        if (results.success > 0) {
            this.showToast(`Template applied to ${results.success} group(s)`, 'success');
        }
    }

    async selectRoleForPolicy(roleId, roleName) {
        // Update selection state in the list
        document.querySelectorAll('.policy-item').forEach(item => item.classList.remove('selected'));
        event?.currentTarget?.classList.add('selected');

        const editorContainer = document.querySelector('.policy-editor');
        editorContainer.innerHTML = `
            <div class="loading-inline">
                <i class="fas fa-spinner fa-spin"></i> Loading policy for ${this.escapeHtml(roleName)}...
            </div>
        `;

        const result = await graphService.getRolePolicy(roleId);

        if (!result.success) {
            editorContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Could not load policy</h3>
                    <p>${this.escapeHtml(result.error)}</p>
                </div>
            `;
            return;
        }

        const settings = result.settings;

        editorContainer.innerHTML = `
            <div class="policy-editor-content">
                <div class="policy-header">
                    <h2>${this.escapeHtml(roleName)}</h2>
                    <span class="policy-id">Policy ID: ${result.policyId}</span>
                </div>

                <form id="role-policy-form" data-role-id="${roleId}">
                    <div class="policy-section">
                        <h3><i class="fas fa-clock"></i> Activation Settings</h3>
                        <p class="section-description">Configure what happens when a user activates this role.</p>

                        <div class="form-group">
                            <label>Maximum Activation Duration</label>
                            <div class="input-with-unit">
                                <input type="number" id="role-max-duration" class="input" value="${settings.activation.maximumDurationHours}" min="1" max="24">
                                <span class="unit">hours</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Requirements</label>
                            <div class="checkbox-group vertical">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="role-require-mfa" ${settings.activation.requireMfa ? 'checked' : ''}>
                                    <span class="checkbox-text">
                                        <strong>Require MFA</strong>
                                        <small>User must complete multi-factor authentication</small>
                                    </span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="role-require-justification" ${settings.activation.requireJustification ? 'checked' : ''}>
                                    <span class="checkbox-text">
                                        <strong>Require Justification</strong>
                                        <small>User must provide a reason for activation</small>
                                    </span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="role-require-ticket" ${settings.activation.requireTicketInfo ? 'checked' : ''}>
                                    <span class="checkbox-text">
                                        <strong>Require Ticket Information</strong>
                                        <small>User must provide a ticket number</small>
                                    </span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="role-require-approval" ${settings.activation.requireApproval ? 'checked' : ''}>
                                    <span class="checkbox-text">
                                        <strong>Require Approval</strong>
                                        <small>An approver must approve the activation request</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="policy-section">
                        <h3><i class="fas fa-user-clock"></i> Eligible Assignment Settings</h3>
                        <div class="settings-summary">
                            <div class="summary-row">
                                <span>Allow Permanent:</span>
                                <span>${settings.eligibleAssignment.allowPermanent ? 'Yes' : 'No'}</span>
                            </div>
                            <div class="summary-row">
                                <span>Max Duration:</span>
                                <span>${settings.eligibleAssignment.maximumDurationDays} days</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.applyTemplateToRole('${roleId}')">
                            <i class="fas fa-copy"></i> Apply Template
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        `;

        // Add form submit handler
        document.getElementById('role-policy-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await this.saveRolePolicy(roleId, roleName);
        });
    }

    async saveRolePolicy(roleId, roleName) {
        const settings = {
            maximumDurationHours: parseInt(document.getElementById('role-max-duration').value),
            requireMfa: document.getElementById('role-require-mfa').checked,
            requireJustification: document.getElementById('role-require-justification').checked,
            requireTicketInfo: document.getElementById('role-require-ticket').checked,
            requireApproval: document.getElementById('role-require-approval').checked
        };

        this.showLoading('Saving policy...');
        const result = await graphService.updateRolePolicy(roleId, settings);
        this.hideLoading();

        if (result.success) {
            this.showToast(`Policy updated for ${roleName}`, 'success');
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async applyTemplateToRole(roleId) {
        const templates = templateService.getAllTemplates();

        const html = `
            <h2><i class="fas fa-copy"></i> Apply Template to Role</h2>
            <p>Select a template to apply its settings to this role's PIM policy.</p>

            <div class="template-select-list">
                ${Object.values(templates).map(t => `
                    <div class="template-select-item" onclick="app.executeApplyTemplateToRole('${roleId}', '${t.id}')">
                        <div class="template-icon ${t.color || 'primary'}">
                            <i class="fas ${t.icon}"></i>
                        </div>
                        <div class="template-info">
                            <strong>${this.escapeHtml(t.name)}</strong>
                            <span>${t.settings.activation.maximumDurationHours}h | MFA: ${t.settings.activation.requireMfa ? 'Yes' : 'No'} | Approval: ${t.settings.activation.requireApproval ? 'Yes' : 'No'}</span>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
            </div>
        `;

        this.showModal(html);
    }

    async executeApplyTemplateToRole(roleId, templateId) {
        const template = templateService.getTemplate(templateId);
        if (!template) {
            this.showToast('Template not found', 'error');
            return;
        }

        this.closeModal();
        this.showLoading('Applying template...');

        const result = await graphService.updateRolePolicy(roleId, {
            maximumDurationHours: template.settings.activation.maximumDurationHours,
            requireMfa: template.settings.activation.requireMfa,
            requireJustification: template.settings.activation.requireJustification,
            requireTicketInfo: template.settings.activation.requireTicketInfo,
            requireApproval: template.settings.activation.requireApproval
        });

        this.hideLoading();

        if (result.success) {
            this.showToast('Template applied successfully', 'success');
            // Refresh the policy view
            const roleName = document.querySelector('.policy-editor h2')?.textContent;
            if (roleName) {
                await this.selectRoleForPolicy(roleId, roleName);
            }
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async configureRolePolicy(roleId) {
        // Get role name from cache
        const role = this.cache.roles?.find(r => r.id === roleId);
        const roleName = role?.displayName || 'Unknown Role';

        // Navigate to policies page and select this role
        this.navigateTo('policies');

        // Wait for page to render, then select the role
        setTimeout(() => {
            this.selectRoleForPolicy(roleId, roleName);
        }, 100);
    }

    exportConfig() {
        this.showToast('Export coming soon', 'info');
    }

    handleImport(files) {
        if (files.length > 0) {
            this.showToast(`Selected file: ${files[0].name}`, 'info');
        }
    }

    // ==========================================
    // UI Helpers
    // ==========================================

    showLoading(text = 'Loading...') {
        document.getElementById('loading-text').textContent = text;
        document.getElementById('loading-overlay').classList.remove('hidden');
    }

    hideLoading() {
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${this.escapeHtml(message)}</span>
        `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    showModal(content) {
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('modal-container').classList.remove('hidden');
    }

    closeModal() {
        document.getElementById('modal-container').classList.add('hidden');
    }

    // ==========================================
    // New Feature Pages
    // ==========================================

    async renderPIMActivity(container) {
        let allLogs = [];

        if (this.isConnected) {
            this.showLoading('Loading PIM activity...');
            const result = await graphService.getPIMAuditLogs(30); // Last 30 days
            if (result.success) {
                allLogs = result.logs;
            }
            this.hideLoading();
        }

        // Update paginator with all logs
        this.paginators.activity.updateItems(allLogs);

        // Get current page items
        const logs = this.paginators.activity.getCurrentPageItems();

        const formatDate = (dateStr) => {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString();
        };

        const getActivityIcon = (displayName) => {
            if (displayName?.includes('Add') || displayName?.includes('Create')) return 'fa-plus success';
            if (displayName?.includes('Remove') || displayName?.includes('Delete')) return 'fa-trash danger';
            if (displayName?.includes('Update')) return 'fa-edit warning';
            if (displayName?.includes('Assign')) return 'fa-user-check primary';
            return 'fa-circle info';
        };

        container.innerHTML = `
            <!-- Dramatic Page Header -->
            <div style="position: relative; margin-bottom: var(--space-2xl); overflow: hidden;">
                <div style="position: absolute; top: -50%; right: -5%; width: 300px; height: 300px; background: radial-gradient(circle, var(--accent-secondary-dim), transparent); filter: blur(80px); animation: float 10s ease-in-out infinite;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: inline-flex; align-items: center; gap: var(--space-xs); padding: var(--space-xs) var(--space-md); background: rgba(255, 0, 128, 0.05); border: 1px solid var(--accent-secondary); border-radius: var(--radius-full); margin-bottom: var(--space-md); font-family: var(--font-mono); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.15em;">
                        <i class="fas fa-database" style="color: var(--accent-secondary); font-size: 0.7rem;"></i>
                        <span style="color: var(--accent-secondary); font-weight: 600;">AUDIT TRAIL</span>
                        <span style="color: var(--text-muted);">|</span>
                        <span style="color: var(--text-secondary);">30 DAY HISTORY</span>
                    </div>
                    <h1 style="font-family: var(--font-display); font-size: clamp(2rem, 4vw, 3rem); font-weight: 800; line-height: 1.1; margin-bottom: var(--space-sm); letter-spacing: -0.03em;">
                        <span style="background: linear-gradient(135deg, var(--accent-secondary), #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 30px rgba(255, 0, 128, 0.3));">
                            ACTIVITY
                        </span>
                        <span style="color: var(--text-primary);"> LOG</span>
                    </h1>
                    <p style="font-size: 0.95rem; color: var(--text-secondary); font-family: var(--font-mono);">
                        Complete audit trail of privileged role management events
                    </p>
                </div>
            </div>

            <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--border-subtle);">
                <div style="position: absolute; top: 0; right: 0; width: 400px; height: 400px; background: radial-gradient(circle, var(--accent-secondary-dim), transparent); filter: blur(100px);"></div>

                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-lg); border-bottom: 1px solid var(--border-subtle);">
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <div style="width: 48px; height: 48px; background: var(--accent-secondary-dim); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-history" style="color: var(--accent-secondary); font-size: 1.3rem;"></i>
                            </div>
                            <div>
                                <h2 style="font-family: var(--font-display); font-size: 1.4rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Event Stream
                                </h2>
                                <div style="font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">
                                    ${allLogs.length} recorded events
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary btn-sm" onclick="app.showExportMenu('activity')" ${!this.isConnected || allLogs.length === 0 ? 'disabled' : ''} style="font-family: var(--font-mono);">
                                <i class="fas fa-file-export"></i> EXPORT
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="app.refreshCurrentPage()" ${!this.isConnected ? 'disabled' : ''} style="font-family: var(--font-mono);">
                                <i class="fas fa-sync"></i> REFRESH
                            </button>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        ${logs.length > 0 ? `
                            <table class="table" style="margin: 0;">
                                <thead>
                                    <tr style="background: rgba(0, 0, 0, 0.3);">
                                        <th style="width: 40px; font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;"></th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Activity</th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Initiated By</th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Target</th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Timestamp</th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${logs.map((log, idx) => `
                                        <tr style="border-bottom: 1px solid var(--border-subtle); background: ${idx % 2 === 0 ? 'rgba(255, 0, 128, 0.02)' : 'transparent'};">
                                            <td>
                                                <div style="width: 28px; height: 28px; border-radius: 50%; background: rgba(255, 0, 128, 0.1); display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas ${getActivityIcon(log.activityDisplayName).split(' ')[0]}" style="font-size: 0.75rem; color: var(--accent-secondary);"></i>
                                                </div>
                                            </td>
                                            <td>
                                                <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; color: var(--text-primary);">${this.escapeHtml(log.activityDisplayName || 'Unknown Activity')}</div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono);">${this.escapeHtml(log.category || 'N/A')}</div>
                                            </td>
                                            <td>
                                                <div style="font-size: 0.9rem; font-weight: 500; color: var(--text-primary);">${this.escapeHtml(log.initiatedBy?.user?.displayName || 'System')}</div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono);">${this.escapeHtml(log.initiatedBy?.user?.userPrincipalName || 'N/A')}</div>
                                            </td>
                                            <td>
                                                ${log.targetResources?.map(t => `
                                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${this.escapeHtml(t.displayName || t.id || 'N/A')}</div>
                                                `).join('') || '<span style="color: var(--text-muted); font-family: var(--font-mono); font-size: 0.75rem;">N/A</span>'}
                                            </td>
                                            <td style="white-space: nowrap; font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-secondary);">
                                                ${formatDate(log.activityDateTime)}
                                            </td>
                                            <td>
                                                <span class="badge" style="background: ${log.result === 'success' ? 'var(--color-success-dim)' : 'var(--color-error-dim)'}; color: ${log.result === 'success' ? 'var(--color-success)' : 'var(--color-error)'}; font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase;">
                                                    ${log.result === 'success' ? '✓ SUCCESS' : '✗ FAILED'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : `
                            <div style="text-align: center; padding: var(--space-2xl) var(--space-lg); color: var(--text-secondary);">
                                <div style="width: 120px; height: 120px; margin: 0 auto var(--space-xl); background: var(--accent-secondary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-history" style="font-size: 3.5rem; color: var(--accent-secondary); opacity: 0.5;"></i>
                                </div>
                                <div style="font-family: var(--font-display); font-size: 1.5rem; font-weight: 700; margin-bottom: var(--space-sm); color: var(--text-primary);">
                                    No Activity Detected
                                </div>
                                <div style="font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-muted);">
                                    ${this.isConnected ? 'No audit logs found in the last 30 days' : 'Connect to Microsoft Entra ID to view activity logs'}
                                </div>
                            </div>
                        `}
                    </div>

                    ${this.paginators.activity.renderControls('app.handleActivityPageChange')}
                </div>
            </div>
        `;
    }

    async renderPendingApprovals(container) {
        let approvals = [];
        let count = 0;

        if (this.isConnected) {
            this.showLoading('Loading pending approvals...');
            const result = await graphService.getPendingApprovals();
            if (result.success) {
                approvals = result.requests;
                count = result.count;
            }
            this.hideLoading();
        }

        const formatDate = (dateStr) => {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString();
        };

        container.innerHTML = `
            <!-- Dramatic Page Header -->
            <div style="position: relative; margin-bottom: var(--space-2xl); overflow: hidden;">
                <div style="position: absolute; top: -50%; left: -5%; width: 300px; height: 300px; background: radial-gradient(circle, var(--color-warning-dim), transparent); filter: blur(80px); animation: float 12s ease-in-out infinite;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: inline-flex; align-items: center; gap: var(--space-xs); padding: var(--space-xs) var(--space-md); background: rgba(255, 170, 0, 0.05); border: 1px solid var(--color-warning); border-radius: var(--radius-full); margin-bottom: var(--space-md); font-family: var(--font-mono); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.15em;">
                        <i class="fas fa-bell" style="color: var(--color-warning); font-size: 0.7rem;"></i>
                        <span style="color: var(--color-warning); font-weight: 600;">APPROVAL QUEUE</span>
                        <span style="color: var(--text-muted);">|</span>
                        <span style="color: var(--text-secondary);">${count} PENDING</span>
                    </div>
                    <h1 style="font-family: var(--font-display); font-size: clamp(2rem, 4vw, 3rem); font-weight: 800; line-height: 1.1; margin-bottom: var(--space-sm); letter-spacing: -0.03em;">
                        <span style="background: linear-gradient(135deg, var(--color-warning), #ffdd00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 30px rgba(255, 170, 0, 0.3));">
                            PENDING
                        </span>
                        <span style="color: var(--text-primary);"> APPROVALS</span>
                    </h1>
                    <p style="font-size: 0.95rem; color: var(--text-secondary); font-family: var(--font-mono);">
                        Review and authorize privileged role activation requests
                    </p>
                </div>
            </div>

            <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid ${count > 0 ? 'var(--color-warning)' : 'var(--border-subtle)'};">
                <div style="position: absolute; top: 0; left: 0; width: 400px; height: 400px; background: radial-gradient(circle, ${count > 0 ? 'rgba(255, 170, 0, 0.05)' : 'var(--accent-primary-dim)'}, transparent); filter: blur(100px);"></div>

                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-lg); border-bottom: 1px solid var(--border-subtle);">
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <div style="width: 48px; height: 48px; background: ${count > 0 ? 'var(--color-warning-dim)' : 'var(--accent-primary-dim)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-clock" style="color: ${count > 0 ? 'var(--color-warning)' : 'var(--accent-primary)'}; font-size: 1.3rem;"></i>
                            </div>
                            <div>
                                <h2 style="font-family: var(--font-display); font-size: 1.4rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Approval Queue
                                </h2>
                                <div style="font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">
                                    ${count} requests awaiting review
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="app.refreshCurrentPage()" ${!this.isConnected ? 'disabled' : ''} style="font-family: var(--font-mono);">
                            <i class="fas fa-sync"></i> REFRESH
                        </button>
                    </div>

                    <div style="padding: var(--space-md);">
                        ${approvals.length > 0 ? approvals.map((approval, idx) => `
                            <div style="background: rgba(255, 170, 0, 0.05); border: 1px solid var(--color-warning); border-radius: var(--radius-lg); padding: var(--space-lg); margin-bottom: var(--space-md); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: 0; right: 0; width: 150px; height: 150px; background: radial-gradient(circle, rgba(255, 170, 0, 0.1), transparent); filter: blur(40px);"></div>
                                <div style="position: relative; z-index: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: var(--space-lg); margin-bottom: var(--space-lg);">
                                        <div style="flex: 1;">
                                            <!-- User Info -->
                                            <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-md);">
                                                <div style="width: 36px; height: 36px; background: var(--accent-primary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-user" style="color: var(--accent-primary); font-size: 1rem;"></i>
                                                </div>
                                                <div>
                                                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary);">
                                                        ${this.escapeHtml(approval.principal?.displayName || 'Unknown User')}
                                                    </div>
                                                    <div style="font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono);">
                                                        ${this.escapeHtml(approval.principal?.userPrincipalName || 'N/A')}
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Role -->
                                            <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-md); padding: var(--space-sm) var(--space-md); background: rgba(0, 255, 159, 0.05); border-left: 3px solid var(--accent-primary); border-radius: var(--radius-sm);">
                                                <i class="fas fa-shield-check" style="color: var(--accent-primary);"></i>
                                                <div>
                                                    <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); font-family: var(--font-mono); margin-bottom: 2px;">
                                                        REQUESTING ROLE
                                                    </div>
                                                    <div style="font-weight: 600; color: var(--text-primary);">
                                                        ${this.escapeHtml(approval.roleDefinition?.displayName || 'Unknown Role')}
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Justification -->
                                            <div style="background: rgba(0, 0, 0, 0.2); padding: var(--space-md); border-radius: var(--radius-sm); margin-bottom: var(--space-md);">
                                                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); font-family: var(--font-mono); margin-bottom: var(--space-xs);">
                                                    <i class="fas fa-comment-dots"></i> JUSTIFICATION
                                                </div>
                                                <div style="color: var(--text-secondary); line-height: 1.5; font-size: 0.9rem;">
                                                    ${this.escapeHtml(approval.justification || 'No justification provided')}
                                                </div>
                                            </div>

                                            <!-- Timestamp -->
                                            <div style="display: flex; align-items: center; gap: var(--space-xs); font-size: 0.8rem; color: var(--text-muted); font-family: var(--font-mono);">
                                                <i class="fas fa-clock"></i>
                                                <span>Requested: ${formatDate(approval.createdDateTime)}</span>
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div style="display: flex; flex-direction: column; gap: var(--space-sm); min-width: 140px;">
                                            <button class="btn btn-success" onclick="app.reviewApproval('${approval.id}', 'approve')" style="width: 100%; font-family: var(--font-mono); font-size: 0.85rem; padding: var(--space-md);">
                                                <i class="fas fa-check-circle"></i> APPROVE
                                            </button>
                                            <button class="btn btn-danger" onclick="app.reviewApproval('${approval.id}', 'deny')" style="width: 100%; font-family: var(--font-mono); font-size: 0.85rem; padding: var(--space-md);">
                                                <i class="fas fa-times-circle"></i> DENY
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('') : `
                            <div style="text-align: center; padding: var(--space-2xl) var(--space-lg); color: var(--text-secondary);">
                                <div style="width: 120px; height: 120px; margin: 0 auto var(--space-xl); background: var(--accent-primary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-check-double" style="font-size: 3.5rem; color: var(--accent-primary); opacity: 0.5;"></i>
                                </div>
                                <div style="font-family: var(--font-display); font-size: 1.5rem; font-weight: 700; margin-bottom: var(--space-sm); color: var(--text-primary);">
                                    All Caught Up
                                </div>
                                <div style="font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-muted);">
                                    ${this.isConnected ? 'No pending approval requests in the queue' : 'Connect to Microsoft Entra ID to view pending approvals'}
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    async reviewApproval(requestId, decision) {
        const justification = prompt(`${decision === 'approve' ? 'Approve' : 'Deny'} this request?\n\nEnter justification:`);
        if (!justification) return;

        this.showLoading(`${decision === 'approve' ? 'Approving' : 'Denying'} request...`);
        const result = await graphService.reviewApprovalRequest(requestId, decision, justification);
        this.hideLoading();

        if (result.success) {
            this.showToast(`Request ${decision === 'approve' ? 'approved' : 'denied'} successfully`, 'success');
            this.refreshCurrentPage();
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async renderExpiringAssignments(container) {
        let assignments = [];
        let expiringCount = 0;

        if (this.isConnected) {
            this.showLoading('Loading expiring assignments...');
            const result = await graphService.getRoleAssignmentsWithExpiration();
            if (result.success) {
                assignments = result.expiringAssignments;
                expiringCount = result.expiringCount;
            }
            this.hideLoading();
        }

        const formatDate = (dateStr) => {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString();
        };

        const formatRelativeTime = (dateStr) => {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = date - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h`;
            if (diff > 0) return '< 1h';
            return 'Expired';
        };

        container.innerHTML = `
            <!-- Dramatic Page Header -->
            <div style="position: relative; margin-bottom: var(--space-2xl); overflow: hidden;">
                <div style="position: absolute; top: -50%; right: -5%; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255, 100, 0, 0.1), transparent); filter: blur(80px); animation: float 10s ease-in-out infinite;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: inline-flex; align-items: center; gap: var(--space-xs); padding: var(--space-xs) var(--space-md); background: rgba(255, 100, 0, 0.05); border: 1px solid #ff6400; border-radius: var(--radius-full); margin-bottom: var(--space-md); font-family: var(--font-mono); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.15em;">
                        <i class="fas fa-exclamation-triangle" style="color: #ff6400; font-size: 0.7rem;"></i>
                        <span style="color: #ff6400; font-weight: 600;">TIME SENSITIVE</span>
                        <span style="color: var(--text-muted);">|</span>
                        <span style="color: var(--text-secondary);">${expiringCount} EXPIRING</span>
                    </div>
                    <h1 style="font-family: var(--font-display); font-size: clamp(2rem, 4vw, 3rem); font-weight: 800; line-height: 1.1; margin-bottom: var(--space-sm); letter-spacing: -0.03em;">
                        <span style="background: linear-gradient(135deg, #ff6400, #ff0080); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 30px rgba(255, 100, 0, 0.3));">
                            EXPIRING
                        </span>
                        <span style="color: var(--text-primary);"> ASSIGNMENTS</span>
                    </h1>
                    <p style="font-size: 0.95rem; color: var(--text-secondary); font-family: var(--font-mono);">
                        Role assignments expiring within 7 days - immediate attention required
                    </p>
                </div>
            </div>

            <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid ${expiringCount > 0 ? '#ff6400' : 'var(--border-subtle)'};">
                <div style="position: absolute; top: 0; right: 0; width: 400px; height: 400px; background: radial-gradient(circle, ${expiringCount > 0 ? 'rgba(255, 100, 0, 0.05)' : 'var(--accent-primary-dim)'}, transparent); filter: blur(100px);"></div>

                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-lg); border-bottom: 1px solid var(--border-subtle);">
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <div style="width: 48px; height: 48px; background: ${expiringCount > 0 ? 'rgba(255, 100, 0, 0.1)' : 'var(--accent-primary-dim)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-hourglass-end" style="color: ${expiringCount > 0 ? '#ff6400' : 'var(--accent-primary)'}; font-size: 1.3rem;"></i>
                            </div>
                            <div>
                                <h2 style="font-family: var(--font-display); font-size: 1.4rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Expiring Assignments
                                </h2>
                                <div style="font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">
                                    ${expiringCount} assignments require renewal
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="app.refreshCurrentPage()" ${!this.isConnected ? 'disabled' : ''} style="font-family: var(--font-mono);">
                            <i class="fas fa-sync"></i> REFRESH
                        </button>
                    </div>

                    <div style="overflow-x: auto;">
                        ${assignments.length > 0 ? `
                            <table class="table" style="margin: 0;">
                                <thead>
                                    <tr style="background: rgba(0, 0, 0, 0.3);">
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Principal</th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Role</th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Type</th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Expiration Date</th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Time Left</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${assignments.map((assignment, idx) => {
                                        const timeLeft = formatRelativeTime(assignment.endDateTime);
                                        const isUrgent = timeLeft.includes('h') || timeLeft === 'Expired';
                                        return `
                                        <tr style="border-bottom: 1px solid var(--border-subtle); background: ${idx % 2 === 0 ? 'rgba(255, 100, 0, 0.02)' : 'transparent'};">
                                            <td>
                                                <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; color: var(--text-primary);">${this.escapeHtml(assignment.principal?.displayName || 'Unknown')}</div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono);">
                                                    ${this.escapeHtml(assignment.principal?.userPrincipalName || assignment.principal?.mail || 'N/A')}
                                                </div>
                                            </td>
                                            <td style="font-size: 0.9rem; font-weight: 500; color: var(--text-primary);">
                                                ${this.escapeHtml(assignment.roleDefinition?.displayName || 'Unknown Role')}
                                            </td>
                                            <td>
                                                <span class="badge" style="background: ${assignment.type === 'active' ? 'var(--color-success-dim)' : 'var(--bg-elevated)'}; color: ${assignment.type === 'active' ? 'var(--color-success)' : 'var(--text-secondary)'}; font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase;">
                                                    ${assignment.type}
                                                </span>
                                            </td>
                                            <td style="white-space: nowrap; font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-secondary);">
                                                ${formatDate(assignment.endDateTime)}
                                            </td>
                                            <td>
                                                <span class="badge" style="background: ${isUrgent ? 'rgba(255, 0, 85, 0.1)' : 'rgba(255, 100, 0, 0.1)'}; color: ${isUrgent ? 'var(--color-error)' : '#ff6400'}; font-family: var(--font-mono); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; padding: var(--space-xs) var(--space-sm); ${isUrgent ? 'animation: pulse 2s ease-in-out infinite;' : ''}">
                                                    ${isUrgent ? '⚠ ' : ''}${timeLeft}
                                                </span>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        ` : `
                            <div style="text-align: center; padding: var(--space-2xl) var(--space-lg); color: var(--text-secondary);">
                                <div style="width: 120px; height: 120px; margin: 0 auto var(--space-xl); background: var(--accent-primary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-check-circle" style="font-size: 3.5rem; color: var(--accent-primary); opacity: 0.5;"></i>
                                </div>
                                <div style="font-family: var(--font-display); font-size: 1.5rem; font-weight: 700; margin-bottom: var(--space-sm); color: var(--text-primary);">
                                    All Clear
                                </div>
                                <div style="font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-muted);">
                                    ${this.isConnected ? 'No role assignments expiring within the next 7 days' : 'Connect to Microsoft Entra ID to monitor expiring assignments'}
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    async renderHealthCheck(container) {
        let healthData = null;

        if (this.isConnected) {
            this.showLoading('Running health check...');
            const result = await graphService.runHealthCheck();
            if (result.success) {
                healthData = result;
            }
            this.hideLoading();
        }

        const getHealthColor = (status) => {
            switch(status) {
                case 'healthy': return 'success';
                case 'warning': return 'warning';
                case 'critical': return 'danger';
                default: return 'secondary';
            }
        };

        const getSeverityIcon = (severity) => {
            switch(severity) {
                case 'critical': return 'fa-times-circle danger';
                case 'warning': return 'fa-exclamation-triangle warning';
                case 'info': return 'fa-info-circle info';
                default: return 'fa-circle secondary';
            }
        };

        container.innerHTML = `
            <!-- Dramatic Page Header -->
            <div style="position: relative; margin-bottom: var(--space-2xl); overflow: hidden;">
                <div style="position: absolute; top: -50%; left: -5%; width: 300px; height: 300px; background: radial-gradient(circle, ${healthData?.status === 'healthy' ? 'var(--accent-primary-dim)' : healthData?.status === 'warning' ? 'var(--color-warning-dim)' : 'rgba(255, 0, 85, 0.1)'}, transparent); filter: blur(80px); animation: float 15s ease-in-out infinite;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: inline-flex; align-items: center; gap: var(--space-xs); padding: var(--space-xs) var(--space-md); background: ${healthData?.status === 'healthy' ? 'rgba(0, 255, 159, 0.05)' : healthData?.status === 'warning' ? 'rgba(255, 170, 0, 0.05)' : 'rgba(255, 0, 85, 0.05)'}; border: 1px solid ${healthData?.status === 'healthy' ? 'var(--accent-primary)' : healthData?.status === 'warning' ? 'var(--color-warning)' : 'var(--color-error)'}; border-radius: var(--radius-full); margin-bottom: var(--space-md); font-family: var(--font-mono); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.15em;">
                        <i class="fas fa-shield-check" style="color: ${healthData?.status === 'healthy' ? 'var(--accent-primary)' : healthData?.status === 'warning' ? 'var(--color-warning)' : 'var(--color-error)'}; font-size: 0.7rem;"></i>
                        <span style="color: ${healthData?.status === 'healthy' ? 'var(--accent-primary)' : healthData?.status === 'warning' ? 'var(--color-warning)' : 'var(--color-error)'}; font-weight: 600;">SECURITY SCAN</span>
                        <span style="color: var(--text-muted);">|</span>
                        <span style="color: var(--text-secondary);">${healthData ? healthData.checksRun + ' CHECKS' : 'READY'}</span>
                    </div>
                    <h1 style="font-family: var(--font-display); font-size: clamp(2rem, 4vw, 3rem); font-weight: 800; line-height: 1.1; margin-bottom: var(--space-sm); letter-spacing: -0.03em;">
                        <span style="background: linear-gradient(135deg, ${healthData?.status === 'healthy' ? 'var(--accent-primary), #00ffff' : healthData?.status === 'warning' ? 'var(--color-warning), #ffdd00' : 'var(--color-error), #ff0099'}); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 30px ${healthData?.status === 'healthy' ? 'rgba(0, 255, 159, 0.3)' : healthData?.status === 'warning' ? 'rgba(255, 170, 0, 0.3)' : 'rgba(255, 0, 85, 0.3)'});">
                            HEALTH
                        </span>
                        <span style="color: var(--text-primary);"> CHECK</span>
                    </h1>
                    <p style="font-size: 0.95rem; color: var(--text-secondary); font-family: var(--font-mono);">
                        Automated security scanner for PIM configuration compliance
                    </p>
                </div>
            </div>

            ${healthData ? `
                <!-- Massive Health Score Card -->
                <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 2px solid ${healthData.status === 'healthy' ? 'var(--accent-primary)' : healthData.status === 'warning' ? 'var(--color-warning)' : 'var(--color-error)'}; margin-bottom: var(--space-2xl);">
                    <div style="position: absolute; inset: 0; background: radial-gradient(circle at center, ${healthData.status === 'healthy' ? 'var(--accent-primary-dim)' : healthData.status === 'warning' ? 'rgba(255, 170, 0, 0.05)' : 'rgba(255, 0, 85, 0.05)'}, transparent); filter: blur(60px);"></div>
                    <div style="position: relative; z-index: 1; text-align: center; padding: var(--space-2xl);">
                        <!-- Circular Score Display -->
                        <div style="display: inline-flex; align-items: center; justify-content: center; width: 200px; height: 200px; border-radius: 50%; border: 12px solid ${healthData.status === 'healthy' ? 'var(--accent-primary)' : healthData.status === 'warning' ? 'var(--color-warning)' : 'var(--color-error)'}; margin-bottom: var(--space-lg); box-shadow: 0 0 60px ${healthData.status === 'healthy' ? 'rgba(0, 255, 159, 0.4)' : healthData.status === 'warning' ? 'rgba(255, 170, 0, 0.4)' : 'rgba(255, 0, 85, 0.4)'};">
                            <div>
                                <div style="font-family: var(--font-display); font-size: 4rem; font-weight: 900; line-height: 1; background: linear-gradient(135deg, ${healthData.status === 'healthy' ? 'var(--accent-primary), #00ffff' : healthData.status === 'warning' ? 'var(--color-warning), #ffdd00' : 'var(--color-error), #ff0099'}); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                    ${healthData.healthScore}
                                </div>
                                <div style="font-family: var(--font-mono); font-size: 1.2rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.15em;">
                                    %
                                </div>
                            </div>
                        </div>

                        <!-- Status -->
                        <h2 style="font-family: var(--font-display); font-size: 2rem; font-weight: 800; margin: 0 0 var(--space-sm) 0; text-transform: uppercase; letter-spacing: 0.05em; color: ${healthData.status === 'healthy' ? 'var(--accent-primary)' : healthData.status === 'warning' ? 'var(--color-warning)' : 'var(--color-error)'};">
                            ${healthData.status === 'healthy' ? '✓ HEALTHY' : healthData.status === 'warning' ? '⚠ WARNING' : '✗ CRITICAL'}
                        </h2>
                        <p style="color: var(--text-secondary); font-family: var(--font-mono); font-size: 0.9rem; margin-bottom: var(--space-lg);">
                            Based on ${healthData.checksRun} automated security checks
                        </p>
                        <button class="btn btn-primary" onclick="app.refreshCurrentPage()" style="font-family: var(--font-mono); padding: var(--space-md) var(--space-xl);">
                            <i class="fas fa-redo"></i> RE-RUN SCAN
                        </button>
                    </div>
                </div>

                <!-- Issues & Warnings Grid -->
                <div class="dashboard-grid">
                    <!-- Critical Issues -->
                    <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid ${healthData.issues.length > 0 ? 'var(--color-error)' : 'var(--border-subtle)'};">
                        <div style="position: absolute; top: 0; left: 0; width: 300px; height: 300px; background: radial-gradient(circle, ${healthData.issues.length > 0 ? 'rgba(255, 0, 85, 0.05)' : 'var(--accent-primary-dim)'}, transparent); filter: blur(80px);"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-lg); border-bottom: 1px solid var(--border-subtle);">
                                <div style="width: 48px; height: 48px; background: ${healthData.issues.length > 0 ? 'rgba(255, 0, 85, 0.1)' : 'var(--accent-primary-dim)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas ${healthData.issues.length > 0 ? 'fa-times-circle' : 'fa-check-circle'}" style="color: ${healthData.issues.length > 0 ? 'var(--color-error)' : 'var(--accent-primary)'}; font-size: 1.3rem;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h2 style="font-family: var(--font-display); font-size: 1.3rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                        Critical Issues
                                    </h2>
                                    <div style="font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">
                                        ${healthData.issues.length} items requiring immediate attention
                                    </div>
                                </div>
                                ${healthData.issues.length > 0 ? `<span class="badge" style="background: var(--color-error-dim); color: var(--color-error); font-family: var(--font-mono); font-size: 0.75rem; font-weight: 700; animation: pulse 2s ease-in-out infinite;">${healthData.issues.length}</span>` : ''}
                            </div>
                            <div style="max-height: 400px; overflow-y: auto; padding: var(--space-md);">
                                ${healthData.issues.length > 0 ? healthData.issues.map((issue, idx) => `
                                    <div style="background: rgba(255, 0, 85, 0.05); border-left: 3px solid var(--color-error); border-radius: var(--radius-sm); padding: var(--space-md); margin-bottom: var(--space-sm);">
                                        <div style="display: flex; align-items: start; gap: var(--space-sm);">
                                            <i class="fas fa-times-circle" style="color: var(--color-error); margin-top: 2px; font-size: 1.1rem;"></i>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 700; font-family: var(--font-mono); font-size: 0.8rem; text-transform: uppercase; color: var(--color-error); margin-bottom: var(--space-xs);">
                                                    ${this.escapeHtml(issue.category)}
                                                </div>
                                                <div style="color: var(--text-secondary); line-height: 1.5; font-size: 0.9rem;">
                                                    ${this.escapeHtml(issue.message)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div style="text-align: center; padding: var(--space-xl); color: var(--text-secondary);">
                                        <div style="width: 80px; height: 80px; margin: 0 auto var(--space-md); background: var(--accent-primary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-shield-check" style="font-size: 2.5rem; color: var(--accent-primary);"></i>
                                        </div>
                                        <div style="font-family: var(--font-display); font-size: 1.1rem; font-weight: 700; margin-bottom: var(--space-xs); color: var(--text-primary);">
                                            No Critical Issues
                                        </div>
                                        <div style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-muted);">
                                            Your PIM configuration is secure
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>

                    <!-- Warnings -->
                    <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid ${healthData.warnings.length > 0 ? 'var(--color-warning)' : 'var(--border-subtle)'};">
                        <div style="position: absolute; top: 0; right: 0; width: 300px; height: 300px; background: radial-gradient(circle, ${healthData.warnings.length > 0 ? 'rgba(255, 170, 0, 0.05)' : 'var(--accent-secondary-dim)'}, transparent); filter: blur(80px);"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-lg); border-bottom: 1px solid var(--border-subtle);">
                                <div style="width: 48px; height: 48px; background: ${healthData.warnings.length > 0 ? 'var(--color-warning-dim)' : 'var(--accent-secondary-dim)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas ${healthData.warnings.length > 0 ? 'fa-exclamation-triangle' : 'fa-check-circle'}" style="color: ${healthData.warnings.length > 0 ? 'var(--color-warning)' : 'var(--accent-secondary)'}; font-size: 1.3rem;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h2 style="font-family: var(--font-display); font-size: 1.3rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                        Warnings
                                    </h2>
                                    <div style="font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">
                                        ${healthData.warnings.length} recommendations for improvement
                                    </div>
                                </div>
                                ${healthData.warnings.length > 0 ? `<span class="badge" style="background: var(--color-warning-dim); color: var(--color-warning); font-family: var(--font-mono); font-size: 0.75rem; font-weight: 700;">${healthData.warnings.length}</span>` : ''}
                            </div>
                            <div style="max-height: 400px; overflow-y: auto; padding: var(--space-md);">
                                ${healthData.warnings.length > 0 ? healthData.warnings.map((warning, idx) => `
                                    <div style="background: rgba(255, 170, 0, 0.05); border-left: 3px solid var(--color-warning); border-radius: var(--radius-sm); padding: var(--space-md); margin-bottom: var(--space-sm);">
                                        <div style="display: flex; align-items: start; gap: var(--space-sm);">
                                            <i class="fas fa-exclamation-triangle" style="color: var(--color-warning); margin-top: 2px; font-size: 1.1rem;"></i>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 700; font-family: var(--font-mono); font-size: 0.8rem; text-transform: uppercase; color: var(--color-warning); margin-bottom: var(--space-xs);">
                                                    ${this.escapeHtml(warning.category)}
                                                </div>
                                                <div style="color: var(--text-secondary); line-height: 1.5; font-size: 0.9rem; margin-bottom: var(--space-xs);">
                                                    ${this.escapeHtml(warning.message)}
                                                </div>
                                                ${warning.groups ? `
                                                    <details style="margin-top: var(--space-sm);">
                                                        <summary style="cursor: pointer; color: var(--text-muted); font-size: 0.8rem; font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 0.05em;">► View Details (${warning.groups.length})</summary>
                                                        <ul style="margin-top: var(--space-sm); padding-left: var(--space-lg); color: var(--text-secondary); font-size: 0.85rem;">
                                                            ${warning.groups.map(g => `<li style="margin-bottom: var(--space-xs); font-family: var(--font-mono);">${this.escapeHtml(g)}</li>`).join('')}
                                                        </ul>
                                                    </details>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div style="text-align: center; padding: var(--space-xl); color: var(--text-secondary);">
                                        <div style="width: 80px; height: 80px; margin: 0 auto var(--space-md); background: var(--accent-secondary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-thumbs-up" style="font-size: 2.5rem; color: var(--accent-secondary);"></i>
                                        </div>
                                        <div style="font-family: var(--font-display); font-size: 1.1rem; font-weight: 700; margin-bottom: var(--space-xs); color: var(--text-primary);">
                                            No Warnings
                                        </div>
                                        <div style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-muted);">
                                            Configuration meets best practices
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--accent-primary);">
                    <div style="position: absolute; inset: 0; background: radial-gradient(circle at center, var(--accent-primary-dim), transparent); filter: blur(80px);"></div>
                    <div style="position: relative; z-index: 1; text-align: center; padding: var(--space-2xl);">
                        <div style="width: 150px; height: 150px; margin: 0 auto var(--space-xl); background: var(--accent-primary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 60px rgba(0, 255, 159, 0.3);">
                            <i class="fas fa-heart-pulse" style="font-size: 4.5rem; color: var(--accent-primary);"></i>
                        </div>
                        <h2 style="font-family: var(--font-display); font-size: 2rem; font-weight: 800; margin-bottom: var(--space-md); text-transform: uppercase; letter-spacing: 0.05em;">
                            <span style="background: linear-gradient(135deg, var(--accent-primary), #00ffff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                SCANNER READY
                            </span>
                        </h2>
                        <p style="color: var(--text-secondary); font-family: var(--font-mono); font-size: 0.95rem; margin-bottom: var(--space-xl); max-width: 500px; margin-left: auto; margin-right: auto;">
                            ${this.isConnected ? 'Launch automated security analysis to evaluate your PIM configuration against best practices' : 'Connect to Microsoft Entra ID to run comprehensive security health checks'}
                        </p>
                        <button class="btn btn-primary" onclick="app.refreshCurrentPage()" ${!this.isConnected ? 'disabled' : ''} style="font-family: var(--font-mono); padding: var(--space-md) var(--space-2xl); font-size: 1.1rem;">
                            <i class="fas fa-play-circle"></i> INITIATE SCAN
                        </button>
                    </div>
                </div>
            `}
        `;
    }

    async renderRoleCoverage(container) {
        let coverageData = null;

        if (this.isConnected) {
            this.showLoading('Generating coverage report...');
            const result = await graphService.getRoleCoverageReport();
            if (result.success) {
                coverageData = result;
            }
            this.hideLoading();
        }

        const calculatePercentage = (part, total) => {
            if (total === 0) return 0;
            return Math.round((part / total) * 100);
        };

        container.innerHTML = `
            <!-- Dramatic Page Header -->
            <div style="position: relative; margin-bottom: var(--space-2xl); overflow: hidden;">
                <div style="position: absolute; top: -50%; right: -5%; width: 300px; height: 300px; background: radial-gradient(circle, var(--accent-primary-dim), transparent); filter: blur(80px); animation: float 13s ease-in-out infinite;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: inline-flex; align-items: center; gap: var(--space-xs); padding: var(--space-xs) var(--space-md); background: rgba(0, 255, 159, 0.05); border: 1px solid var(--accent-primary); border-radius: var(--radius-full); margin-bottom: var(--space-md); font-family: var(--font-mono); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.15em;">
                        <i class="fas fa-chart-line" style="color: var(--accent-primary); font-size: 0.7rem;"></i>
                        <span style="color: var(--accent-primary); font-weight: 600;">ANALYTICS</span>
                        <span style="color: var(--text-muted);">|</span>
                        <span style="color: var(--text-secondary);">COVERAGE ANALYSIS</span>
                    </div>
                    <h1 style="font-family: var(--font-display); font-size: clamp(2rem, 4vw, 3rem); font-weight: 800; line-height: 1.1; margin-bottom: var(--space-sm); letter-spacing: -0.03em;">
                        <span style="background: linear-gradient(135deg, var(--accent-primary), #00ffff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 30px rgba(0, 255, 159, 0.3));">
                            ROLE
                        </span>
                        <span style="color: var(--text-primary);"> COVERAGE</span>
                    </h1>
                    <p style="font-size: 0.95rem; color: var(--text-secondary); font-family: var(--font-mono);">
                        PIM group coverage vs direct role assignments analysis
                    </p>
                </div>
            </div>

            ${coverageData ? `
                <!-- Summary Cards with Enhanced Design -->
                <div class="stats-grid" style="margin-bottom: var(--space-2xl);">
                    <div class="card stat-card" style="position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 50%; right: -20%; width: 150px; height: 150px; background: radial-gradient(circle, var(--accent-primary-dim), transparent); filter: blur(40px);"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="width: 56px; height: 56px; background: var(--accent-primary-dim); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-md);">
                                <i class="fas fa-shield-check" style="font-size: 1.5rem; color: var(--accent-primary);"></i>
                            </div>
                            <div style="font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: var(--space-xs); color: var(--text-primary);">
                                ${coverageData.totalRoles}
                            </div>
                            <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); font-family: var(--font-mono);">TOTAL ROLES</div>
                        </div>
                    </div>

                    <div class="card stat-card" style="position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 50%; right: -20%; width: 150px; height: 150px; background: radial-gradient(circle, var(--color-success-dim), transparent); filter: blur(40px);"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="width: 56px; height: 56px; background: var(--color-success-dim); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-md);">
                                <i class="fas fa-users" style="font-size: 1.5rem; color: var(--color-success);"></i>
                            </div>
                            <div style="font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: var(--space-xs); color: var(--text-primary);">
                                ${coverageData.totalPIMGroups}
                            </div>
                            <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); font-family: var(--font-mono);">PIM GROUPS</div>
                        </div>
                    </div>

                    <div class="card stat-card" style="position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 50%; right: -20%; width: 150px; height: 150px; background: radial-gradient(circle, var(--accent-secondary-dim), transparent); filter: blur(40px);"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="width: 56px; height: 56px; background: var(--accent-secondary-dim); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-md);">
                                <i class="fas fa-check-double" style="font-size: 1.5rem; color: var(--accent-secondary);"></i>
                            </div>
                            <div style="font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: var(--space-xs); color: var(--text-primary);">
                                ${coverageData.coveredRoles}
                            </div>
                            <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); font-family: var(--font-mono);">COVERED</div>
                        </div>
                    </div>

                    <div class="card stat-card" style="position: relative; overflow: hidden; ${coverageData.directUserAssignmentsCount > 0 ? 'border: 1px solid var(--color-warning);' : ''}">
                        <div style="position: absolute; top: 50%; right: -20%; width: 150px; height: 150px; background: radial-gradient(circle, ${coverageData.directUserAssignmentsCount > 0 ? 'var(--color-warning-dim)' : 'var(--bg-elevated)'}, transparent); filter: blur(40px);"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="width: 56px; height: 56px; background: ${coverageData.directUserAssignmentsCount > 0 ? 'var(--color-warning-dim)' : 'var(--bg-elevated)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-md);">
                                <i class="fas fa-user" style="font-size: 1.5rem; color: ${coverageData.directUserAssignmentsCount > 0 ? 'var(--color-warning)' : 'var(--text-muted)'};"></i>
                            </div>
                            <div style="font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: var(--space-xs); color: ${coverageData.directUserAssignmentsCount > 0 ? 'var(--color-warning)' : 'var(--text-primary)'};">
                                ${coverageData.directUserAssignmentsCount}
                            </div>
                            <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); font-family: var(--font-mono);">DIRECT ONLY</div>
                        </div>
                    </div>
                </div>

                <!-- Coverage Chart & Details -->
                <div class="dashboard-grid">
                    <!-- Coverage Pie Chart -->
                    <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--border-subtle);">
                        <div style="position: absolute; top: 0; left: 0; width: 300px; height: 300px; background: radial-gradient(circle, var(--accent-primary-dim), transparent); filter: blur(80px);"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-lg); border-bottom: 1px solid var(--border-subtle);">
                                <div style="width: 48px; height: 48px; background: var(--accent-primary-dim); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-chart-pie" style="color: var(--accent-primary); font-size: 1.3rem;"></i>
                                </div>
                                <h2 style="font-family: var(--font-display); font-size: 1.4rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Coverage Overview
                                </h2>
                            </div>
                            <div style="padding: var(--space-2xl); text-align: center;">
                                <!-- Pie Chart -->
                                <div style="max-width: 220px; margin: 0 auto var(--space-xl); position: relative;">
                                    <div style="background: conic-gradient(
                                        var(--accent-primary) 0deg ${calculatePercentage(coverageData.coveredRoles, coverageData.totalRoles) * 3.6}deg,
                                        var(--color-error) ${calculatePercentage(coverageData.coveredRoles, coverageData.totalRoles) * 3.6}deg 360deg
                                    ); width: 220px; height: 220px; border-radius: 50%; box-shadow: 0 0 60px rgba(0, 255, 159, 0.3);"></div>
                                    <!-- Center Circle with Percentage -->
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 140px; height: 140px; background: var(--bg-base); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 3px solid var(--bg-elevated);">
                                        <div style="font-family: var(--font-display); font-size: 2.5rem; font-weight: 900; line-height: 1; background: linear-gradient(135deg, var(--accent-primary), #00ffff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                            ${calculatePercentage(coverageData.coveredRoles, coverageData.totalRoles)}
                                        </div>
                                        <div style="font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.15em; margin-top: 4px;">
                                            %
                                        </div>
                                    </div>
                                </div>
                                <!-- Legend -->
                                <div style="display: flex; flex-direction: column; gap: var(--space-md); max-width: 280px; margin: 0 auto;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-sm) var(--space-md); background: rgba(0, 255, 159, 0.05); border-left: 3px solid var(--accent-primary); border-radius: var(--radius-sm);">
                                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                            <div style="width: 14px; height: 14px; background: var(--accent-primary); border-radius: 50%; box-shadow: 0 0 10px rgba(0, 255, 159, 0.5);"></div>
                                            <span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-primary);">Covered</span>
                                        </div>
                                        <span style="font-family: var(--font-display); font-weight: 700; color: var(--accent-primary);">
                                            ${calculatePercentage(coverageData.coveredRoles, coverageData.totalRoles)}%
                                        </span>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-sm) var(--space-md); background: rgba(255, 0, 85, 0.05); border-left: 3px solid var(--color-error); border-radius: var(--radius-sm);">
                                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                            <div style="width: 14px; height: 14px; background: var(--color-error); border-radius: 50%; box-shadow: 0 0 10px rgba(255, 0, 85, 0.5);"></div>
                                            <span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-primary);">Uncovered</span>
                                        </div>
                                        <span style="font-family: var(--font-display); font-weight: 700; color: var(--color-error);">
                                            ${calculatePercentage(coverageData.uncoveredRoles, coverageData.totalRoles)}%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid ${coverageData.uncoveredRoles > 0 || coverageData.directUserAssignmentsCount > 0 ? 'var(--color-warning)' : 'var(--accent-primary)'};">
                        <div style="position: absolute; top: 0; right: 0; width: 300px; height: 300px; background: radial-gradient(circle, ${coverageData.uncoveredRoles > 0 || coverageData.directUserAssignmentsCount > 0 ? 'var(--color-warning-dim)' : 'var(--accent-primary-dim)'}, transparent); filter: blur(80px);"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-lg); border-bottom: 1px solid var(--border-subtle);">
                                <div style="width: 48px; height: 48px; background: ${coverageData.uncoveredRoles === 0 && coverageData.directUserAssignmentsCount === 0 ? 'var(--accent-primary-dim)' : 'var(--color-warning-dim)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas ${coverageData.uncoveredRoles === 0 && coverageData.directUserAssignmentsCount === 0 ? 'fa-check-circle' : 'fa-lightbulb'}" style="color: ${coverageData.uncoveredRoles === 0 && coverageData.directUserAssignmentsCount === 0 ? 'var(--accent-primary)' : 'var(--color-warning)'}; font-size: 1.3rem;"></i>
                                </div>
                                <h2 style="font-family: var(--font-display); font-size: 1.4rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Recommendations
                                </h2>
                            </div>
                            <div style="padding: var(--space-md);">
                                ${coverageData.uncoveredRoles > 0 ? `
                                    <div style="background: rgba(255, 170, 0, 0.05); border-left: 3px solid var(--color-warning); border-radius: var(--radius-sm); padding: var(--space-md); margin-bottom: var(--space-sm);">
                                        <div style="display: flex; align-items: start; gap: var(--space-sm);">
                                            <i class="fas fa-exclamation-triangle" style="color: var(--color-warning); margin-top: 2px; font-size: 1.1rem;"></i>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 700; font-family: var(--font-mono); font-size: 0.8rem; text-transform: uppercase; color: var(--color-warning); margin-bottom: var(--space-xs);">
                                                    IMPROVE COVERAGE
                                                </div>
                                                <div style="color: var(--text-secondary); line-height: 1.5; font-size: 0.9rem;">
                                                    ${coverageData.uncoveredRoles} roles are managed through direct user assignments. Consider creating PIM groups for better management and audit trails.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${coverageData.directUserAssignmentsCount > 0 ? `
                                    <div style="background: rgba(59, 130, 246, 0.05); border-left: 3px solid var(--color-info); border-radius: var(--radius-sm); padding: var(--space-md); margin-bottom: var(--space-sm);">
                                        <div style="display: flex; align-items: start; gap: var(--space-sm);">
                                            <i class="fas fa-users" style="color: var(--color-info); margin-top: 2px; font-size: 1.1rem;"></i>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 700; font-family: var(--font-mono); font-size: 0.8rem; text-transform: uppercase; color: var(--color-info); margin-bottom: var(--space-xs);">
                                                    DIRECT ASSIGNMENTS DETECTED
                                                </div>
                                                <div style="color: var(--text-secondary); line-height: 1.5; font-size: 0.9rem;">
                                                    ${coverageData.directUserAssignmentsCount} direct user assignments found. Using PIM groups provides better access control and compliance.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${coverageData.uncoveredRoles === 0 && coverageData.directUserAssignmentsCount === 0 ? `
                                    <div style="text-align: center; padding: var(--space-xl);">
                                        <div style="width: 80px; height: 80px; margin: 0 auto var(--space-md); background: var(--accent-primary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-trophy" style="font-size: 2.5rem; color: var(--accent-primary);"></i>
                                        </div>
                                        <div style="font-family: var(--font-display); font-size: 1.2rem; font-weight: 700; margin-bottom: var(--space-xs); color: var(--text-primary);">
                                            Perfect Coverage!
                                        </div>
                                        <div style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">
                                            All roles are properly managed through PIM groups
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Roles Table -->
                <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--border-subtle); margin-top: var(--space-lg);">
                    <div style="position: absolute; bottom: 0; right: 0; width: 400px; height: 400px; background: radial-gradient(circle, var(--accent-secondary-dim), transparent); filter: blur(100px);"></div>
                    <div style="position: relative; z-index: 1;">
                        <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-lg); border-bottom: 1px solid var(--border-subtle);">
                            <div style="width: 48px; height: 48px; background: var(--accent-secondary-dim); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-table" style="color: var(--accent-secondary); font-size: 1.3rem;"></i>
                            </div>
                            <div>
                                <h2 style="font-family: var(--font-display); font-size: 1.4rem; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Detailed Analysis
                                </h2>
                                <div style="font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">
                                    Role-by-role coverage breakdown
                                </div>
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="table" style="margin: 0;">
                                <thead>
                                    <tr style="background: rgba(0, 0, 0, 0.3);">
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Role Name</th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Group Assignments</th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Direct Assignments</th>
                                        <th style="font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${coverageData.roles.map((role, idx) => `
                                        <tr style="border-bottom: 1px solid var(--border-subtle); background: ${idx % 2 === 0 ? 'rgba(255, 0, 128, 0.02)' : 'transparent'};">
                                            <td style="font-weight: 600; font-size: 0.9rem; color: var(--text-primary);">
                                                ${this.escapeHtml(role.roleName)}
                                            </td>
                                            <td>
                                                <span style="font-family: var(--font-mono); font-size: 0.9rem; font-weight: 600; color: ${role.groupCount > 0 ? 'var(--accent-primary)' : 'var(--text-muted)'};">
                                                    ${role.groupCount}
                                                </span>
                                            </td>
                                            <td>
                                                <span style="font-family: var(--font-mono); font-size: 0.9rem; font-weight: 600; color: ${role.userCount > 0 ? 'var(--color-warning)' : 'var(--text-muted)'};">
                                                    ${role.userCount}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge" style="background: ${role.isCovered ? 'var(--color-success-dim)' : 'var(--color-warning-dim)'}; color: ${role.isCovered ? 'var(--color-success)' : 'var(--color-warning)'}; font-family: var(--font-mono); font-size: 0.7rem; text-transform: uppercase; font-weight: 700;">
                                                    ${role.isCovered ? '✓ COVERED' : '⚠ DIRECT ONLY'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="card" style="position: relative; overflow: hidden; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--accent-primary);">
                    <div style="position: absolute; inset: 0; background: radial-gradient(circle at center, var(--accent-primary-dim), transparent); filter: blur(80px);"></div>
                    <div style="position: relative; z-index: 1; text-align: center; padding: var(--space-2xl);">
                        <div style="width: 150px; height: 150px; margin: 0 auto var(--space-xl); background: var(--accent-primary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 60px rgba(0, 255, 159, 0.3);">
                            <i class="fas fa-chart-pie" style="font-size: 4.5rem; color: var(--accent-primary);"></i>
                        </div>
                        <h2 style="font-family: var(--font-display); font-size: 2rem; font-weight: 800; margin-bottom: var(--space-md); text-transform: uppercase; letter-spacing: 0.05em;">
                            <span style="background: linear-gradient(135deg, var(--accent-primary), #00ffff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                ANALYTICS READY
                            </span>
                        </h2>
                        <p style="color: var(--text-secondary); font-family: var(--font-mono); font-size: 0.95rem; margin-bottom: var(--space-xl); max-width: 500px; margin-left: auto; margin-right: auto;">
                            ${this.isConnected ? 'Generating comprehensive coverage analysis across all PIM roles and assignments' : 'Connect to Microsoft Entra ID to view role coverage analytics'}
                        </p>
                        ${this.isConnected ? `
                            <div style="display: inline-flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm) var(--space-md); background: rgba(0, 255, 159, 0.1); border-radius: var(--radius-full); font-family: var(--font-mono); font-size: 0.8rem; color: var(--accent-primary);">
                                <div class="spinner" style="width: 16px; height: 16px;"></div>
                                <span>Loading data...</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `}
        `;
    }

    toggleTheme() {
        this.isDarkMode = !this.isDarkMode;
        this.applyTheme();
        localStorage.setItem('pimbuddy-theme', this.isDarkMode ? 'dark' : 'light');
    }

    setTheme(theme) {
        this.isDarkMode = theme === 'dark';
        this.applyTheme();
        localStorage.setItem('pimbuddy-theme', theme);
    }

    loadTheme() {
        const saved = localStorage.getItem('pimbuddy-theme');
        this.isDarkMode = saved === 'dark';
        this.applyTheme();
    }

    applyTheme() {
        document.body.classList.toggle('dark-mode', this.isDarkMode);
        const icon = document.querySelector('#theme-toggle i');
        if (icon) {
            icon.className = this.isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
        }
    }

    /**
     * Escape HTML to prevent XSS (delegates to SecurityUtils)
     */
    escapeHtml(text) {
        return SecurityUtils.escapeHtml(text);
    }
}

// Initialize app
const app = new PIMBuddyApp();
window.app = app; // Make available globally for onclick handlers
app.init();

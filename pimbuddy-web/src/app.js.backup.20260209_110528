/**
 * PIMBuddy Web Application
 * Main entry point and UI controller
 */

import { authService } from './services/authService.js';
import { graphService } from './services/graphService.js';
import { bootstrapService } from './services/bootstrapService.js';
import { templateService } from './services/templateService.js';
import { pimmaidService } from './services/pimmaidService.js';
import { baselineService } from './services/baselineService.js';
import { isAppConfigured, clearAppConfig, getSavedAppConfig } from './config/authConfig.js';
import { SecurityUtils, sessionManager } from './utils/security.js';
import { Paginator } from './utils/pagination.js';
import { PAGINATION } from './utils/constants.js';
import { ExportUtils, ExportConfigs } from './utils/export.js';
import { BulkOperationsManager, executeBulkOperation, renderBulkProgressModal, renderBulkResultsModal } from './utils/bulkOperations.js';
import { errorHandler, AppError, ErrorType, retryOperation, safeExecute } from './utils/errorHandling.js';
import UIComponents from './utils/uiComponents.js';
import { CacheManager } from './core/CacheManager.js';
import { PageRouter } from './core/PageRouter.js';
import { DashboardPage } from './pages/DashboardPage.js';
import { GroupsPage } from './pages/GroupsPage.js';
import { RolesPage } from './pages/RolesPage.js';
import { ActivityPage } from './pages/ActivityPage.js';
import { ApprovalsPage } from './pages/ApprovalsPage.js';
import { ExpiringPage } from './pages/ExpiringPage.js';
import { HealthCheckPage } from './pages/HealthCheckPage.js';
import { CoveragePage } from './pages/CoveragePage.js';
import { PimmaidPage } from './pages/PimmaidPage.js';
import { PoliciesPage } from './pages/PoliciesPage.js';
import { TemplatesPage } from './pages/TemplatesPage.js';
import { ExportPage } from './pages/ExportPage.js';
import { SettingsPage } from './pages/SettingsPage.js';

class PIMBuddyApp {
    constructor() {
        this.currentPage = 'dashboard';
        this.isConnected = false;
        this.isConfigured = false;
        this.isDarkMode = false;
        this.cache = {
            groups: null,
            roles: null,
            templates: null
        };
        // Pagination instances
        this.paginators = {
            groups: new Paginator([], PAGINATION.DEFAULT_PAGE_SIZE),
            roles: new Paginator([], PAGINATION.DEFAULT_PAGE_SIZE),
            activity: new Paginator([], PAGINATION.DEFAULT_PAGE_SIZE)
        };
        // Bulk operations managers
        this.bulkOps = {
            groups: new BulkOperationsManager()
        };
        // Export utilities
        this.exportUtils = ExportUtils;

        // Initialize cache manager
        this.cacheManager = new CacheManager();

        // Initialize page instances
        this.pages = {
            dashboard: new DashboardPage(this),
            groups: new GroupsPage(this),
            roles: new RolesPage(this),
            activity: new ActivityPage(this),
            approvals: new ApprovalsPage(this),
            expiring: new ExpiringPage(this),
            healthCheck: new HealthCheckPage(this),
            coverage: new CoveragePage(this),
            pimmaid: new PimmaidPage(this),
            policies: new PoliciesPage(this),
            templates: new TemplatesPage(this),
            export: new ExportPage(this),
            settings: new SettingsPage(this)
        };

        // Initialize router
        this.router = new PageRouter(this, {
            'dashboard': this.pages.dashboard,
            'groups': this.pages.groups,
            'roles': this.pages.roles,
            'entra-roles': this.pages.roles, // alias
            'pim-activity': this.pages.activity,
            'pending-approvals': this.pages.approvals,
            'expiring-assignments': this.pages.expiring,
            'health-check': this.pages.healthCheck,
            'role-coverage': this.pages.coverage,
            'pimmaid': this.pages.pimmaid,
            'policies': this.pages.policies,
            'templates': this.pages.templates,
            'export': this.pages.export,
            'settings': this.pages.settings
        });
    }

    /**
     * Initialize the application
     */
    async init() {
        console.log('PIMBuddy Web initializing...');

        // Load saved theme preference
        this.loadTheme();

        // Check if app is configured
        this.isConfigured = isAppConfigured();

        if (this.isConfigured) {
            // Initialize MSAL with saved config
            try {
                const initialized = await authService.initialize();

                if (initialized && authService.isAuthenticated()) {
                    this.handleSuccessfulLogin();
                }
            } catch (error) {
                console.error('Failed to initialize auth:', error);
                this.showToast('Failed to initialize authentication', 'error');
            }
        } else {
            // Show setup required message
            this.showSetupRequired();
        }

        // Set up event listeners
        this.setupEventListeners();

        // Render initial page
        this.renderPage(this.currentPage);

        console.log('PIMBuddy Web initialized');
    }

    /**
     * Set up all event listeners
     */
    setupEventListeners() {
        // Connect button
        document.getElementById('connect-btn').addEventListener('click', () => this.handleConnect());

        // Theme toggle
        document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());

        // Navigation items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const page = e.currentTarget.dataset.page;
                this.navigateTo(page);
            });
        });

        // Modal backdrop click to close
        document.querySelector('.modal-backdrop')?.addEventListener('click', () => this.closeModal());

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+F for search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                this.showGlobalSearch();
            }
            // Escape to close modal
            if (e.key === 'Escape') {
                this.closeModal();
            }
            // F5 to refresh
            if (e.key === 'F5') {
                e.preventDefault();
                this.refreshCurrentPage();
            }
        });
    }

    /**
     * Show setup required state
     */
    showSetupRequired() {
        document.getElementById('connect-text').textContent = 'Setup';
        document.getElementById('connection-text').textContent = 'Setup Required';
    }

    /**
     * Handle connect/disconnect button
     */
    async handleConnect() {
        if (!this.isConfigured) {
            // Show setup wizard
            await this.showSetupWizard();
            return;
        }

        if (this.isConnected) {
            // Disconnect
            this.showLoading('Signing out...');
            const result = await authService.logout();
            this.hideLoading();

            if (result.success) {
                this.handleLogout();
            } else {
                this.showToast(result.error, 'error');
            }
        } else {
            // Connect
            this.showLoading('Signing in...');
            const result = await authService.login();
            this.hideLoading();

            if (result.success) {
                this.handleSuccessfulLogin();
            } else {
                this.showToast(result.error, 'error');
            }
        }
    }

    /**
     * Handle successful login
     */
    handleSuccessfulLogin() {
        this.isConnected = true;
        const account = authService.getAccount();

        // Update UI
        document.getElementById('connect-text').textContent = 'Disconnect';
        document.getElementById('connect-btn').classList.remove('btn-primary');
        document.getElementById('connect-btn').classList.add('btn-danger');
        document.getElementById('connection-indicator').classList.remove('disconnected');
        document.getElementById('connection-indicator').classList.add('connected');
        document.getElementById('connection-text').textContent = account?.username || 'Connected';

        this.showToast('Connected successfully', 'success');

        // Start session management
        sessionManager.start(
            // On timeout callback
            () => {
                this.showToast('Session expired due to inactivity', 'warning');
                this.handleLogout();
            },
            // On warning callback
            (remainingMinutes) => {
                this.showToast(
                    `Your session will expire in ${remainingMinutes} minutes due to inactivity`,
                    'warning'
                );
            }
        );

        // Refresh current page data
        this.refreshCurrentPage();
    }

    /**
     * Handle logout
     */
    handleLogout() {
        this.isConnected = false;
        this.cache = { groups: null, roles: null, templates: null };

        // Stop session management
        sessionManager.stop();

        // Update UI
        document.getElementById('connect-text').textContent = 'Connect';
        document.getElementById('connect-btn').classList.remove('btn-danger');
        document.getElementById('connect-btn').classList.add('btn-primary');
        document.getElementById('connection-indicator').classList.remove('connected');
        document.getElementById('connection-indicator').classList.add('disconnected');
        document.getElementById('connection-text').textContent = 'Not Connected';

        this.showToast('Disconnected', 'info');
        this.renderPage(this.currentPage);
    }

    /**
     * Navigate to a page
     */
    async navigateTo(page, params = {}) {
        // Use the router to navigate
        await this.router.navigateTo(page, params);
        this.currentPage = page;
    }

    /**
     * Render a page
     */
    async renderPage(page, params = {}) {
        // Use the router to render the page
        await this.router.navigateTo(page, params);
    }

    /**
     * Refresh current page
     */
    async refreshCurrentPage() {
        // Use the router to refresh the current page
        await this.router.refreshCurrentPage();
    }

    // ==========================================
    // Setup Wizard
    // ==========================================

    async showSetupWizard() {
        const savedConfig = getSavedAppConfig();
        const redirectUri = window.location.origin;

        const html = `
            <h2><i class="fas fa-cog"></i> PIMBuddy Setup</h2>
            <p>Configure PIMBuddy to connect to your Azure AD tenant.</p>

            <div class="setup-tabs">
                <button class="setup-tab active" onclick="app.switchSetupTab('manual')">
                    <i class="fas fa-edit"></i> Manual Setup
                </button>
                <button class="setup-tab" onclick="app.switchSetupTab('instructions')">
                    <i class="fas fa-book"></i> Instructions
                </button>
            </div>

            <div id="setup-tab-manual" class="setup-tab-content active">
                <form id="manual-setup-form" onsubmit="app.saveManualConfig(event)">
                    <div class="form-group">
                        <label for="client-id">Application (Client) ID *</label>
                        <input type="text" id="client-id" class="input" required
                            placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                            value="${savedConfig?.clientId || ''}"
                            pattern="[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}">
                        <small class="form-hint">Found in Azure Portal ‚Üí App registrations ‚Üí Your app ‚Üí Overview</small>
                    </div>

                    <div class="form-group">
                        <label for="tenant-id">Directory (Tenant) ID *</label>
                        <input type="text" id="tenant-id" class="input" required
                            placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                            value="${savedConfig?.tenantId || ''}"
                            pattern="[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}">
                        <small class="form-hint">Found in Azure Portal ‚Üí Azure Active Directory ‚Üí Overview</small>
                    </div>

                    <div class="setup-note">
                        <i class="fas fa-info-circle"></i>
                        <span>Your Redirect URI must be: <code>${redirectUri}</code></span>
                    </div>

                    <div id="setup-result" class="setup-result hidden"></div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                        ${savedConfig ? `
                            <button type="button" class="btn btn-secondary" onclick="app.resetSetup()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        ` : ''}
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save & Connect
                        </button>
                    </div>
                </form>
            </div>

            <div id="setup-tab-instructions" class="setup-tab-content">
                <div class="setup-instructions">
                    <h3>Step 1: Create App Registration</h3>
                    <ol>
                        <li>Go to <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank">Azure Portal ‚Üí App registrations</a></li>
                        <li>Click <strong>New registration</strong></li>
                        <li>Name: <code>PIMBuddy Web</code></li>
                        <li>Supported account types: <strong>Single tenant</strong></li>
                        <li>Redirect URI: Select <strong>Single-page application (SPA)</strong> and enter:<br>
                            <code class="copyable" onclick="app.copyToClipboard('${redirectUri}')">${redirectUri}</code>
                        </li>
                        <li>Click <strong>Register</strong></li>
                    </ol>

                    <h3>Step 2: Configure API Permissions</h3>
                    <ol>
                        <li>In your new app, go to <strong>API permissions</strong></li>
                        <li>Click <strong>Add a permission</strong> ‚Üí <strong>Microsoft Graph</strong> ‚Üí <strong>Delegated permissions</strong></li>
                        <li>Add these permissions:
                            <ul class="permissions-list">
                                <li><code>User.Read</code></li>
                                <li><code>Group.Read.All</code></li>
                                <li><code>Group.ReadWrite.All</code></li>
                                <li><code>RoleManagement.Read.Directory</code></li>
                                <li><code>RoleManagement.ReadWrite.Directory</code></li>
                                <li><code>PrivilegedAccess.Read.AzureADGroup</code></li>
                                <li><code>PrivilegedAccess.ReadWrite.AzureADGroup</code></li>
                                <li><code>PrivilegedEligibilitySchedule.Read.AzureADGroup</code></li>
                                <li><code>PrivilegedEligibilitySchedule.ReadWrite.AzureADGroup</code></li>
                                <li><code>PrivilegedAssignmentSchedule.Read.AzureADGroup</code></li>
                                <li><code>PrivilegedAssignmentSchedule.ReadWrite.AzureADGroup</code></li>
                            </ul>
                        </li>
                        <li>Click <strong>Grant admin consent</strong> (requires admin role)</li>
                    </ol>

                    <h3>Step 3: Copy IDs</h3>
                    <ol>
                        <li>Go to <strong>Overview</strong></li>
                        <li>Copy the <strong>Application (client) ID</strong></li>
                        <li>Copy the <strong>Directory (tenant) ID</strong></li>
                        <li>Paste them in the <strong>Manual Setup</strong> tab</li>
                    </ol>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Close</button>
                    <button type="button" class="btn btn-primary" onclick="app.switchSetupTab('manual')">
                        <i class="fas fa-arrow-left"></i> Back to Setup
                    </button>
                </div>
            </div>
        `;

        this.showModal(html);
    }

    switchSetupTab(tab) {
        document.querySelectorAll('.setup-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.setup-tab-content').forEach(c => c.classList.remove('active'));

        document.querySelector(`.setup-tab-content#setup-tab-${tab}`).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            this.showToast('Copied to clipboard', 'success');
        }).catch(() => {
            this.showToast('Failed to copy', 'error');
        });
    }

    async saveManualConfig(event) {
        event.preventDefault();

        const clientId = document.getElementById('client-id').value.trim();
        const tenantId = document.getElementById('tenant-id').value.trim();
        const resultDiv = document.getElementById('setup-result');

        // Validate GUIDs
        const guidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;

        if (!guidRegex.test(clientId)) {
            resultDiv.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div>Invalid Client ID format. Must be a GUID.</div></div>`;
            resultDiv.classList.remove('hidden');
            return;
        }

        if (!guidRegex.test(tenantId)) {
            resultDiv.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div>Invalid Tenant ID format. Must be a GUID.</div></div>`;
            resultDiv.classList.remove('hidden');
            return;
        }

        // Save configuration
        const config = {
            clientId,
            tenantId,
            createdAt: new Date().toISOString()
        };

        localStorage.setItem('pimbuddy-app-config', JSON.stringify(config));

        // Update app state
        this.isConfigured = true;

        // Re-initialize auth service with new config
        try {
            await authService.reinitialize();

            resultDiv.innerHTML = `
                <div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Configuration saved!</strong>
                        <p>Click below to sign in.</p>
                    </div>
                </div>
            `;
            resultDiv.classList.remove('hidden');

            // Update connect button text
            document.getElementById('connect-text').textContent = 'Connect';
            document.getElementById('connection-text').textContent = 'Not Connected';

            // Auto-close and connect after a brief delay
            setTimeout(async () => {
                this.closeModal();
                await this.handleConnect();
            }, 1000);

        } catch (error) {
            resultDiv.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <div>
                        <strong>Configuration Error</strong>
                        <p>${error.message}</p>
                    </div>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        }
    }

    async resetSetup() {
        if (!confirm('This will clear the saved configuration. You will need to run setup again. Continue?')) {
            return;
        }

        clearAppConfig();
        this.isConfigured = false;

        // Clear auth state
        authService.msalInstance = null;
        authService.account = null;
        authService.initialized = false;

        this.closeModal();
        this.showToast('Configuration cleared', 'info');
        this.showSetupRequired();
        this.renderPage(this.currentPage);
    }

    // ==========================================
    // Page Renderers
    // ==========================================

    renderLandingPage(container) {
        container.innerHTML = `
            <!-- Hero Section -->
            <div style="text-align: center; padding: var(--space-xl) 0; max-width: 1200px; margin: 0 auto;">
                <div style="display: inline-flex; align-items: center; justify-content: center; width: 120px; height: 120px; background: linear-gradient(135deg, var(--accent-primary-dim), var(--accent-secondary-dim)); border-radius: 30px; margin-bottom: var(--space-lg); box-shadow: 0 20px 60px rgba(0, 212, 170, 0.3);">
                    <i class="fas fa-shield-alt" style="font-size: 4rem; color: var(--accent-primary);"></i>
                </div>

                <h1 style="font-family: var(--font-display); font-size: 3.5rem; font-weight: 800; margin-bottom: var(--space-md); background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    Welcome to PIMBuddy
                </h1>

                <p style="font-size: 1.3rem; color: var(--text-secondary); max-width: 700px; margin: 0 auto var(--space-xl);">
                    Your complete solution for Microsoft Entra PIM management. Deploy, monitor, and secure privileged access with enterprise-grade tools.
                </p>

                <button class="btn btn-primary" onclick="document.getElementById('connect-btn').click()" style="font-size: 1.1rem; padding: var(--space-md) var(--space-xl); box-shadow: 0 10px 30px rgba(0, 212, 170, 0.3);">
                    <i class="fas fa-plug"></i> Connect to Get Started
                </button>
            </div>

            <!-- Key Stats -->
            <div class="stats-grid" style="margin-bottom: var(--space-xl);">
                <div class="card stat-card" style="border-color: var(--accent-primary-dim);">
                    <div class="stat-icon primary">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="stat-value">5</div>
                    <div class="stat-label">Monitoring Tools</div>
                </div>
                <div class="card stat-card" style="border-color: var(--accent-secondary-dim);">
                    <div class="stat-icon secondary">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <div class="stat-value">3</div>
                    <div class="stat-label">Baseline Templates</div>
                </div>
                <div class="card stat-card" style="border-color: var(--color-success-dim);">
                    <div class="stat-icon success">
                        <i class="fas fa-shield-check"></i>
                    </div>
                    <div class="stat-value">100%</div>
                    <div class="stat-label">Zero Trust Ready</div>
                </div>
            </div>

            <!-- Core Features -->
            <h2 style="font-family: var(--font-display); font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: var(--space-lg);">
                <i class="fas fa-stars" style="color: var(--accent-primary);"></i> Core Features
            </h2>

            <div class="dashboard-grid" style="margin-bottom: var(--space-xl);">
                <!-- Baseline Deployment -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--accent-primary-dim);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--accent-primary-dim); border-radius: var(--radius-lg);">
                            <i class="fas fa-rocket" style="font-size: 1.8rem; color: var(--accent-primary);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">Baseline Deployment</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">One-Click PIM Setup</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Deploy complete PIM configurations instantly with industry best practices. Choose from Enterprise Standard, High Security (Zero Trust), or Quick Start templates.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-primary"><i class="fas fa-check"></i> Tiered Access (T0/T1/T2)</span>
                        <span class="badge badge-success"><i class="fas fa-check"></i> MFA Required</span>
                        <span class="badge badge-info"><i class="fas fa-check"></i> Approval Workflows</span>
                        <span class="badge badge-warning"><i class="fas fa-check"></i> Auto-Configuration</span>
                    </div>
                </div>

                <!-- PIM Health Check -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--color-success-dim);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--color-success-dim); border-radius: var(--radius-lg);">
                            <i class="fas fa-heart-pulse" style="font-size: 1.8rem; color: var(--color-success);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">Health Check Scanner</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Security Analysis</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Automated security scanner that analyzes your PIM configuration. Get a health score (0-100%) and actionable recommendations to improve security.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-success"><i class="fas fa-search"></i> Auto-Scan</span>
                        <span class="badge badge-primary"><i class="fas fa-chart-line"></i> Health Score</span>
                        <span class="badge badge-warning"><i class="fas fa-exclamation-triangle"></i> Issue Detection</span>
                        <span class="badge badge-info"><i class="fas fa-lightbulb"></i> Recommendations</span>
                    </div>
                </div>

                <!-- Activity Monitoring -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--accent-secondary-dim);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--accent-secondary-dim); border-radius: var(--radius-lg);">
                            <i class="fas fa-history" style="font-size: 1.8rem; color: var(--accent-secondary);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">PIM Activity Log</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Audit & Compliance</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Complete audit trail of all PIM role management activities. Track who did what, when, and why with detailed activity logs and filtering.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-secondary"><i class="fas fa-calendar"></i> 30-Day History</span>
                        <span class="badge badge-info"><i class="fas fa-filter"></i> Advanced Filtering</span>
                        <span class="badge badge-primary"><i class="fas fa-download"></i> Export Logs</span>
                    </div>
                </div>

                <!-- Approval Management -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid var(--color-warning-dim);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--color-warning-dim); border-radius: var(--radius-lg);">
                            <i class="fas fa-clock" style="font-size: 1.8rem; color: var(--color-warning);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">Pending Approvals</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Request Management</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Manage PIM activation requests in one place. Review justifications, approve or deny requests, and maintain compliance with one-click actions.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-success"><i class="fas fa-check"></i> Quick Approve</span>
                        <span class="badge badge-danger"><i class="fas fa-times"></i> Quick Deny</span>
                        <span class="badge badge-info"><i class="fas fa-comment"></i> Justification View</span>
                    </div>
                </div>

                <!-- Expiring Assignments -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid rgba(245, 158, 11, 0.2);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--color-warning-dim); border-radius: var(--radius-lg);">
                            <i class="fas fa-hourglass-end" style="font-size: 1.8rem; color: var(--color-warning);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">Expiring Assignments</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Lifecycle Management</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Track role assignments expiring within 7 days. Proactive monitoring prevents access loss and ensures continuous operations.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-warning"><i class="fas fa-bell"></i> 7-Day Alerts</span>
                        <span class="badge badge-primary"><i class="fas fa-clock"></i> Time Remaining</span>
                        <span class="badge badge-info"><i class="fas fa-list"></i> Full Tracking</span>
                    </div>
                </div>

                <!-- Role Coverage -->
                <div class="card" style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface)); border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                        <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.15); border-radius: var(--radius-lg);">
                            <i class="fas fa-chart-pie" style="font-size: 1.8rem; color: var(--color-info);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0;">Role Coverage Report</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Analytics Dashboard</p>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                        Analyze which roles are managed through PIM groups vs direct assignments. Visual reports help identify gaps and improve governance.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">
                        <span class="badge badge-info"><i class="fas fa-chart-pie"></i> Visual Reports</span>
                        <span class="badge badge-primary"><i class="fas fa-percent"></i> Coverage %</span>
                        <span class="badge badge-warning"><i class="fas fa-flag"></i> Gap Analysis</span>
                    </div>
                </div>
            </div>

            <!-- Additional Features -->
            <h2 style="font-family: var(--font-display); font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: var(--space-lg);">
                <i class="fas fa-toolbox" style="color: var(--accent-primary);"></i> Additional Tools
            </h2>

            <div class="dashboard-grid" style="margin-bottom: var(--space-xl);">
                <!-- PIMMaid -->
                <div class="card">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                        <div class="stat-icon primary">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <h3 style="font-size: 1.2rem; font-weight: 700; margin: 0;">PIMMaid Visualizer</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-sm);">
                        Export your PIM configuration as beautiful Mermaid diagrams. Visualize relationships between users, groups, and roles.
                    </p>
                    <span class="badge badge-secondary"><i class="fas fa-sitemap"></i> Visual Diagrams</span>
                </div>

                <!-- Group Management -->
                <div class="card">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                        <div class="stat-icon success">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 style="font-size: 1.2rem; font-weight: 700; margin: 0;">Group Management</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-sm);">
                        Create and manage role-assignable security groups. Add/remove members with an intuitive interface.
                    </p>
                    <span class="badge badge-success"><i class="fas fa-user-plus"></i> Member Management</span>
                </div>

                <!-- Role Explorer -->
                <div class="card">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                        <div class="stat-icon warning">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <h3 style="font-size: 1.2rem; font-weight: 700; margin: 0;">Entra Roles Explorer</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-sm);">
                        Browse all Azure AD roles with privilege levels. Search, filter, and understand role permissions.
                    </p>
                    <span class="badge badge-warning"><i class="fas fa-shield-alt"></i> Privilege Levels</span>
                </div>

                <!-- Import/Export -->
                <div class="card">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                        <div class="stat-icon info">
                            <i class="fas fa-file-export"></i>
                        </div>
                        <h3 style="font-size: 1.2rem; font-weight: 700; margin: 0;">Import/Export</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-sm);">
                        Export configurations for backup or compliance. Import templates to replicate setups across tenants.
                    </p>
                    <span class="badge badge-info"><i class="fas fa-download"></i> Backup & Restore</span>
                </div>
            </div>

            <!-- Call to Action -->
            <div class="card" style="background: linear-gradient(135deg, var(--accent-primary-dim), var(--accent-secondary-dim)); border: 2px solid var(--accent-primary); text-align: center; padding: var(--space-xl);">
                <h2 style="font-size: 2rem; font-weight: 800; margin-bottom: var(--space-md);">
                    Ready to Transform Your PIM Management?
                </h2>
                <p style="font-size: 1.1rem; color: var(--text-secondary); margin-bottom: var(--space-lg); max-width: 600px; margin-left: auto; margin-right: auto;">
                    Connect to your Microsoft Entra ID tenant and start managing privileged access with enterprise-grade tools in minutes.
                </p>
                <button class="btn btn-primary" onclick="document.getElementById('connect-btn').click()" style="font-size: 1.2rem; padding: var(--space-md) var(--space-xl); box-shadow: 0 10px 30px rgba(0, 212, 170, 0.4);">
                    <i class="fas fa-plug"></i> Connect Now
                </button>
            </div>

            <!-- Footer Info -->
            <div style="text-align: center; margin-top: var(--space-xl); padding: var(--space-lg); color: var(--text-muted);">
                <p style="margin-bottom: var(--space-sm);">
                    <i class="fas fa-shield-check" style="color: var(--accent-primary);"></i>
                    Built with enterprise security in mind
                </p>
                <p style="font-size: 0.9rem;">
                    PIMBuddy v1.0.0 | Powered by Microsoft Graph API | Zero Trust Ready
                </p>
            </div>
        `;
    }

    sortRolesByPrivilege(roles, order) {
        const privilegeOrder = { critical: 0, high: 1, medium: 2, low: 3 };

        return [...roles].sort((a, b) => {
            if (order === 'privilege-desc') {
                return privilegeOrder[a.privilegeLevel] - privilegeOrder[b.privilegeLevel];
            } else if (order === 'privilege-asc') {
                return privilegeOrder[b.privilegeLevel] - privilegeOrder[a.privilegeLevel];
            } else if (order === 'name-asc') {
                return a.displayName.localeCompare(b.displayName);
            } else if (order === 'name-desc') {
                return b.displayName.localeCompare(a.displayName);
            }
            return 0;
        });
    }

    sortRoles(order) {
        // Toggle direction if clicking same column header
        if (order === 'privilege') {
            order = this.roleSortOrder === 'privilege-desc' ? 'privilege-asc' : 'privilege-desc';
        } else if (order === 'name') {
            order = this.roleSortOrder === 'name-asc' ? 'name-desc' : 'name-asc';
        }

        this.roleSortOrder = order;
        this.renderPage('roles');
    }

    // ==========================================
    // Baseline Deployment
    // ==========================================

    async renderBaseline(container) {
        const baselines = baselineService.getBaselineConfigurations();

        container.innerHTML = `
            <div class="page-header-row">
                <h1 class="page-header">
                    <i class="fas fa-rocket"></i> PIM Baseline Deployment
                </h1>
                <span class="page-subtitle">One-shot PIM configuration based on best practices</span>
            </div>
            <p class="page-description">Deploy a complete PIM configuration with groups, policies, and role assignments based on industry best practices and Zero Trust principles.</p>

            <div id="baseline-wizard-step" data-step="1">
                <!-- Step 1: Baseline Selection -->
                <div id="baseline-step-1" class="baseline-step active">
                    <h2 class="step-title"><i class="fas fa-list-check"></i> Step 1: Choose Your Baseline</h2>

                    <div class="baseline-grid">
                        ${Object.entries(baselines).map(([key, baseline]) => `
                            <div class="card baseline-card" data-baseline="${key}">
                                <div class="baseline-header">
                                    <i class="fas ${baseline.icon} baseline-icon"></i>
                                    <h3>${baseline.name}</h3>
                                </div>
                                <p class="baseline-desc">${baseline.description}</p>

                                <div class="baseline-features">
                                    <h4>Key Features:</h4>
                                    <ul>
                                        ${baseline.features.map(f => `<li><i class="fas fa-check-circle"></i> ${f}</li>`).join('')}
                                    </ul>
                                </div>

                                <div class="baseline-stats">
                                    <span class="stat-badge"><i class="fas fa-layer-group"></i> ${baseline.tiers.length} Tiers</span>
                                    <span class="stat-badge"><i class="fas fa-users"></i> ${baseline.tiers.reduce((sum, t) => sum + t.groups.length, 0)} Groups</span>
                                </div>

                                <button class="btn btn-primary btn-block" onclick="app.selectBaseline('${key}')" ${!this.isConnected ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-right"></i> Select This Baseline
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Step 2: Tier & Group Selection -->
                <div id="baseline-step-2" class="baseline-step">
                    <h2 class="step-title"><i class="fas fa-layer-group"></i> Step 2: Configure Tiers & Groups</h2>

                    <div class="step-navigation">
                        <button class="btn btn-secondary" onclick="app.previousBaselineStep()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                    </div>

                    <div id="baseline-tier-config" class="tier-config-container">
                        <!-- Populated dynamically -->
                    </div>

                    <div class="step-actions">
                        <button class="btn btn-primary" onclick="app.validateBaseline()">
                            <i class="fas fa-check-circle"></i> Validate Configuration
                        </button>
                    </div>
                </div>

                <!-- Step 3: Validation & Review -->
                <div id="baseline-step-3" class="baseline-step">
                    <h2 class="step-title"><i class="fas fa-clipboard-check"></i> Step 3: Review & Deploy</h2>

                    <div class="step-navigation">
                        <button class="btn btn-secondary" onclick="app.previousBaselineStep()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                    </div>

                    <div id="baseline-validation-results" class="validation-results">
                        <!-- Populated after validation -->
                    </div>

                    <div id="baseline-deployment-plan" class="deployment-plan">
                        <!-- Populated after validation -->
                    </div>

                    <div class="step-actions">
                        <button class="btn btn-success btn-lg" onclick="app.executeBaselineDeployment()" id="deploy-baseline-btn">
                            <i class="fas fa-rocket"></i> Deploy Baseline
                        </button>
                    </div>
                </div>

                <!-- Step 4: Deployment Progress -->
                <div id="baseline-step-4" class="baseline-step">
                    <h2 class="step-title"><i class="fas fa-tasks"></i> Deployment in Progress</h2>

                    <div id="baseline-deployment-progress" class="deployment-progress">
                        <!-- Populated during deployment -->
                    </div>
                </div>
            </div>
        `;

        this.baselineState = {
            selectedBaseline: null,
            selectedTiers: [],
            validationResults: null,
            deploymentPlan: null
        };
    }

    selectBaseline(baselineKey) {
        const baseline = baselineService.getBaseline(baselineKey);
        this.baselineState.selectedBaseline = baselineKey;

        // Populate tier configuration
        const tierConfigDiv = document.getElementById('baseline-tier-config');
        tierConfigDiv.innerHTML = `
            <div class="card">
                <h3><i class="fas fa-info-circle"></i> Selected: ${baseline.name}</h3>
                <p>${baseline.description}</p>
            </div>

            <div class="tiers-list">
                ${baseline.tiers.map((tier, index) => `
                    <div class="card tier-card">
                        <div class="tier-header">
                            <label class="checkbox-label tier-checkbox">
                                <input type="checkbox" class="tier-select" data-tier="${index}" checked>
                                <h3>
                                    ${tier.tier === 0 ? 'üíÄ' : tier.tier === 1 ? '‚ö†Ô∏è' : 'üîµ'}
                                    ${tier.name}
                                </h3>
                            </label>
                        </div>

                        <div class="tier-policy-summary">
                            <h4>Policy Configuration:</h4>
                            <div class="policy-grid">
                                <div class="policy-item">
                                    <i class="fas fa-clock"></i>
                                    <span>Max Duration: ${tier.policy.maximumDurationHours}h</span>
                                </div>
                                <div class="policy-item">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>MFA: ${tier.policy.requireMfa ? 'Required' : 'Optional'}</span>
                                </div>
                                <div class="policy-item">
                                    <i class="fas fa-clipboard-check"></i>
                                    <span>Approval: ${tier.policy.requireApproval ? 'Required' : 'Not Required'}</span>
                                </div>
                                <div class="policy-item">
                                    <i class="fas fa-comment-dots"></i>
                                    <span>Justification: ${tier.policy.requireJustification ? 'Required' : 'Optional'}</span>
                                </div>
                            </div>
                        </div>

                        <div class="tier-groups">
                            <h4>Groups to Create (${tier.groups.length}):</h4>
                            <p class="form-hint"><i class="fas fa-info-circle"></i> Click the arrow (‚ñº) on each group to customize name and add users</p>
                            <div class="groups-list">
                                ${tier.groups.map((group, gIndex) => `
                                    <div class="group-item baseline-group-item" data-tier="${index}" data-group-index="${gIndex}">
                                        <div class="group-item-header">
                                            <label class="checkbox-label">
                                                <input type="checkbox" class="group-select" data-tier="${index}" data-group="${group.name}" checked>
                                                <div class="group-info-compact">
                                                    <i class="fas fa-users"></i>
                                                    <span>${group.name}</span>
                                                </div>
                                            </label>
                                            <button class="btn btn-sm btn-secondary" onclick="app.toggleGroupDetails(${index}, ${gIndex})">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                        </div>

                                        <div class="group-item-details" id="group-details-${index}-${gIndex}">
                                            <div class="form-group">
                                                <label>Group Name</label>
                                                <input type="text" class="input group-name-input"
                                                    data-tier="${index}"
                                                    data-group-index="${gIndex}"
                                                    data-original="${group.name}"
                                                    value="${group.name}">
                                                <small class="form-hint">Customize the group name (must be unique)</small>
                                            </div>

                                            <div class="form-group">
                                                <label>Description</label>
                                                <textarea class="input group-desc-input"
                                                    data-tier="${index}"
                                                    data-group-index="${gIndex}"
                                                    rows="2">${group.description}</textarea>
                                            </div>

                                            <div class="form-group">
                                                <label>Assigned Roles</label>
                                                <div class="group-roles-list">
                                                    <i class="fas fa-user-shield"></i>
                                                    ${group.roles.length} role${group.roles.length !== 1 ? 's' : ''}
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label>Assignment Type</label>
                                                <div class="assignment-type-toggle">
                                                    <label class="toggle-option ${!group.isActive ? 'active' : ''}" data-tier="${index}" data-group-index="${gIndex}" data-type="eligible">
                                                        <input type="radio" name="assignment-type-${index}-${gIndex}" value="eligible" checked>
                                                        <div class="toggle-content">
                                                            <i class="fas fa-clock"></i>
                                                            <span>Eligible</span>
                                                            <small>Users activate when needed</small>
                                                        </div>
                                                    </label>
                                                    <label class="toggle-option ${group.isActive ? 'active' : ''}" data-tier="${index}" data-group-index="${gIndex}" data-type="active">
                                                        <input type="radio" name="assignment-type-${index}-${gIndex}" value="active">
                                                        <div class="toggle-content">
                                                            <i class="fas fa-check-circle"></i>
                                                            <span>Active</span>
                                                            <small>Always active (permanent)</small>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label>Add Users (Optional)</label>
                                                <div class="user-search-container">
                                                    <input type="text"
                                                        class="input user-search-input"
                                                        data-tier="${index}"
                                                        data-group-index="${gIndex}"
                                                        placeholder="Search users by name or email...">
                                                    <div class="user-search-results" id="user-search-results-${index}-${gIndex}"></div>
                                                </div>
                                                <div class="selected-users-list" id="selected-users-${index}-${gIndex}">
                                                    <small class="form-hint">No users added yet. Search above to add users.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        // Navigate to step 2
        this.goToBaselineStep(2);

        // Initialize user selections storage
        this.baselineState.groupUsers = {};
        this.baselineState.groupCustomizations = {};

        // Add event listeners for tier checkboxes
        document.querySelectorAll('.tier-select').forEach(cb => {
            cb.addEventListener('change', (e) => {
                const tierIndex = parseInt(e.target.dataset.tier);
                const groupCheckboxes = document.querySelectorAll(`.group-select[data-tier="${tierIndex}"]`);
                groupCheckboxes.forEach(gcb => {
                    gcb.checked = e.target.checked;
                    gcb.disabled = !e.target.checked;
                });
            });
        });

        // Add event listeners for assignment type toggle
        document.querySelectorAll('.toggle-option').forEach(option => {
            option.addEventListener('click', (e) => {
                const label = e.currentTarget;
                const tierIndex = label.dataset.tier;
                const groupIndex = label.dataset.groupIndex;
                const type = label.dataset.type;

                // Update UI
                const siblingOptions = document.querySelectorAll(`.toggle-option[data-tier="${tierIndex}"][data-group-index="${groupIndex}"]`);
                siblingOptions.forEach(opt => opt.classList.remove('active'));
                label.classList.add('active');

                // Update radio button
                label.querySelector('input[type="radio"]').checked = true;

                // Store in state
                const key = `${tierIndex}-${groupIndex}`;
                if (!this.baselineState.groupCustomizations[key]) {
                    this.baselineState.groupCustomizations[key] = {};
                }
                this.baselineState.groupCustomizations[key].assignmentType = type;
            });
        });

        // Add event listeners for user search
        document.querySelectorAll('.user-search-input').forEach(input => {
            let searchTimeout;
            input.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                const tierIndex = e.target.dataset.tier;
                const groupIndex = e.target.dataset.groupIndex;

                if (query.length < 2) {
                    document.getElementById(`user-search-results-${tierIndex}-${groupIndex}`).innerHTML = '';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    this.searchUsersForBaseline(tierIndex, groupIndex, query);
                }, 300);
            });
        });
    }

    toggleGroupDetails(tierIndex, groupIndex) {
        const detailsDiv = document.getElementById(`group-details-${tierIndex}-${groupIndex}`);
        const button = event.target.closest('button');
        const icon = button.querySelector('i');

        if (detailsDiv.style.display === 'none' || !detailsDiv.style.display) {
            detailsDiv.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
        } else {
            detailsDiv.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
        }
    }

    async searchUsersForBaseline(tierIndex, groupIndex, query) {
        const resultsDiv = document.getElementById(`user-search-results-${tierIndex}-${groupIndex}`);
        resultsDiv.innerHTML = '<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';

        try {
            const result = await graphService.searchUsers(query);

            if (result.success && result.users.length > 0) {
                resultsDiv.innerHTML = result.users.map(user => `
                    <div class="user-search-result" onclick="app.addUserToGroup(${tierIndex}, ${groupIndex}, '${user.id}', '${user.displayName}', '${user.userPrincipalName}')">
                        <div class="user-info">
                            <i class="fas fa-user"></i>
                            <div>
                                <div class="user-name">${user.displayName}</div>
                                <div class="user-email">${user.userPrincipalName}</div>
                            </div>
                        </div>
                        <i class="fas fa-plus-circle"></i>
                    </div>
                `).join('');
            } else {
                resultsDiv.innerHTML = '<div class="search-no-results">No users found</div>';
            }
        } catch (error) {
            resultsDiv.innerHTML = '<div class="search-error">Search failed</div>';
        }
    }

    addUserToGroup(tierIndex, groupIndex, userId, displayName, userPrincipalName) {
        const key = `${tierIndex}-${groupIndex}`;

        // Initialize array if needed
        if (!this.baselineState.groupUsers[key]) {
            this.baselineState.groupUsers[key] = [];
        }

        // Check if user already added
        if (this.baselineState.groupUsers[key].some(u => u.id === userId)) {
            this.showToast('User already added to this group', 'info');
            return;
        }

        // Add user
        this.baselineState.groupUsers[key].push({ id: userId, displayName, userPrincipalName });

        // Update UI
        this.updateSelectedUsersList(tierIndex, groupIndex);

        // Clear search
        document.querySelector(`.user-search-input[data-tier="${tierIndex}"][data-group-index="${groupIndex}"]`).value = '';
        document.getElementById(`user-search-results-${tierIndex}-${groupIndex}`).innerHTML = '';

        this.showToast(`Added ${displayName} to group`, 'success');
    }

    removeUserFromGroup(tierIndex, groupIndex, userId) {
        const key = `${tierIndex}-${groupIndex}`;

        if (this.baselineState.groupUsers[key]) {
            this.baselineState.groupUsers[key] = this.baselineState.groupUsers[key].filter(u => u.id !== userId);
            this.updateSelectedUsersList(tierIndex, groupIndex);
        }
    }

    updateSelectedUsersList(tierIndex, groupIndex) {
        const key = `${tierIndex}-${groupIndex}`;
        const users = this.baselineState.groupUsers[key] || [];
        const listDiv = document.getElementById(`selected-users-${tierIndex}-${groupIndex}`);

        if (users.length === 0) {
            listDiv.innerHTML = '<small class="form-hint">No users added yet. Search above to add users.</small>';
        } else {
            listDiv.innerHTML = `
                <div class="selected-users-header">
                    <strong>${users.length} user${users.length !== 1 ? 's' : ''} will be added:</strong>
                </div>
                ${users.map(user => `
                    <div class="selected-user-item">
                        <div class="user-info">
                            <i class="fas fa-user"></i>
                            <div>
                                <div class="user-name">${user.displayName}</div>
                                <div class="user-email">${user.userPrincipalName}</div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="app.removeUserFromGroup(${tierIndex}, ${groupIndex}, '${user.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('')}
            `;
        }
    }

    async validateBaseline() {
        if (!this.baselineState.selectedBaseline) {
            this.showToast('No baseline selected', 'error');
            return;
        }

        this.showLoading('Validating configuration...');

        try {
            const baseline = baselineService.getBaseline(this.baselineState.selectedBaseline);

            // Collect selected tiers and groups
            const selectedConfig = {
                baseline: this.baselineState.selectedBaseline,
                tiers: []
            };

            document.querySelectorAll('.tier-select:checked').forEach(tierCb => {
                const tierIndex = parseInt(tierCb.dataset.tier);
                const tier = baseline.tiers[tierIndex];

                const selectedGroups = [];
                document.querySelectorAll(`.group-select[data-tier="${tierIndex}"]:checked`).forEach((groupCb) => {
                    const groupName = groupCb.dataset.group;
                    const groupIndex = tier.groups.findIndex(g => g.name === groupName);
                    const group = tier.groups[groupIndex];

                    if (group && groupIndex !== -1) {
                        // Get customized values using the actual group index
                        const nameInput = document.querySelector(`.group-name-input[data-tier="${tierIndex}"][data-group-index="${groupIndex}"]`);
                        const descInput = document.querySelector(`.group-desc-input[data-tier="${tierIndex}"][data-group-index="${groupIndex}"]`);
                        const assignmentTypeRadio = document.querySelector(`input[name="assignment-type-${tierIndex}-${groupIndex}"]:checked`);

                        const customizedGroup = {
                            ...group,
                            name: nameInput ? nameInput.value.trim() : group.name,
                            description: descInput ? descInput.value.trim() : group.description,
                            originalName: group.name,
                            assignmentType: assignmentTypeRadio ? assignmentTypeRadio.value : 'eligible'
                        };

                        // Store customizations
                        const key = `${tierIndex}-${groupIndex}`;
                        this.baselineState.groupCustomizations[key] = {
                            name: customizedGroup.name,
                            description: customizedGroup.description,
                            users: this.baselineState.groupUsers[key] || [],
                            assignmentType: customizedGroup.assignmentType
                        };

                        selectedGroups.push(customizedGroup);
                    }
                });

                if (selectedGroups.length > 0) {
                    selectedConfig.tiers.push({
                        ...tier,
                        groups: selectedGroups
                    });
                }
            });

            this.baselineState.selectedTiers = selectedConfig.tiers;

            // Validate against existing environment
            const existingGroups = await graphService.getPIMGroups();
            const existingRoles = await graphService.getRoleDefinitions();

            const validation = baselineService.validateBaseline(selectedConfig, {
                existingGroups: existingGroups.groups || [],
                existingRoles: existingRoles.roles || []
            });

            this.baselineState.validationResults = validation;

            // Calculate deployment plan
            const deploymentPlan = baselineService.calculateDeploymentPlan(selectedConfig, {
                existingGroups: existingGroups.groups || [],
                existingRoles: existingRoles.roles || []
            });

            this.baselineState.deploymentPlan = deploymentPlan;

            this.hideLoading();

            // Display validation results
            this.displayValidationResults(validation, deploymentPlan);
            this.goToBaselineStep(3);

        } catch (error) {
            this.hideLoading();
            this.showToast('Validation failed: ' + error.message, 'error');
        }
    }

    displayValidationResults(validation, plan) {
        const resultsDiv = document.getElementById('baseline-validation-results');
        const planDiv = document.getElementById('baseline-deployment-plan');

        // Validation results
        const hasErrors = validation.errors.length > 0;
        const hasWarnings = validation.warnings.length > 0;

        resultsDiv.innerHTML = `
            <div class="card ${hasErrors ? 'validation-error' : hasWarnings ? 'validation-warning' : 'validation-success'}">
                <h3>
                    <i class="fas ${hasErrors ? 'fa-times-circle' : hasWarnings ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
                    Validation ${hasErrors ? 'Failed' : hasWarnings ? 'Passed with Warnings' : 'Passed'}
                </h3>

                ${validation.errors.length > 0 ? `
                    <div class="validation-section validation-errors">
                        <h4><i class="fas fa-times-circle"></i> Errors</h4>
                        <ul>
                            ${validation.errors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${validation.warnings.length > 0 ? `
                    <div class="validation-section validation-warnings">
                        <h4><i class="fas fa-exclamation-triangle"></i> Warnings</h4>
                        <ul>
                            ${validation.warnings.map(warn => `<li>${warn}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${!hasErrors && !hasWarnings ? `
                    <p><i class="fas fa-check"></i> Configuration is valid and ready for deployment.</p>
                ` : ''}

                ${validation.newGroups && validation.newGroups.length > 0 ? `
                    <div class="validation-summary">
                        <h4><i class="fas fa-info-circle"></i> Summary</h4>
                        <p><strong>${validation.newGroups.length} new group(s)</strong> will be created:</p>
                        <ul class="group-list-compact">
                            ${validation.newGroups.map(name => `<li><i class="fas fa-plus-circle"></i> ${name}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${validation.existingGroups && validation.existingGroups.length > 0 ? `
                    <div class="validation-summary">
                        <p><strong>${validation.existingGroups.length} existing group(s)</strong> will be skipped:</p>
                        <ul class="group-list-compact">
                            ${validation.existingGroups.map(name => `<li><i class="fas fa-check-circle"></i> ${name}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        `;

        // Deployment plan
        const summary = baselineService.getBaselineSummary(this.baselineState.selectedBaseline);

        planDiv.innerHTML = `
            <div class="card deployment-plan-card">
                <h3><i class="fas fa-tasks"></i> Deployment Plan</h3>

                <div class="plan-summary">
                    <div class="plan-stat">
                        <span class="plan-value">${plan.groupsToCreate.length}</span>
                        <span class="plan-label">Groups to Create</span>
                    </div>
                    <div class="plan-stat">
                        <span class="plan-value">${plan.policiesToConfigure.length}</span>
                        <span class="plan-label">Policies to Configure</span>
                    </div>
                    <div class="plan-stat">
                        <span class="plan-value">${plan.roleAssignmentsToCreate.length}</span>
                        <span class="plan-label">Role Assignments</span>
                    </div>
                    <div class="plan-stat">
                        <span class="plan-value">${plan.estimatedTime}</span>
                        <span class="plan-label">Est. Time</span>
                    </div>
                </div>

                <div class="plan-details">
                    <h4>Deployment Steps:</h4>
                    <ol class="deployment-steps-list">
                        ${plan.steps.map(step => `
                            <li>
                                <i class="fas ${step.icon}"></i>
                                <strong>${step.title}</strong>
                                <p>${step.description}</p>
                            </li>
                        `).join('')}
                    </ol>
                </div>

                <div class="plan-groups-preview">
                    <h4>Groups to be created:</h4>
                    <div class="groups-preview-list">
                        ${plan.groupsToCreate.map(group => `
                            <div class="group-preview-item">
                                <i class="fas fa-users"></i>
                                <div>
                                    <strong>${group.displayName}</strong>
                                    <p>${group.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        // Enable/disable deploy button based on validation
        const deployBtn = document.getElementById('deploy-baseline-btn');
        if (deployBtn) {
            deployBtn.disabled = hasErrors;
        }
    }

    async executeBaselineDeployment() {
        if (!this.baselineState.deploymentPlan) {
            this.showToast('No deployment plan available', 'error');
            return;
        }

        const confirmed = confirm(
            `This will create ${this.baselineState.deploymentPlan.groupsToCreate.length} groups and configure their policies.\n\n` +
            'This action cannot be undone automatically. Continue?'
        );

        if (!confirmed) return;

        this.goToBaselineStep(4);

        const progressDiv = document.getElementById('baseline-deployment-progress');
        const plan = this.baselineState.deploymentPlan;
        // Calculate total steps: group creation + role assignments + policy updates
        const totalRoleAssignments = plan.groupsToCreate.reduce((sum, g) => sum + (g.roles?.length || 0), 0);
        const totalSteps = plan.groupsToCreate.length + totalRoleAssignments + totalRoleAssignments; // groups + assignments + policies
        let completedSteps = 0;

        const updateProgress = (message, isError = false) => {
            completedSteps++;
            const percentage = Math.round((completedSteps / totalSteps) * 100);

            const logEntry = document.createElement('div');
            logEntry.className = `deployment-log-entry ${isError ? 'log-error' : 'log-success'}`;
            logEntry.innerHTML = `
                <i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'}"></i>
                <span>${message}</span>
            `;

            const logContainer = progressDiv.querySelector('.deployment-log') || (() => {
                const container = document.createElement('div');
                container.className = 'deployment-log';
                progressDiv.appendChild(container);
                return container;
            })();

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Update progress bar
            const progressBar = progressDiv.querySelector('.progress-bar-fill');
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
                progressBar.textContent = `${percentage}%`;
            }
        };

        progressDiv.innerHTML = `
            <div class="card">
                <h3><i class="fas fa-spinner fa-spin"></i> Deploying Baseline Configuration</h3>
                <div class="progress-bar">
                    <div class="progress-bar-fill" style="width: 0%">0%</div>
                </div>
                <div class="deployment-log"></div>
            </div>
        `;

        try {
            // Step 0: Fetch all roles for display names
            updateProgress('Fetching role information...');
            const rolesResult = await graphService.getRoleDefinitions();
            const rolesMap = new Map();
            if (rolesResult.success) {
                rolesResult.roles.forEach(role => {
                    rolesMap.set(role.id, role.displayName);
                });
            }

            // Step 1: Create groups
            updateProgress('Starting group creation...');
            const createdGroups = [];

            for (const groupConfig of plan.groupsToCreate) {
                try {
                    const result = await graphService.createPIMGroup(
                        groupConfig.displayName,
                        groupConfig.description,
                        groupConfig.mailNickname
                    );
                    if (result.success) {
                        createdGroups.push({ config: groupConfig, group: result.group });
                        updateProgress(`‚úì Created group: ${groupConfig.displayName}`);
                    } else {
                        updateProgress(`‚úó Failed to create group: ${groupConfig.displayName} - ${result.error}`, true);
                    }
                } catch (error) {
                    updateProgress(`‚úó Error creating group: ${groupConfig.displayName} - ${error.message}`, true);
                }
            }

            // Step 2: Wait for groups to be fully provisioned
            updateProgress('Waiting for groups to provision (this may take 30-60 seconds)...');
            await new Promise(resolve => setTimeout(resolve, 30000)); // Wait 30 seconds

            // Step 3: Assign groups to roles
            updateProgress('Assigning groups to roles...');
            const roleAssignments = [];

            for (const createdGroup of createdGroups) {
                // Get the roles for this group from config
                const roles = createdGroup.config.roles || [];

                // Find the customization for this group to get assignment type
                const customizationEntry = Object.entries(this.baselineState.groupCustomizations || {}).find(
                    ([key, value]) => value.name === createdGroup.config.displayName
                );
                const assignmentType = customizationEntry ? customizationEntry[1].assignmentType : 'eligible';

                for (const roleId of roles) {
                    try {
                        let assignResult;

                        if (assignmentType === 'active') {
                            // Create active (permanent) assignment
                            assignResult = await graphService.createDirectoryRoleActiveAssignment(
                                createdGroup.group.id,
                                roleId,
                                `Baseline deployment (Active): ${createdGroup.config.displayName}`
                            );
                        } else {
                            // Create eligible assignment (default)
                            assignResult = await graphService.createDirectoryRoleEligibilityAssignment(
                                createdGroup.group.id,
                                roleId,
                                `Baseline deployment (Eligible): ${createdGroup.config.displayName}`,
                                12 // 12 months eligibility
                            );
                        }

                        if (assignResult.success) {
                            const roleName = rolesMap.get(roleId) || roleId;
                            roleAssignments.push({
                                groupId: createdGroup.group.id,
                                groupName: createdGroup.config.displayName,
                                roleId: roleId,
                                roleName: roleName,
                                policy: createdGroup.config.policy
                            });
                            updateProgress(`‚úì Assigned ${createdGroup.config.displayName} to ${roleName} (${assignmentType})`);
                        } else {
                            updateProgress(`‚úó Failed to assign ${createdGroup.config.displayName}: ${assignResult.error}`, true);
                        }
                    } catch (error) {
                        updateProgress(`‚úó Error assigning ${createdGroup.config.displayName}: ${error.message}`, true);
                    }
                }
            }

            // Step 4: Wait for role assignments to propagate
            updateProgress('Waiting for role assignments to propagate (10 seconds)...');
            await new Promise(resolve => setTimeout(resolve, 10000));

            updateProgress(`‚úì Role assignments complete. ${roleAssignments.length} groups assigned to roles.`);

            // Step 5: Configure role policies (NOTE: These are global settings per role)
            if (roleAssignments.length > 0) {
                updateProgress('Configuring role policies...');

                // Group assignments by role to avoid duplicate policy updates
                const roleConfigMap = new Map();
                roleAssignments.forEach(assignment => {
                    if (!roleConfigMap.has(assignment.roleId)) {
                        roleConfigMap.set(assignment.roleId, {
                            roleId: assignment.roleId,
                            roleName: assignment.roleName,
                            groupName: assignment.groupName,
                            policy: assignment.policy
                        });
                    }
                });

                for (const [roleId, config] of roleConfigMap) {
                    try {
                        // Get the role policy
                        updateProgress(`Fetching policy for ${config.roleName}...`);
                        const policiesResult = await graphService.getRolePolicy(roleId);

                        console.log(`Policy result for ${config.roleName}:`, policiesResult);

                        if (policiesResult.success && policiesResult.policy) {
                            let updatedCount = 0;

                            // Update expiration rule
                            try {
                                await graphService.updateRolePolicy(
                                    policiesResult.policy.id,
                                    'Expiration_EndUser_Assignment',
                                    {
                                        maximumDuration: `PT${config.policy.maximumDurationHours}H`,
                                        isExpirationRequired: true
                                    }
                                );
                                updatedCount++;
                            } catch (err) {
                                console.error('Expiration rule update failed:', err);
                            }

                            // Update enablement rule
                            try {
                                await graphService.updateRolePolicy(
                                    policiesResult.policy.id,
                                    'Enablement_EndUser_Assignment',
                                    {
                                        enabledRules: [
                                            config.policy.requireMfa ? 'MultiFactorAuthentication' : null,
                                            config.policy.requireJustification ? 'Justification' : null,
                                            config.policy.requireTicketInfo ? 'Ticketing' : null
                                        ].filter(r => r !== null)
                                    }
                                );
                                updatedCount++;
                            } catch (err) {
                                console.error('Enablement rule update failed:', err);
                            }

                            // Update approval rule
                            try {
                                await graphService.updateRolePolicy(
                                    policiesResult.policy.id,
                                    'Approval_EndUser_Assignment',
                                    {
                                        isApprovalRequired: config.policy.requireApproval
                                    }
                                );
                                updatedCount++;
                            } catch (err) {
                                console.error('Approval rule update failed:', err);
                            }

                            if (updatedCount > 0) {
                                updateProgress(`‚úì Updated ${config.roleName} policy (${updatedCount}/3 rules)`);
                            } else {
                                updateProgress(`‚ö† Could not update ${config.roleName} policy`, false);
                            }
                        } else {
                            const errorMsg = policiesResult.error || 'Unknown error';
                            updateProgress(`‚ö† Could not fetch ${config.roleName} policy: ${errorMsg}`, false);
                        }
                    } catch (error) {
                        updateProgress(`‚ö† Policy update error: ${error.message}`, false);
                    }
                }
            }

            // Step 6: Add users to groups (if any were selected)
            const totalUsersToAdd = Object.values(this.baselineState.groupUsers || {}).reduce((sum, users) => sum + users.length, 0);

            if (totalUsersToAdd > 0) {
                updateProgress(`Adding ${totalUsersToAdd} users to groups...`);

                for (const createdGroup of createdGroups) {
                    // Find the customization key for this group
                    const customizationEntry = Object.entries(this.baselineState.groupCustomizations || {}).find(
                        ([key, value]) => value.name === createdGroup.config.displayName
                    );

                    if (customizationEntry && customizationEntry[1].users && customizationEntry[1].users.length > 0) {
                        const users = customizationEntry[1].users;

                        for (const user of users) {
                            try {
                                // Create eligible assignment for member role (access to group)
                                const assignResult = await graphService.createEligibleAssignment(
                                    createdGroup.group.id,
                                    user.id,
                                    'member', // member access
                                    null,
                                    null // no expiration for now
                                );

                                if (assignResult.success) {
                                    updateProgress(`‚úì Added ${user.displayName} to ${createdGroup.config.displayName}`);
                                } else {
                                    updateProgress(`‚úó Failed to add ${user.displayName}: ${assignResult.error}`, true);
                                }
                            } catch (error) {
                                updateProgress(`‚úó Error adding ${user.displayName}: ${error.message}`, true);
                            }
                        }
                    }
                }
            }

            // Step 7: Complete
            updateProgress('Deployment completed!');

            progressDiv.innerHTML += `
                <div class="deployment-complete">
                    <i class="fas fa-check-circle"></i>
                    <h3>Baseline Deployed Successfully!</h3>
                    <p>Created ${createdGroups.length} groups with configured policies.</p>
                    <div class="deployment-actions">
                        <button class="btn btn-primary" onclick="app.navigateTo('groups')">
                            <i class="fas fa-users"></i> View Groups
                        </button>
                        <button class="btn btn-secondary" onclick="app.renderPage('baseline')">
                            <i class="fas fa-redo"></i> Deploy Another Baseline
                        </button>
                    </div>
                </div>
            `;

            this.showToast('Baseline deployed successfully!', 'success');

        } catch (error) {
            updateProgress(`‚úó Deployment failed: ${error.message}`, true);
            this.showToast('Deployment failed: ' + error.message, 'error');

            progressDiv.innerHTML += `
                <div class="deployment-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Deployment Failed</h3>
                    <p>${error.message}</p>
                    <button class="btn btn-secondary" onclick="app.previousBaselineStep()">
                        <i class="fas fa-arrow-left"></i> Go Back
                    </button>
                </div>
            `;
        }
    }

    goToBaselineStep(stepNumber) {
        // Hide all steps
        document.querySelectorAll('.baseline-step').forEach(step => {
            step.classList.remove('active');
        });

        // Show target step
        const targetStep = document.getElementById(`baseline-step-${stepNumber}`);
        if (targetStep) {
            targetStep.classList.add('active');
            document.getElementById('baseline-wizard-step').dataset.step = stepNumber;
        }
    }

    previousBaselineStep() {
        const currentStep = parseInt(document.getElementById('baseline-wizard-step').dataset.step);
        if (currentStep > 1) {
            this.goToBaselineStep(currentStep - 1);
        }
    }

    // ==========================================
    // Actions
    // ==========================================

    async showCreateGroup() {
        const html = `
            <h2>Create PIM Group</h2>
            <form id="create-group-form">
                <div class="form-group">
                    <label>Display Name *</label>
                    <input type="text" id="group-name" class="input" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="group-description" class="input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Mail Nickname</label>
                    <input type="text" id="group-nickname" class="input" placeholder="Auto-generated if empty">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Group</button>
                </div>
            </form>
        `;

        this.showModal(html);

        document.getElementById('create-group-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('group-name').value;
            const description = document.getElementById('group-description').value;
            const nickname = document.getElementById('group-nickname').value;

            this.showLoading('Creating group...');
            const result = await graphService.createPIMGroup(name, description, nickname);
            this.hideLoading();

            if (result.success) {
                this.closeModal();
                this.showToast('Group created successfully', 'success');
                this.cache.groups = null;
                this.refreshCurrentPage();
            } else {
                this.showToast(result.error, 'error');
            }
        });
    }

    async deleteGroup(groupId) {
        if (!confirm('Are you sure you want to delete this group? This action cannot be undone.')) {
            return;
        }

        this.showLoading('Deleting group...');
        const result = await graphService.deleteGroup(groupId);
        this.hideLoading();

        if (result.success) {
            this.showToast('Group deleted successfully', 'success');
            this.cache.groups = null;
            this.refreshCurrentPage();
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async manageGroup(groupId) {
        this.showLoading('Loading group members...');

        const group = this.cache.groups?.find(g => g.id === groupId);
        const membersResult = await graphService.getGroupMembers(groupId);

        this.hideLoading();

        const members = membersResult.success ? membersResult.members : [];

        const html = `
            <h2>Manage Group: ${this.escapeHtml(group?.displayName || 'Unknown')}</h2>

            <div style="margin: var(--space-md) 0;">
                <h3 style="margin-bottom: var(--space-sm);">Current Members (${members.length})</h3>

                <div id="members-list" style="max-height: 300px; overflow-y: auto; margin-bottom: var(--space-md);">
                    ${members.length > 0 ? members.map(member => `
                        <div class="member-item" style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-sm); border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                <i class="fas fa-user" style="color: var(--text-secondary);"></i>
                                <div>
                                    <div style="font-weight: 500;">${this.escapeHtml(member.displayName)}</div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">${this.escapeHtml(member.userPrincipalName || member.mail || '')}</div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-danger" onclick="app.removeGroupMember('${groupId}', '${member.id}')">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>
                    `).join('') : `
                        <p style="color: var(--text-secondary); text-align: center; padding: var(--space-lg);">
                            <i class="fas fa-users" style="font-size: 2em; opacity: 0.3; display: block; margin-bottom: var(--space-sm);"></i>
                            No members yet
                        </p>
                    `}
                </div>

                <h3 style="margin-bottom: var(--space-sm);">Add Member</h3>
                <div style="display: flex; gap: var(--space-sm);">
                    <input type="text" id="user-search" class="input" placeholder="Search for user by name or email..." style="flex: 1;">
                    <button type="button" class="btn btn-primary" onclick="app.searchAndAddMember('${groupId}')">
                        <i class="fas fa-search"></i> Search & Add
                    </button>
                </div>
                <div id="search-results" style="margin-top: var(--space-sm);"></div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Close</button>
            </div>
        `;

        this.showModal(html);
    }

    async searchAndAddMember(groupId) {
        const searchInput = document.getElementById('user-search');
        const query = searchInput.value.trim();

        if (!query || query.length < 2) {
            this.showToast('Please enter at least 2 characters to search', 'warning');
            return;
        }

        const searchResultsDiv = document.getElementById('search-results');
        searchResultsDiv.innerHTML = '<p style="color: var(--text-secondary);"><i class="fas fa-spinner fa-spin"></i> Searching...</p>';

        const result = await graphService.searchUsers(query);

        if (!result.success || result.users.length === 0) {
            searchResultsDiv.innerHTML = '<p style="color: var(--text-secondary);">No users found</p>';
            return;
        }

        searchResultsDiv.innerHTML = `
            <div style="border: 1px solid var(--border-color); border-radius: var(--radius-md); max-height: 200px; overflow-y: auto;">
                ${result.users.map(user => `
                    <div style="padding: var(--space-sm); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 500;">${this.escapeHtml(user.displayName)}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${this.escapeHtml(user.userPrincipalName)}</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="app.addUserToGroup('${groupId}', '${user.id}')">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    async addUserToGroup(groupId, userId) {
        this.showLoading('Adding member...');
        const result = await graphService.addGroupMember(groupId, userId);
        this.hideLoading();

        if (result.success) {
            this.showToast('Member added successfully', 'success');
            // Refresh the group management modal
            this.closeModal();
            setTimeout(() => this.manageGroup(groupId), 300);
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async removeGroupMember(groupId, memberId) {
        if (!confirm('Remove this member from the group?')) {
            return;
        }

        this.showLoading('Removing member...');
        const result = await graphService.removeGroupMember(groupId, memberId);
        this.hideLoading();

        if (result.success) {
            this.showToast('Member removed successfully', 'success');
            // Refresh the group management modal
            this.closeModal();
            setTimeout(() => this.manageGroup(groupId), 300);
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async saveGroupPolicy(groupId) {
        const settings = {
            maximumDurationHours: parseInt(document.getElementById('max-duration').value),
            requireMfa: document.getElementById('require-mfa').checked,
            requireJustification: document.getElementById('require-justification').checked,
            requireApproval: document.getElementById('require-approval').checked
        };

        this.showLoading('Saving policy...');
        const result = await graphService.updateGroupPolicy(groupId, 'member', settings);
        this.hideLoading();

        if (result.success) {
            this.closeModal();
            this.showToast('Policy updated successfully', 'success');
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async refreshGroups() {
        this.cache.groups = null;
        await this.renderPage('groups');
    }

    async refreshRoles() {
        this.cache.roles = null;
        await this.renderPage('roles');
    }

    filterGroups(query) {
        const rows = document.querySelectorAll('#groups-table tbody tr');
        const q = query.toLowerCase();
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(q) ? '' : 'none';
        });
    }

    filterRoles(query) {
        const rows = document.querySelectorAll('#roles-table tbody tr');
        const q = query.toLowerCase();
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(q) ? '' : 'none';
        });
    }

    // Pagination handlers
    handleGroupsPageChange(page) {
        this.paginators.groups.goToPage(page);
        this.renderPage('groups');
    }

    handleGroupsPageSizeChange(size) {
        this.paginators.groups.setPageSize(size);
        this.renderPage('groups');
    }

    handleRolesPageChange(page) {
        this.paginators.roles.goToPage(page);
        this.renderPage('roles');
    }

    handleRolesPageSizeChange(size) {
        this.paginators.roles.setPageSize(size);
        this.renderPage('roles');
    }

    handleActivityPageChange(page) {
        this.paginators.activity.goToPage(page);
        this.renderPage('pim-activity');
    }

    handleActivityPageSizeChange(size) {
        this.paginators.activity.setPageSize(size);
        this.renderPage('pim-activity');
    }

    showGlobalSearch() {
        this.showToast('Global search coming soon', 'info');
    }

    // Export methods
    exportGroupsToCSV() {
        try {
            const groups = this.cache.groups || [];
            if (groups.length === 0) {
                this.showToast('No groups to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('pim-groups');
            ExportUtils.exportToCSV(groups, filename, ExportConfigs.groups.columns);
            this.showToast(`Exported ${groups.length} groups to CSV`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    exportGroupsToJSON() {
        try {
            const groups = this.cache.groups || [];
            if (groups.length === 0) {
                this.showToast('No groups to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('pim-groups');
            ExportUtils.exportToJSON(groups, filename);
            this.showToast(`Exported ${groups.length} groups to JSON`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    exportRolesToCSV() {
        try {
            const roles = this.cache.roles || [];
            if (roles.length === 0) {
                this.showToast('No roles to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('entra-roles');
            ExportUtils.exportToCSV(roles, filename, ExportConfigs.roles.columns);
            this.showToast(`Exported ${roles.length} roles to CSV`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    exportRolesToJSON() {
        try {
            const roles = this.cache.roles || [];
            if (roles.length === 0) {
                this.showToast('No roles to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('entra-roles');
            ExportUtils.exportToJSON(roles, filename);
            this.showToast(`Exported ${roles.length} roles to JSON`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    exportActivityToCSV() {
        try {
            const logs = this.paginators.activity.allItems || [];
            if (logs.length === 0) {
                this.showToast('No activity logs to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('pim-activity');
            ExportUtils.exportToCSV(logs, filename, ExportConfigs.activity.columns);
            this.showToast(`Exported ${logs.length} activity logs to CSV`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    exportActivityToJSON() {
        try {
            const logs = this.paginators.activity.allItems || [];
            if (logs.length === 0) {
                this.showToast('No activity logs to export', 'warning');
                return;
            }

            const filename = ExportUtils.generateFilename('pim-activity');
            ExportUtils.exportToJSON(logs, filename);
            this.showToast(`Exported ${logs.length} activity logs to JSON`, 'success');
        } catch (error) {
            this.showToast(`Export failed: ${error.message}`, 'error');
        }
    }

    showExportMenu(type) {
        const content = `
            <div style="text-align: center; padding: var(--space-xl);">
                <div style="width: 80px; height: 80px; margin: 0 auto var(--space-lg); background: var(--accent-primary-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-file-export" style="font-size: 2.5rem; color: var(--accent-primary);"></i>
                </div>

                <h2 style="font-family: var(--font-display); font-size: 1.5rem; font-weight: 800; margin-bottom: var(--space-md);">
                    Export ${type.charAt(0).toUpperCase() + type.slice(1)}
                </h2>

                <p style="font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-secondary); margin-bottom: var(--space-xl);">
                    Choose your preferred export format
                </p>

                <div style="display: flex; flex-direction: column; gap: var(--space-md); max-width: 400px; margin: 0 auto;">
                    <button class="btn btn-primary" onclick="app.export${type.charAt(0).toUpperCase() + type.slice(1)}ToCSV(); app.closeModal();" style="justify-content: center; font-family: var(--font-mono); padding: var(--space-md);">
                        <i class="fas fa-file-csv"></i> Export as CSV
                        <span style="font-size: 0.75rem; opacity: 0.7; margin-left: auto;">Spreadsheet compatible</span>
                    </button>

                    <button class="btn btn-secondary" onclick="app.export${type.charAt(0).toUpperCase() + type.slice(1)}ToJSON(); app.closeModal();" style="justify-content: center; font-family: var(--font-mono); padding: var(--space-md);">
                        <i class="fas fa-file-code"></i> Export as JSON
                        <span style="font-size: 0.75rem; opacity: 0.7; margin-left: auto;">Developer friendly</span>
                    </button>
                </div>

                <button class="btn btn-secondary btn-sm" onclick="app.closeModal()" style="margin-top: var(--space-xl); font-family: var(--font-mono);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        `;

        this.showModal(content);
    }


    async applyTemplateToRole(roleId) {
        const templates = templateService.getAllTemplates();

        const html = `
            <h2><i class="fas fa-copy"></i> Apply Template to Role</h2>
            <p>Select a template to apply its settings to this role's PIM policy.</p>

            <div class="template-select-list">
                ${Object.values(templates).map(t => `
                    <div class="template-select-item" onclick="app.executeApplyTemplateToRole('${roleId}', '${t.id}')">
                        <div class="template-icon ${t.color || 'primary'}">
                            <i class="fas ${t.icon}"></i>
                        </div>
                        <div class="template-info">
                            <strong>${this.escapeHtml(t.name)}</strong>
                            <span>${t.settings.activation.maximumDurationHours}h | MFA: ${t.settings.activation.requireMfa ? 'Yes' : 'No'} | Approval: ${t.settings.activation.requireApproval ? 'Yes' : 'No'}</span>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
            </div>
        `;

        this.showModal(html);
    }

    async executeApplyTemplateToRole(roleId, templateId) {
        const template = templateService.getTemplate(templateId);
        if (!template) {
            this.showToast('Template not found', 'error');
            return;
        }

        this.closeModal();
        this.showLoading('Applying template...');

        const result = await graphService.updateRolePolicy(roleId, {
            maximumDurationHours: template.settings.activation.maximumDurationHours,
            requireMfa: template.settings.activation.requireMfa,
            requireJustification: template.settings.activation.requireJustification,
            requireTicketInfo: template.settings.activation.requireTicketInfo,
            requireApproval: template.settings.activation.requireApproval
        });

        this.hideLoading();

        if (result.success) {
            this.showToast('Template applied successfully', 'success');
            // Refresh the policy view
            const roleName = document.querySelector('.policy-editor h2')?.textContent;
            if (roleName) {
                await this.selectRoleForPolicy(roleId, roleName);
            }
        } else {
            this.showToast(result.error, 'error');
        }
    }

    async configureRolePolicy(roleId) {
        // Get role name from cache
        const role = this.cache.roles?.find(r => r.id === roleId);
        const roleName = role?.displayName || 'Unknown Role';

        // Navigate to policies page and select this role
        this.navigateTo('policies');

        // Wait for page to render, then select the role
        setTimeout(() => {
            this.selectRoleForPolicy(roleId, roleName);
        }, 100);
    }

    exportConfig() {
        this.showToast('Export coming soon', 'info');
    }

    handleImport(files) {
        if (files.length > 0) {
            this.showToast(`Selected file: ${files[0].name}`, 'info');
        }
    }

    // ==========================================
    // UI Helpers
    // ==========================================

    showLoading(text = 'Loading...') {
        document.getElementById('loading-text').textContent = text;
        document.getElementById('loading-overlay').classList.remove('hidden');
    }

    hideLoading() {
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${this.escapeHtml(message)}</span>
        `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    showModal(content) {
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('modal-container').classList.remove('hidden');
    }

    closeModal() {
        document.getElementById('modal-container').classList.add('hidden');
    }

    // ==========================================
    // New Feature Pages
    // ==========================================


    toggleTheme() {
        this.isDarkMode = !this.isDarkMode;
        this.applyTheme();
        localStorage.setItem('pimbuddy-theme', this.isDarkMode ? 'dark' : 'light');
    }

    setTheme(theme) {
        this.isDarkMode = theme === 'dark';
        this.applyTheme();
        localStorage.setItem('pimbuddy-theme', theme);
    }

    loadTheme() {
        const saved = localStorage.getItem('pimbuddy-theme');
        this.isDarkMode = saved === 'dark';
        this.applyTheme();
    }

    applyTheme() {
        document.body.classList.toggle('dark-mode', this.isDarkMode);
        const icon = document.querySelector('#theme-toggle i');
        if (icon) {
            icon.className = this.isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
        }
    }

    /**
     * Escape HTML to prevent XSS (delegates to SecurityUtils)
     */
    escapeHtml(text) {
        return SecurityUtils.escapeHtml(text);
    }
}

// Initialize app
const app = new PIMBuddyApp();
window.app = app; // Make available globally for onclick handlers
app.init();
